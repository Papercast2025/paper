<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- @import must be at the very top -->
  <style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;800&display=swap');

  :root{
    --page-w: 1440px;
    --page-h: 2560px;
    --pad: 32px;
    --card-gap: 14px;
    --border: 4px;
    --gray-bg: #d9d9d9;      /* used for Park Status banner and river graph background */
    --ink: #000;
    --subtle: #444;
  }

  html, body {
    margin: 0; padding: 0;
    width: var(--page-w); height: var(--page-h);
    background:#f0f0f0; color: var(--ink);
    font-family: 'Roboto', Arial, sans-serif;
    overflow: hidden;
    -webkit-text-size-adjust:none;
  }

  /* ======= Header ======= */
  #header {
    background:#000; color:#fff;
  }
  #header-inner{
    padding: 10px var(--pad);
    display: grid;
    grid-template-columns: 96px 1fr 96px; /* left = logo, middle = text, right = spacer to keep text centered */
    align-items: center;
  }
  #county-logo{
    width: 72px; height:auto; display:block;
  }
  #header-title{
    text-align:center;
    line-height:1.15;
    font-weight:800;
    font-size: 40px;
  }
  #header-sub{
    text-align:center;
    font-weight:700; /* bold lat/long */
    font-size: 18px;
    margin-top: 2px;
  }

  /* ======= Page container ======= */
  .container{
    padding: var(--pad);
    display:flex; flex-direction:column; gap: var(--card-gap);
  }

  /* ======= Cards ======= */
  .section{
    border: var(--border) solid #000;
    border-radius:8px;
    background:#fff;
    box-sizing:border-box;
    display:flex; flex-direction:column;
  }
  .card-title{
    background:#000; color:#fff;
    font-weight:800; font-size: 28px;
    padding:8px 10px;
  }
  .section-content{ padding: 10px 12px; }

  .card-timestamp{
    font-size: 18px; color:#222;
    text-align:right; padding:0 10px 8px 10px;
  }

  /* ======= Park Status ======= */
  #park-banner{
    background: var(--gray-bg);
    color:#000;                      /* black text on gray */
    text-align:center;
    font-weight:800;
    font-size: 64px;                 /* big, per request */
    padding: 12px 10px;
    border-radius:6px;
    margin: 6px 8px 8px 8px;
  }
  #park-subrow{
    display:flex; justify-content:space-between; align-items:center;
    font-size: 18px; padding: 2px 10px 0 10px;
  }

  /* ======= Alerts ======= */
  #alert-message{
    text-align:center;
    font-weight:700;
    white-space:pre-wrap;
  }

  /* ======= Weather ======= */
  #weather-wrap{
    display:grid;
    grid-template-columns: 1fr 2fr;   /* left third / right two-thirds */
    gap: 14px;
    align-items:center;
  }
  #wx-left{
    display:flex; align-items:center; gap:10px;
  }
  #weather-icon{ width: 96px; height:96px; }
  #tempF{ font-size: 80px; font-weight:800; line-height:1; }
  #tempC{ font-size: 36px; font-weight:800; }

  #wx-right{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 24px;
    align-items:start;
    font-weight:400; /* NOT bolded per request */
  }
  #wx-right div{ font-size: 18px; }
  #wx-source{
    text-align:right; font-size:14px; color:#222; margin-top:6px;
  }

  /* ======= River ======= */
  #river-topline{
    display:flex; gap: 10px; align-items:center; justify-content:center;
    padding-top: 6px;
  }
  #flood-status{
    font-weight:800; font-size:28px; text-transform:uppercase;
  }
  #paddle-pill{
    background:#000; color:#fff; font-weight:800; font-size:20px;
    padding: 6px 10px; border-radius:6px;
    white-space:nowrap;
  }
  #river-graph{
    background: var(--gray-bg);
    margin: 10px auto 0 auto;
    width: 1080px; position:relative;
  }
  #river-stats{
    text-align:center; margin: 10px 0 2px 0;
    font-size: 20px;
  }
  #river-stats strong{ font-weight:800; }

  #usgs-site-info{ text-align:right; font-size: 14px; padding: 0 10px; }

  /* ======= Forecast ======= */
  #forecast-lines{
    text-align:center;
    padding: 6px 10px;
    font-weight:700; /* bold the forecast readings */
  }

  /* ======= AQI ======= */
  #aqi-wrap{
    display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:8px;
  }
  #aqi-class{ font-weight:800; font-size:22px; }
  #aqi-value{ font-weight:800; font-size:22px; }
  #aqi-gauge{ width: 420px; height: 220px; }
  #aqi-guidance{ font-size:18px; text-align:center; max-width: 820px; }
  #aqi-breakdown{ font-size:16px; text-align:center; }
  #aqi-source{ text-align:right; width:100%; font-size:14px; padding: 2px 10px 0 10px; }

  /* ======= Fit logic: priority ======= */
  #header, .container{ width: var(--page-w); }
  </style>
</head>
<body>
  <!-- ======= HEADER ======= -->
  <div id="header">
    <div id="header-inner">
      <img id="county-logo" src="catham-logo.jpg" alt="Chatham County logo" />
      <div>
        <div id="header-title">US 64 Haw River Access, 348 River Access Rd</div>
        <div id="header-sub"><span id="header-lat">35.730995</span> / <span id="header-lon">-79.107109</span></div>
      </div>
      <div><!-- right spacer --></div>
    </div>
  </div>

  <div class="container">
    <!-- ======= PARK STATUS ======= -->
    <div class="section" id="park-card">
      <div class="card-title">Park Status</div>
      <div class="section-content">
        <div id="park-banner">OPEN / ABIERTO</div>
        <div id="park-subrow">
          <div id="park-today">Today: —</div>
          <div id="park-next">Next: —</div>
        </div>
      </div>
      <div class="card-timestamp" id="park-ts">Last updated: —</div>
    </div>

    <!-- ======= ALERTS ======= -->
    <div class="section" id="alerts-section">
      <div class="card-title">Alerts</div>
      <div class="section-content">
        <div id="alert-message">No alerts at this time / Sin alertas en este momento</div>
      </div>
      <div class="card-timestamp" id="alerts-ts">Last updated: —</div>
    </div>

    <!-- ======= WEATHER ======= -->
    <div class="section" id="weather-card">
      <div class="card-title">Current Weather Conditions</div>
      <div class="section-content" id="weather-wrap">
        <div id="wx-left">
          <div id="weather-icon"></div>
          <div>
            <div id="tempF">--°F</div>
            <div id="tempC">--°C</div>
          </div>
        </div>
        <div>
          <div id="wx-right">
            <div>Sunrise: <span id="sunrise">—</span></div>
            <div>Slight Chance Showers And Thunderstorms</div>
            <div>Sunset: <span id="sunset">—</span></div>
            <div>UV Index: <span id="uv">—</span></div>
            <div>Wind: <span id="wind">—</span></div>
            <div>Humidity: <span id="humidity">—</span></div>
            <div>Feels like: <span id="feels">—</span></div>
            <div>Dew point: <span id="dew">—</span></div>
          </div>
          <div id="wx-source">Source: —</div>
        </div>
      </div>
      <div class="card-timestamp" id="weather-ts">Last updated: —</div>
    </div>

    <!-- ======= RIVER ======= -->
    <div class="section" id="river-card">
      <div class="card-title">River Water Level & Flow</div>
      <div class="section-content">
        <div id="river-topline">
          <div id="flood-status">RIVER BELOW FLOOD STAGE</div>
          <div id="paddle-pill">RIVER FLOW TOO LOW TO PADDLE</div>
        </div>
        <div id="river-graph"></div>
        <div id="river-stats">
          <strong id="stage-line">Stage: —</strong> &nbsp;•&nbsp;
          <strong id="flow-line">Discharge: —</strong>
        </div>
        <div id="usgs-site-info">USGS Site #02096960</div>
      </div>
      <div class="card-timestamp" id="river-ts">Last updated: —</div>
    </div>

    <!-- ======= FORECAST ======= -->
    <div class="section" id="forecast-card">
      <div class="card-title">Forecast</div>
      <div class="section-content" id="forecast-lines">
        <div id="fcst1">—</div>
        <div id="fcst2">—</div>
      </div>
      <div class="card-timestamp" id="forecast-ts">Last updated: —</div>
    </div>

    <!-- ======= AQI ======= -->
    <div class="section" id="aqi-card">
      <div class="card-title">Air Quality Index</div>
      <div class="section-content" id="aqi-wrap">
        <div id="aqi-class">—</div>
        <svg id="aqi-gauge" viewBox="0 0 420 220" aria-hidden="true"></svg>
        <div id="aqi-value">AQI: —</div>
        <div id="aqi-guidance">—</div>
        <div id="aqi-breakdown">—</div>
        <div id="aqi-source">Source: —</div>
      </div>
      <div class="card-timestamp" id="aqi-ts">Last updated: —</div>
    </div>
  </div>

<script>
/* ====================== CONFIG ====================== */
const AIRNOW_KEY = '26158E56-5836-46D3-B819-92969016332B';

/* Site coordinates */
let LAT = 35.730995, LON = -79.107109;
document.getElementById('header-lat').textContent = LAT.toFixed(6);
document.getElementById('header-lon').textContent = LON.toFixed(6);

/* Timezone + formatting */
let TIME_ZONE = 'America/New_York';
const fmtDT = d => new Intl.DateTimeFormat('en-US',{dateStyle:'short', timeStyle:'short', timeZone:TIME_ZONE}).format(d);
const fmtShortTime = d => new Intl.DateTimeFormat('en-US',{hour:'numeric', minute:'2-digit', timeZone:TIME_ZONE}).format(d);

/* Park hours – easy to edit.
   Use 24h "HH:MM". These apply daily. */
const PARK_HOURS = { open:"08:00", close:"19:00" };

/* Paddle advisory thresholds (cfs) */
const FLOW_THRESH = { lowMax:200, noviceMax:700, expertMax:1600, closedMin:2500 };

/* ====================== HELPERS ====================== */
function nowLocal(){ return new Date(); }

function parseHHMM(s){
  const [h,m]=s.split(':').map(Number);
  return {h:h||0,m:m||0};
}
function todaySpan(openHHMM, closeHHMM){
  const n = nowLocal();
  const o = parseHHMM(openHHMM), c=parseHHMM(closeHHMM);
  const open = new Date(n); open.setHours(o.h, o.m, 0, 0);
  const close= new Date(n); close.setHours(c.h, c.m, 0, 0);
  /* if close <= open, the park crosses midnight; push close by +1 day */
  if (close <= open) close.setDate(close.getDate()+1);
  return {open, close, now:n};
}
function timeDiffLabel(future){
  const ms = Math.max(0, future - nowLocal());
  const min = Math.round(ms/60000);
  const h = Math.floor(min/60);
  const m = min%60;
  if(h<=0) return `(${m}m left)`;
  return `(${h}h ${m}m left)`;
}

/* Simple weather icon (monochrome) */
function wxIconSVG(text){
  const t = (text||'').toLowerCase();
  if(t.includes('snow')) return `<svg viewBox="0 0 64 64" width="96" height="96"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black"/><g stroke="black" stroke-width="3"><line x1="32" y1="48" x2="32" y2="60"/><line x1="26" y1="54" x2="38" y2="54"/></g></svg>`;
  if(t.includes('rain')||t.includes('showers')||t.includes('thunder')) return `<svg viewBox="0 0 64 64" width="96" height="96"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black"/><g stroke="black" stroke-width="3"><line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/></g></svg>`;
  if(t.includes('cloud')) return `<svg viewBox="0 0 64 64" width="96" height="96"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black"/></svg>`;
  return `<svg viewBox="0 0 64 64" width="96" height="96"><circle cx="22" cy="22" r="10" fill="black"/><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black"/></svg>`;
}

/* Fahrenheit/Celsius helpers */
const fToC = f => (f-32)*5/9;
const cToF = c => c*9/5+32;
function dewPointF(Tf, RH){
  const T = fToC(Tf);
  const R = Math.max(1e-6, Math.min(100,RH))/100;
  const b=17.62, c=243.12;
  const g = Math.log(R) + (b*T)/(c+T);
  const TdC = (c*g)/(b-g);
  return cToF(TdC);
}
function feelsLikeF(T, R, V){
  if(T <= 50 && V >= 3)
    return 35.74 + 0.6215*T - 35.75*Math.pow(V,0.16) + 0.4275*T*Math.pow(V,0.16);
  if(T >= 80 && R >= 40){
    const c1=-42.379,c2=2.04901523,c3=10.14333127,c4=-0.22475541,c5=-0.00683783,
          c6=-0.05481717,c7=0.00122874,c8=0.00085282,c9=-0.00000199;
    let HI = c1+c2*T+c3*R+c4*T*R+c5*T*T+c6*R*R+c7*T*T*R+c8*T*R*R+c9*T*T*R*R;
    if(R<13 && T>=80 && T<=112) HI -= ((13-R)/4)*Math.sqrt((17 - Math.abs(T-95))/17);
    if(R>85 && T>=80 && T<=87)  HI += ((R-85)/10)*((87-T)/5);
    return HI;
  }
  return T;
}

/* ====================== PARK STATUS ====================== */
function updateParkCard(){
  const {open, close, now} = todaySpan(PARK_HOURS.open, PARK_HOURS.close);
  const banner = document.getElementById('park-banner');
  const todayEl= document.getElementById('park-today');
  const nextEl = document.getElementById('park-next');

  const isOpen = now>=open && now<close;
  banner.textContent = isOpen ? 'OPEN / ABIERTO' : 'CLOSED / CERRADO';

  todayEl.textContent = `Today: ${fmtShortTime(open)} — ${fmtShortTime(close)}`;

  if(isOpen){
    nextEl.textContent = `Next: Closes at ${fmtShortTime(close)} ${timeDiffLabel(close)}`;
  }else{
    // figure out the next opening time (today if in the future, else tomorrow)
    let nextOpen = open;
    if(now >= close) { nextOpen = new Date(open); nextOpen.setDate(open.getDate()+1); }
    if(now < open)   { nextOpen = open; }
    nextEl.textContent = `Next: Opens at ${fmtShortTime(nextOpen)} ${timeDiffLabel(nextOpen)}`;
  }

  document.getElementById('park-ts').textContent = 'Last updated: ' + fmtDT(new Date());
}

/* ====================== ALERTS ====================== */
async function fetchAlerts(){
  const msgEl = document.getElementById('alert-message');
  try{
    // Get forecast zone (NWS points)
    const p = await fetch(`https://api.weather.gov/points/${LAT},${LON}`);
    if(!p.ok) throw new Error('points '+p.status);
    const pd = await p.json();
    const zoneUrl = pd?.properties?.forecastZone;
    let text = '';
    if(zoneUrl){
      const zone = zoneUrl.split('/').pop();
      const a = await fetch(`https://api.weather.gov/alerts/active/zone/${zone}`);
      if(a.ok){
        const ad = await a.json();
        if(ad.features && ad.features.length){
          text = ad.features.map(f=>f.properties.headline).join('\n');
        }
      }
    }
    // Fallback to point-based query if needed
    if(!text){
      const b = await fetch(`https://api.weather.gov/alerts/active?point=${LAT},${LON}`);
      if(b.ok){
        const bd = await b.json();
        if(bd.features && bd.features.length){
          text = bd.features.map(f=>f.properties.headline).join('\n');
        }
      }
    }
    msgEl.textContent = text || 'No alerts at this time / Sin alertas en este momento';
  }catch(e){
    console.warn('Alerts fetch issue →', e);
    msgEl.textContent = 'No alerts at this time / Sin alertas en este momento';
  }
  document.getElementById('alerts-ts').textContent = 'Last updated: '+fmtDT(new Date());
}

/* ====================== WEATHER ====================== */
async function fetchWeather(){
  const tsEl = document.getElementById('weather-ts');
  const srcEl= document.getElementById('wx-source');
  const iconEl=document.getElementById('weather-icon');

  function paintWx(data, sourceLabel){
    const { tempF, shortForecast, rh, windStr, uv, sunrise, sunset } = data;
    document.getElementById('tempF').textContent = (Number.isFinite(tempF)?Math.round(tempF):'--')+'°F';
    document.getElementById('tempC').textContent = Number.isFinite(tempF)? (fToC(tempF).toFixed(1)+'°C') : '--°C';
    document.getElementById('sunrise').textContent = sunrise? fmtShortTime(sunrise) : '—';
    document.getElementById('sunset').textContent  = sunset?  fmtShortTime(sunset)  : '—';
    document.getElementById('uv').textContent      = (uv ?? '—');
    document.getElementById('wind').textContent    = windStr || '—';
    document.getElementById('humidity').textContent= Number.isFinite(rh)? (Math.round(rh)+'%') : '—';

    // feels like + dew
    if(Number.isFinite(tempF) && Number.isFinite(rh)){
      const mph = parseFloat((windStr||'').match(/[\d.]+/)?.[0]||'0');
      const fl = feelsLikeF(tempF, rh, mph);
      const dp = dewPointF(tempF, rh);
      document.getElementById('feels').textContent = Math.round(fl)+'°F';
      document.getElementById('dew').textContent   = Math.round(dp)+'°F';
    }else{
      document.getElementById('feels').textContent = '—';
      document.getElementById('dew').textContent   = '—';
    }

    iconEl.innerHTML = wxIconSVG(shortForecast||'');
    srcEl.textContent = 'Source: '+sourceLabel;
    tsEl.textContent  = 'Last updated: '+fmtDT(new Date());
  }

  try{
    // Primary: NWS
    const pt = await fetch(`https://api.weather.gov/points/${LAT},${LON}`);
    if(!pt.ok) throw new Error('points '+pt.status);
    const pd = await pt.json();
    const hourly = pd.properties.forecastHourly;
    const grid   = pd.properties.forecast;

    const [obsRes, gridRes] = await Promise.all([ fetch(hourly), fetch(grid) ]);
    const obs = obsRes.ok ? await obsRes.json() : null;
    const gridD = gridRes.ok ? await gridRes.json() : null;

    let shortForecast = gridD?.properties?.periods?.[0]?.shortForecast || '—';
    let period = obs?.properties?.periods?.[0];

    let tempF = Number(period?.temperature);
    let rh    = Number(period?.relativeHumidity?.value);
    let windStr = period?.windSpeed || '—';

    // UV from Open-Meteo (fast, CORS-friendly)
    let uv = '—';
    try{
      const om = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto`);
      if(om.ok){
        const od = await om.json();
        const t = od?.hourly?.time || [];
        const u = od?.hourly?.uv_index || [];
        if(t.length && u.length){
          // use the last hour <= now
          let idx=t.length-1; const now = new Date();
          for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
          uv = Math.max(0, Math.round(u[idx]));
        }
      }
    }catch{}

    // Sunrise/Sunset (CORS-friendly)
    let sunrise=null, sunset=null;
    try{
      const s = await fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`);
      const j = await s.json();
      if(j.status==='OK'){
        sunrise = new Date(j.results.sunrise);
        sunset  = new Date(j.results.sunset);
      }
    }catch{}

    if(!Number.isFinite(tempF) || !Number.isFinite(rh)){
      // Fallback to Open-Meteo "current"
      const om = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,relative_humidity_2m,wind_speed_10m&hourly=uv_index&timezone=auto`);
      if(om.ok){
        const d = await om.json();
        if(d?.current){
          const cT = d.current.temperature_2m; // °C
          if(Number.isFinite(cT)) tempF = cToF(cT);
          const cRH = d.current.relative_humidity_2m;
          if(Number.isFinite(cRH)) rh = cRH;
          const ws = d.current.wind_speed_10m;
          if(Number.isFinite(ws)) windStr = Math.round(ws)+' km/h';
        }
      }
      paintWx({tempF, shortForecast, rh, windStr, uv, sunrise, sunset}, 'NWS + Open-Meteo (fallback)');
    }else{
      paintWx({tempF, shortForecast, rh, windStr, uv, sunrise, sunset}, 'NWS + Open-Meteo');
    }

    // Forecast lines (bold, centered)
    try{
      const periods = gridD?.properties?.periods || [];
      document.getElementById('fcst1').textContent = periods[0]?.name ? `${periods[0].name}: ${periods[0].shortForecast}` : '—';
      document.getElementById('fcst2').textContent = periods[1]?.name ? `${periods[1].name}: ${periods[1].shortForecast}` : '—';
      document.getElementById('forecast-ts').textContent = 'Last updated: '+fmtDT(new Date());
    }catch{}
  }catch(e){
    console.warn('Weather primary failed →', e);
    // Hard fallback: Open-Meteo only
    try{
      const om = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,relative_humidity_2m,wind_speed_10m&hourly=uv_index&timezone=auto`);
      const d = await om.json();
      const tempF = Number.isFinite(d?.current?.temperature_2m) ? cToF(d.current.temperature_2m) : NaN;
      const rh = d?.current?.relative_humidity_2m ?? NaN;
      const windStr = Number.isFinite(d?.current?.wind_speed_10m) ? Math.round(d.current.wind_speed_10m)+' km/h' : '—';
      let uv = '—';
      const t = d?.hourly?.time||[], u=d?.hourly?.uv_index||[];
      if(t.length && u.length){
        let idx=t.length-1; const now = new Date();
        for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
        uv = Math.max(0, Math.round(u[idx]));
      }
      // sunrise/sunset fallback:
      let sunrise=null, sunset=null;
      try{
        const s = await fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`);
        const j = await s.json();
        if(j.status==='OK'){ sunrise=new Date(j.results.sunrise); sunset=new Date(j.results.sunset); }
      }catch{}
      paintWx({tempF, shortForecast:'', rh, windStr, uv, sunrise, sunset}, 'Open-Meteo (fallback)');
    }catch{}
  }
}

/* ====================== RIVER (USGS) ====================== */
function classifyFlow(cfs, stage, floodStage){
  if(Number.isFinite(stage) && Number.isFinite(floodStage) && stage >= floodStage)
    return {label:'ACCESS CLOSED, STAY OFF THE RIVER!', sev:3};
  if(!Number.isFinite(cfs)) return {label:'—', sev:-1};
  const t = FLOW_THRESH;
  if(cfs < t.lowMax)       return {label:'RIVER FLOW TOO LOW TO PADDLE', sev:0};
  if(cfs <= t.noviceMax)   return {label:'LOW–MODERATE FLOW – BEGINNER/NOVICE', sev:1};
  if(cfs <= t.expertMax)   return {label:'MODERATE–HIGH FLOW – EXPERT ONLY', sev:2};
  if(cfs >= t.closedMin)   return {label:'UNSAFE FLOW – ACCESS CLOSED', sev:3};
  return {label:'EXPERT PADDLERS ONLY', sev:2};
}

function groupBy3h(points){ // [{dateTime, stage}]
  const map = {};
  points.forEach(p=>{
    const d=new Date(p.dateTime);
    const b=new Date(d.getFullYear(), d.getMonth(), d.getDate(), Math.floor(d.getHours()/3)*3);
    const k=b.toISOString();
    (map[k]??=( {sum:0,cnt:0, d:b} )).sum+=p.stage, map[k].cnt++;
  });
  return Object.values(map).map(o=>({dateObj:o.d, stage:o.sum/o.cnt}))
                           .sort((a,b)=>a.dateObj-b.dateObj);
}

function renderRiverGraph(points,flood,lastReadingStr){
  const container=document.getElementById('river-graph');
  container.innerHTML='';
  if(!points.length) return;

  let minStage=Math.min(...points.map(p=>p.stage));
  let maxStage=Math.max(...points.map(p=>p.stage));
  minStage=Math.min(minStage, flood);
  maxStage=Math.max(maxStage, flood, 6);

  const stageRange=(maxStage-minStage)||1;
  const minDate=points[0].dateObj, maxDate=points[points.length-1].dateObj;
  const total=maxDate-minDate;

  const W=1000, H=260, GX=60, GH=180, GW=W-GX-20;
  const NS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('width',W); svg.setAttribute('height',H); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  const scaleX = d => GX + ( (d - minDate)/total ) * GW - 20;
  const scaleY = s => 20 + (GH - ((s-minStage)/stageRange)*GH);

  // Axis labels (Y)
  for(let v=Math.floor(minStage); v<=Math.ceil(maxStage); v+=1){
    const y=scaleY(v);
    const line=document.createElementNS(NS,'line');
    line.setAttribute('x1', GX-5); line.setAttribute('x2', GX);
    line.setAttribute('y1', y); line.setAttribute('y2', y);
    line.setAttribute('stroke','#000'); line.setAttribute('stroke-width','1');
    svg.appendChild(line);

    const txt=document.createElementNS(NS,'text');
    txt.setAttribute('x', GX-10); txt.setAttribute('y', y+4);
    txt.setAttribute('font-size','18'); txt.setAttribute('text-anchor','end'); txt.textContent=v.toFixed(0);
    svg.appendChild(txt);
  }

  // Data path
  const path = points.map((p,i)=> (i?'L':'M')+scaleX(p.dateObj)+','+scaleY(p.stage)).join(' ');
  const dpath=document.createElementNS(NS,'path');
  dpath.setAttribute('d', path);
  dpath.setAttribute('stroke','#000'); dpath.setAttribute('stroke-width','5'); dpath.setAttribute('fill','none');
  svg.appendChild(dpath);

  // Flood line + label
  const fy=scaleY(flood);
  const fl=document.createElementNS(NS,'line');
  fl.setAttribute('x1', GX); fl.setAttribute('x2', GX+GW);
  fl.setAttribute('y1', fy); fl.setAttribute('y2', fy);
  fl.setAttribute('stroke','#000'); fl.setAttribute('stroke-dasharray','6,3'); fl.setAttribute('stroke-width','3');
  svg.appendChild(fl);

  const flab=document.createElementNS(NS,'text');
  flab.setAttribute('x', GX+GW-10); flab.setAttribute('y', fy-8);
  flab.setAttribute('font-size','24'); flab.setAttribute('font-weight','700');
  flab.setAttribute('text-anchor','end'); flab.textContent='Flood Stage';
  svg.appendChild(flab);

  // Last reading tag (black pill)
  const last = points[points.length-1];
  const tx = scaleX(last.dateObj), ty=scaleY(last.stage);
  const tag=document.createElementNS(NS,'text');
  tag.setAttribute('x', tx+160); tag.setAttribute('y', ty+18);
  tag.setAttribute('font-size','22'); tag.setAttribute('font-weight','800');
  tag.setAttribute('fill','#fff'); tag.setAttribute('text-anchor','middle');
  tag.textContent = lastReadingStr;
  const bg=document.createElementNS(NS,'rect'); setTimeout(()=>{
    const bb=tag.getBBox();
    bg.setAttribute('x', bb.x-6); bg.setAttribute('y', bb.y-2);
    bg.setAttribute('width', bb.width+12); bg.setAttribute('height', bb.height+6);
    bg.setAttribute('fill','#000'); svg.insertBefore(bg,tag);
  },0);
  svg.appendChild(tag);

  container.appendChild(svg);
}

async function fetchRiver(){
  const tsEl=document.getElementById('river-ts');
  try{
    const end=new Date(), start=new Date(); start.setDate(end.getDate()-4);
    const fmt=d=>d.toISOString().split('.')[0];
    const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065,00060&startDT=${fmt(start)}&endDT=${fmt(end)}&siteStatus=all`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('USGS '+r.status);
    const j = await r.json();
    const series = j?.value?.timeSeries||[];
    const find = code => series.find(s=> s?.variable?.variableCode?.[0]?.value===code );
    const stageS = find('00065'), flowS=find('00060');

    // floodStage metadata if present
    let floodStage=5.0;
    const props = stageS?.sourceInfo?.siteProperty || flowS?.sourceInfo?.siteProperty || [];
    props.forEach(p=>{ if(p.propertyName==='floodStage'){ const n=parseFloat(p.value); if(Number.isFinite(n)) floodStage=n; } });

    const stageVals = (stageS?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, stage:parseFloat(v.value)})).filter(v=>Number.isFinite(v.stage));
    const flowVals  = (flowS ?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, flow :parseFloat(v.value)})).filter(v=>Number.isFinite(v.flow));

    if(!stageVals.length){
      document.getElementById('stage-line').innerHTML = '<strong>Stage: —</strong>';
      document.getElementById('flow-line').innerHTML  = '<strong>Discharge: —</strong>';
      tsEl.textContent='Last updated: '+fmtDT(new Date());
      return;
    }

    const lastStage = stageVals[stageVals.length-1].stage;
    const lastFlow  = flowVals.length? flowVals[flowVals.length-1].flow : NaN;

    // Top badges
    const floodEl=document.getElementById('flood-status');
    floodEl.textContent = (lastStage >= floodStage) ? 'FLOOD LEVELS UNSAFE, ACCESS CLOSED' : 'RIVER BELOW FLOOD STAGE';

    const classif=classifyFlow(lastFlow, lastStage, floodStage);
    const pill=document.getElementById('paddle-pill');
    pill.textContent = classif.label;

    // Stats under graph (bold)
    document.getElementById('stage-line').innerHTML = `<strong>Stage: ${lastStage.toFixed(2)} ft</strong>`;
    document.getElementById('flow-line').innerHTML  = `<strong>Discharge: ${Number.isFinite(lastFlow)?Math.round(lastFlow)+' cfs':'—'}</strong>`;

    // Graph
    const grouped = groupBy3h(stageVals);
    renderRiverGraph(grouped, floodStage, `${lastStage.toFixed(2)} ft`);

  }catch(e){
    console.warn('River fetch issue →', e);
  }
  tsEl.textContent='Last updated: '+fmtDT(new Date());
}

/* ====================== AQI (Open-Meteo fallback + AirNow primary) ====================== */
function aqiCategory(v){
  if(v<=50) return 'GOOD';
  if(v<=100) return 'MODERATE';
  if(v<=150) return 'UNHEALTHY FOR SENSITIVE GROUPS';
  if(v<=200) return 'UNHEALTHY';
  if(v<=300) return 'VERY UNHEALTHY';
  return 'HAZARDOUS';
}
function aqiGuidance(cat){
  const c = cat.toLowerCase();
  if(c==='good') return 'Air quality is satisfactory; great for outdoor activities.';
  if(c==='moderate') return 'Okay for most; unusually sensitive people may shorten outdoor exertion.';
  if(c.includes('sensitive')) return 'Sensitive groups should reduce prolonged or heavy outdoor exertion.';
  if(c==='unhealthy') return 'Everyone may feel effects; sensitive groups should avoid prolonged exertion.';
  if(c.includes('very')) return 'Health alert: consider limiting outdoor activity; sensitive groups should avoid it.';
  return 'Emergency conditions: everyone should avoid all outdoor exertion.';
}

/* Robust, simple semicircle gauge:
   - Background light arc (gray) from -180° to 0°
   - Foreground filled wedge to proportion of AQI (0–300)
   - Thin outline arc for crispness
*/
function drawAQIGauge(value){
  const svg = document.getElementById('aqi-gauge');
  svg.innerHTML='';
  const NS='http://www.w3.org/2000/svg';
  const W=420, H=220, CX=210, CY=210, R=180;

  function polar(deg){ const rad = (Math.PI/180)*deg; return [CX + R*Math.cos(rad), CY + R*Math.sin(rad)]; }

  // Background arc (light fill)
  const bg = document.createElementNS(NS,'path');
  const [bx1,by1]=polar(-180), [bx2,by2]=polar(0);
  bg.setAttribute('d', `M ${bx1} ${by1} A ${R} ${R} 0 0 1 ${bx2} ${by2}`);
  bg.setAttribute('fill','none'); bg.setAttribute('stroke','#bbb'); bg.setAttribute('stroke-width','14');
  svg.appendChild(bg);

  // Filled wedge to current value
  const v = Math.max(0, Math.min(300, value));
  const ang = -180 + (v/300)*180;
  const [fx,fy]=polar(ang);
  const fill = document.createElementNS(NS,'path');
  // draw as arc stroke (no caps to avoid fat blobs)
  fill.setAttribute('d', `M ${bx1} ${by1} A ${R} ${R} 0 ${v>150?1:0} 1 ${fx} ${fy}`);
  fill.setAttribute('fill','none'); fill.setAttribute('stroke','#777'); fill.setAttribute('stroke-width','14');
  svg.appendChild(fill);

  // Outline arc for crisp edge
  const outline=document.createElementNS(NS,'path');
  outline.setAttribute('d', `M ${bx1} ${by1} A ${R} ${R} 0 0 1 ${bx2} ${by2}`);
  outline.setAttribute('fill','none'); outline.setAttribute('stroke','#000'); outline.setAttribute('stroke-width','3');
  svg.appendChild(outline);

  // Small pointer triangle
  const tipR = R - 6;
  const [tx,ty]=polar(ang);
  const [t1x,t1y]=polar(ang-3), [t2x,t2y]=polar(ang+3);
  const tri=document.createElementNS(NS,'path');
  tri.setAttribute('d', `M ${tx} ${ty} L ${t1x} ${t1y} L ${t2x} ${t2y} Z`);
  tri.setAttribute('fill','#000');
  svg.appendChild(tri);
}

async function fetchAQI(){
  const tsEl=document.getElementById('aqi-ts');
  const clsEl=document.getElementById('aqi-class');
  const valEl=document.getElementById('aqi-value');
  const gEl = document.getElementById('aqi-guidance');
  const brEl=document.getElementById('aqi-breakdown');
  const srcEl=document.getElementById('aqi-source');

  function paint(v, breakdown, source, asOf){
    const cat = aqiCategory(v);
    clsEl.textContent = cat;
    valEl.textContent = 'AQI: '+v;
    gEl.textContent   = aqiGuidance(cat);
    brEl.textContent  = breakdown || '—';
    srcEl.textContent = `Source: ${source} • As of ${fmtDT(asOf)}`;
    drawAQIGauge(v);
    tsEl.textContent  = 'Last updated: '+fmtDT(new Date());
  }

  // Try AirNow first
  try{
    const url=`https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_KEY}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('AirNow '+r.status);
    const data = await r.json();
    const rows = Array.isArray(data)? data.filter(x=> Number.isFinite(Number(x?.AQI)) ) : [];
    if(!rows.length) throw new Error('AirNow empty');
    // prefer PM2.5, then O3, then PM10, else highest
    const pref = ['PM2.5','O3','PM10'];
    const norm = s => { const x=(s||'').toUpperCase().replace(/\s+/g,''); return (x==='PM2.5'||x==='PM25')?'PM2.5':x; };
    rows.sort((a,b)=>{
      const ai=pref.indexOf(norm(a.ParameterName)); const bi=pref.indexOf(norm(b.ParameterName));
      const ap=ai===-1?999:ai, bp=bi===-1?999:bi;
      if(ap!==bp) return ap-bp;
      return (Number(b.AQI)||0)-(Number(a.AQI)||0);
    });
    const best = rows[0];
    const aqi = Math.round(Number(best.AQI));
    const by = {};
    rows.forEach(r=>{ by[norm(r.ParameterName)] = Math.round(Number(r.AQI)); });
    const parts=[];
    if(by['PM2.5']!=null) parts.push(`PM2.5 ${by['PM2.5']}`);
    if(by['PM10'] !=null) parts.push(`PM10 ${by['PM10']}`);
    if(by['O3']   !=null) parts.push(`O₃ ${by['O3']}`);
    paint(aqi, parts.join(' • '), 'AirNow', new Date());
    return;
  }catch(e){
    console.warn('AirNow failed, falling back →', e);
  }

  // Open-Meteo fallback (US AQI)
  try{
    const r = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto`);
    const j = await r.json();
    const t=j?.hourly?.time||[], a=j?.hourly?.us_aqi||[];
    if(!t.length||!a.length) throw new Error('OM empty');
    let idx=t.length-1; const now=new Date();
    for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
    const v = Math.round(Number(a[idx]));
    const p25 = j?.hourly?.pm2_5?.[idx], p10=j?.hourly?.pm10?.[idx], o3=j?.hourly?.ozone?.[idx];
    const fmt=n=> Number.isFinite(n)? Math.round(n) : '—';
    const breakdown=`PM2.5 ${fmt(p25)} µg/m³ • PM10 ${fmt(p10)} µg/m³ • O₃ ${fmt(o3)} µg/m³`;
    paint(v, breakdown, 'Open-Meteo (US AQI)', new Date(t[idx]));
  }catch(e){
    console.warn('Open-Meteo AQI failed →', e);
    clsEl.textContent='—'; valEl.textContent='AQI: —';
    gEl.textContent='—'; brEl.textContent='—'; srcEl.textContent='Source: —';
    tsEl.textContent='Last updated: '+fmtDT(new Date());
  }
}

/* ====================== MASTER REFRESH ====================== */
function refreshAll(){
  updateParkCard();
  fetchAlerts();
  fetchWeather();
  fetchRiver();
  fetchAQI();
}

window.onload = () => {
  refreshAll();
  // Update every 10 min (you can change this on the device if you prefer)
  setInterval(refreshAll, 10*60*1000);
};
</script>
</body>
</html>
