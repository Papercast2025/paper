<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1440, initial-scale=1.0">
  <title>Environmental Snapshot</title>
  <style>
    body {
      background-color: #ffffff;
      color: #000000;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      width: 1440px;
      height: 2560px;
      -webkit-text-size-adjust: none;
    }
    .container {
      padding: 32px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 28px;
    }
    .group-label {
      font-size: 36px;
      font-weight: bold;
      border-bottom: 2px solid black;
      margin-top: 20px;
      padding-bottom: 6px;
    }
    .section {
      border: 2px solid #000;
      padding: 16px;
      border-radius: 8px;
      background-color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section h2 {
      margin-top: 0;
      font-size: 48px;
      background-color: #000;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      flex: 1;
    }
    .section-content {
      flex: 2;
      padding-left: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: right;
    }
    .value {
      font-size: 100px;
      font-weight: bold;
      margin: 10px 0;
    }
    .label {
      font-size: 32px;
      color: #444;
    }
    .timestamp {
      font-size: 28px;
      color: #222;
      margin-top: 40px;
      text-align: center;
    }
    .forecast-day {
      margin-top: 10px;
      font-size: 32px;
      text-align: right;
    }
    .alert {
      border: 2px solid #000;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      font-size: 28px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="group-label">Atmosphere & Air</div>
    <div class="section">
      <h2>Weather</h2>
      <div class="section-content">
        <div class="value" id="weather-temp">--</div>
        <div class="label" id="weather-description">Loading...</div>
        <div class="label" id="weather-wind">--</div>
        <div class="label" id="weather-humidity">--</div>
      </div>
    </div>

    <div class="section">
      <h2>Air Quality Index (AQI)</h2>
      <div class="section-content">
        <div class="value" id="aqi-value">--</div>
        <div class="label" id="aqi-category">Loading...</div>
        <div class="label" id="aqi-pollutant">Primary Pollutant: --</div>
      </div>
    </div>

    <div class="section">
      <h2>UV Index</h2>
      <div class="section-content">
        <div class="value" id="uv-index">--</div>
        <div class="label">High (Wear protection)</div>
      </div>
    </div>

    <div class="group-label">Water</div>
    <div class="section">
      <h2>River & Water Levels</h2>
      <div class="section-content">
        <div class="value" id="river-value">--</div>
        <div class="label" id="river-timestamp">USGS Site #02096960</div>
        <div class="label" id="river-status">--</div>
      </div>
    </div>

    <div class="section">
      <h2>Precipitation (24h)</h2>
      <div class="section-content">
        <div class="value" id="precip-value">--</div>
        <div class="label">Latest total rainfall</div>
      </div>
    </div>

    <div class="section">
      <h2>Rainfall Outlook (Next 3 Days)</h2>
      <div class="section-content" id="rainfall-outlook">
        <div class="forecast-day">Tuesday: --</div>
        <div class="forecast-day">Wednesday: --</div>
        <div class="forecast-day">Thursday: --</div>
      </div>
    </div>

    <div class="group-label">Heat</div>
    <div class="section">
      <h2>Heat Index</h2>
      <div class="section-content">
        <div class="value" id="heat-index">--</div>
        <div class="label">Feels Like</div>
      </div>
    </div>

    <div class="section">
      <h2>Heat Illness Risk</h2>
      <div class="section-content">
        <div class="value" id="heat-risk">--</div>
        <div class="label">Caution advised for outdoor workers and vulnerable groups</div>
        <div class="label">Hydration and shaded rest breaks recommended</div>
        <div class="label">Peak risk period: 12 PM – 5 PM</div>
      </div>
    </div>

    <div class="group-label">Alerts</div>
    <div class="section">
      <h2>Alerts</h2>
      <div class="section-content" id="alerts">
        <div class="label">Loading...</div>
      </div>
    </div>

    
    <div class="timestamp" style="font-size: 24px; text-align: center; margin-top: 20px;">
      For more information, visit <a href="https://www.chathamcountync.gov/" target="_blank">chathamcountync.gov</a>
    </div>
  </div>

  <script>
const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B';
const LAT = 35.7796;
const LON = -78.6382;

function setAQIContent(aqi, category, pollutant, fallback = false) {
  document.getElementById('aqi-value').textContent = aqi;
  document.getElementById('aqi-category').textContent = category + (fallback ? ' (fallback)' : '');
  document.getElementById('aqi-pollutant').textContent = `Primary Pollutant: ${pollutant}`;
}

function fetchAQIData() {
  const url = `https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}`;
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data && data.length > 0) {
        const main = data[0];
        setAQIContent(main.AQI, main.Category.Name, main.ParameterName);
      } else {
        setAQIContent(42, 'Good', 'PM2.5', true);
      }
    })
    .catch(() => setAQIContent(42, 'Good', 'PM2.5', true));
}

function fetchWeatherAndAlerts() {
  fetch(`https://api.weather.gov/points/${LAT},${LON}`)
    .then(res => res.json())
    .then(meta => {
      const forecastUrl = meta.properties.forecast;
      const obsUrl = meta.properties.observationStations;
      const alertUrl = `https://api.weather.gov/alerts/active?point=${LAT},${LON}`;

      fetch(obsUrl)
        .then(res => res.json())
        .then(obsData => {
          const station = obsData.features[0].properties.stationIdentifier;
          return fetch(`https://api.weather.gov/stations/${station}/observations/latest`);
        })
        .then(res => res.json())
        .then(obs => {
          const temp = obs.properties.temperature.value;
          const desc = obs.properties.textDescription;
          const wind = obs.properties.windSpeed.value;
          const humidity = obs.properties.relativeHumidity.value;
          const heat = obs.properties.heatIndex.value;

          document.getElementById('weather-temp').textContent = temp ? `${Math.round(temp * 9/5 + 32)}°F` : '--';
          document.getElementById('weather-description').textContent = desc || '--';
          document.getElementById('weather-wind').textContent = wind ? `Wind: ${Math.round(wind * 0.621371)} mph` : '--';
          document.getElementById('weather-humidity').textContent = humidity ? `Humidity: ${Math.round(humidity)}%` : '--';
          document.getElementById('heat-index').textContent = heat !== null && !isNaN(heat) ? `${Math.round(heat * 9/5 + 32)}°F` : 'N/A';
          document.getElementById('heat-risk').textContent = heat >= 90 ? 'HIGH' : heat >= 80 ? 'Elevated' : 'Low';
        });

      fetch(alertUrl)
        .then(res => res.json())
        .then(alerts => {
          const container = document.getElementById('alerts');
          container.innerHTML = '';
          const important = alerts.features.filter(a => /flood|heat|severe|tornado/i.test(a.properties.event));
          if (important.length) {
            important.forEach(a => {
              const div = document.createElement('div');
              div.className = 'alert';
              div.textContent = a.properties.headline;
              container.appendChild(div);
            });
          } else {
            const div = document.createElement('div');
            div.className = 'label';
            div.textContent = 'No important alerts';
            container.appendChild(div);
          }
        });

      fetch(forecastUrl)
        .then(res => res.json())
        .then(data => {
          const periods = data.properties.periods.slice(0, 3);
          const outlook = document.getElementById('rainfall-outlook');
          outlook.innerHTML = '';
          periods.forEach(p => {
            const div = document.createElement('div');
            div.className = 'forecast-day';
            div.textContent = `${p.name}: ${p.shortForecast} (${p.temperature}°F)`;
            outlook.appendChild(div);
          });
        });
    });
}

function fetchExtraData() {
  fetch(`https://api.weather.gov/points/${LAT},${LON}`)
    .then(res => res.json())
    .then(meta => {
      const gridId = meta.properties.gridId;
      const gridX = meta.properties.gridX;
      const gridY = meta.properties.gridY;

      fetch(`https://api.weather.gov/gridpoints/${gridId}/${gridX},${gridY}/forecast/hourly`)
        .then(res => res.json())
        .then(data => {
          const text = data.properties.periods[0].shortForecast;
          const uv = text.includes('Sunny') ? 6 : 2;
          document.getElementById('uv-index').textContent = uv;
        });

      fetch(`https://api.weather.gov/gridpoints/${gridId}/${gridX},${gridY}`)
        .then(res => res.json())
        .then(data => {
          const val = data.properties.quantitativePrecipitation?.unitCode === 'wmoUnit:mm' ?
            `${(data.properties.quantitativePrecipitation.value / 25.4).toFixed(2)} in` : '--';
          document.getElementById('precip-value').textContent = val && !isNaN(parseFloat(val)) ? val : 'N/A';
        });
  });

  fetch(`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065&siteStatus=all`)
    .then(res => res.json())
    .then(data => {
      const ts = data.value.timeSeries[0];
      const value = parseFloat(ts.values[0].value[0].value).toFixed(2);
      const time = ts.values[0].value[0].dateTime;
      const flood = 5.0;

      document.getElementById('river-value').textContent = `${value} ft`;
      document.getElementById('river-timestamp').textContent = `USGS Site #02096960 (${new Date(time).toLocaleString()})`;
      document.getElementById('river-status').textContent = value >= flood ? 'AT OR ABOVE FLOOD STAGE' : 'Below flood stage';
      if (value >= flood) {
        const status = document.getElementById('river-status');
        status.style.border = '3px solid black';
        status.style.padding = '6px';
        status.style.fontWeight = 'bold';
      }
    });

  fetch(`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065&siteStatus=all&period=P7D`)
    .then(res => res.json())
    .then(data => {
      const values = data.value.timeSeries[0].values[0].value.map(v => parseFloat(v.value));
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "440");
      svg.setAttribute("height", "100");
      svg.setAttribute("viewBox", "0 0 400 100");

      const min = Math.min(...values);
      const max = Math.max(...values);

      const graphOffsetX = 40;
const graphWidth = 360;

const path = values.map((v, i) => {
  const x = graphOffsetX + (i / (values.length - 1)) * graphWidth;
  const y = 100 - ((v - min) / (max - min)) * 100;
  return `${i === 0 ? 'M' : 'L'}${x},${y}`;
}).join(' ');

      const polyline = document.createElementNS("http://www.w3.org/2000/svg", "path");
      polyline.setAttribute("d", path);
      polyline.setAttribute("stroke", "black");
      polyline.setAttribute("fill", "none");
      polyline.setAttribute("stroke-width", "2");

      const labelMin = document.createElementNS("http://www.w3.org/2000/svg", "text");
labelMin.setAttribute("x", "0");
labelMin.setAttribute("y", "100");
labelMin.setAttribute("font-size", "14");
labelMin.textContent = `${min.toFixed(1)} ft`;

const labelMax = document.createElementNS("http://www.w3.org/2000/svg", "text");
labelMax.setAttribute("x", "0");
labelMax.setAttribute("y", "12");
labelMax.setAttribute("font-size", "14");
labelMax.textContent = `${max.toFixed(1)} ft`;

// Add x-axis day labels
const dayCount = values.length;
for (let i = 0; i < dayCount; i++) {
  const tick = document.createElementNS("http://www.w3.org/2000/svg", "text");
  tick.setAttribute("x", `${graphOffsetX + (i / (dayCount - 1)) * graphWidth}`);
  tick.setAttribute("y", "95");
  tick.setAttribute("font-size", "12");
  tick.setAttribute("text-anchor", "middle");

  const now = new Date();
  now.setDate(now.getDate() - (dayCount - 1 - i));
  const dayLabel = now.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  tick.textContent = dayLabel;
  svg.appendChild(tick);
}

svg.appendChild(labelMin);
svg.appendChild(labelMax);

// Add Y-axis tick marks
[min, max].forEach((val, i) => {
  const y = 100 - ((val - min) / (max - min)) * 100;
  const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
  tick.setAttribute("x1", graphOffsetX);
  tick.setAttribute("x2", graphOffsetX + graphWidth);
  tick.setAttribute("y1", y);
  tick.setAttribute("y2", y);
  tick.setAttribute("stroke", "#ccc");
  tick.setAttribute("stroke-dasharray", "4,4");
  svg.appendChild(tick);
});

// Add flood stage line
const floodLabelY = 100 - ((floodStage - min) / (max - min)) * 100;
const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
line.setAttribute("x1", graphOffsetX);
line.setAttribute("x2", graphOffsetX + graphWidth);
line.setAttribute("y1", floodLabelY);
line.setAttribute("y2", floodLabelY);
line.setAttribute("stroke", "black");
line.setAttribute("stroke-width", "1");
line.setAttribute("stroke-dasharray", "6,3");
svg.appendChild(line);

const floodLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
floodLabel.setAttribute("x", graphOffsetX + 5);
floodLabel.setAttribute("y", floodLabelY - 4);
floodLabel.setAttribute("font-size", "12");
floodLabel.setAttribute("fill", "black");
floodLabel.textContent = "Flood Stage";
svg.appendChild(floodLabel);
}
      document.getElementById("river-status").parentElement.appendChild(svg);
    });
}

window.onload = () => {
  fetchAQIData();
  fetchWeatherAndAlerts();
  fetchExtraData();
  document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
};
</script>
</body>
</html>
