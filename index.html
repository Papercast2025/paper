<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chatham ePaper</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;800&display=swap');

/* ===== Canvas ===== */
html, body{
  margin:0; padding:0;
  width:1440px; height:2560px;   /* fixed ePaper canvas */
  overflow:hidden;
  background:#f0f0f0; color:#000;
  font-family:'Roboto', Arial, sans-serif;
  -webkit-text-size-adjust:none;
}

/* Layout */
#header{background:#000;color:#fff;padding:10px 16px;}
#header-inner{display:flex;align-items:center;gap:12px;}
.header-left,.header-right{width:120px;min-width:120px;}
.header-left img{width:120px;height:auto;display:block;}
.header-title{flex:1;text-align:center;line-height:1.2;}
.header-title .main{font-size:43px;font-weight:800;}
.header-title .coords{font-size:20px;font-weight:700;opacity:.9;}

.container{padding:32px;display:flex;flex-direction:column;gap:14px;}

/* Cards */
.section{border:4px solid #000;border-radius:8px;background:#fff;
  padding:16px;box-sizing:border-box;position:relative;}
.card-title{font-size:36px;font-weight:bold;background:#000;color:#fff;
  padding:4px 8px;margin-bottom:8px;text-align:left;}
.card-timestamp{font-size:24px;color:#222;margin-top:8px;text-align:right;}

.pill-gray{
  display:inline-block;background:#d9d9d9;color:#000;
  padding:4px 8px;border-radius:4px;font-weight:700;
}

/* ===== Access Status ===== */
#status-bar{
  width:100%;background:#d9d9d9;color:#000;
  text-align:center;font-size:80px;font-weight:800;
  padding:10px;border-radius:6px;box-sizing:border-box;
}
#status-today{margin-top:8px;font-size:24px;font-weight:700;text-align:left}

/* ===== Alerts ===== */
#alerts-chips{display:flex;gap:10px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
#alerts-body{white-space:pre-wrap;text-align:center;line-height:1.4;font-size:26px}

/* ===== Weather ===== */
#weather .section-content{display:flex;gap:18px;width:100%;}
#weather-left{flex:0 0 33%;display:flex;align-items:center;gap:12px;}
#wx-icon{width:126px;height:126px;}
#tempF{font-size:100px;font-weight:800;line-height:1}
#tempC{font-size:50px;font-weight:800;line-height:1}
#weather-right{flex:1;display:grid;grid-template-columns:1fr 1fr;column-gap:26px;row-gap:4px;align-content:start}
.weather-line{font-size:28px;font-weight:400;text-align:left}
#weather-source{font-size:18px;text-align:right;margin-top:6px;padding-right:6px;color:#333}

/* ===== River ===== */
.river-header{background:#000;color:#fff;font-size:36px;font-weight:bold;padding:10px 8px;margin-bottom:8px}
#flood-row{text-align:center;margin:6px 0 2px 0}
.river-topline,.river-class{display:inline-block;font-size:32px;font-weight:800;padding:4px 8px;margin:2px 6px;vertical-align:middle}
.river-class{background:#000;color:#fff;border-radius:4px}
#river-graph{background:#d9d9d9;display:block;margin:12px auto 0 auto;position:relative;width:1080px;padding-left:calc(5% - 4px)}
#usgs-site{width:100%;text-align:right;font-size:20px;color:#000;margin-top:2px}
#river-stats{text-align:center;margin-top:12px;font-size:30px;font-weight:bold}

/* ===== Forecast POP ===== */
#pop-title{margin-bottom:8px}
#pop-graph{width:1080px;margin:0 auto}

/* ===== AQI (unchanged visuals) ===== */
#aqi-content{display:flex;flex-direction:column;align-items:center;gap:6px}
#aqi-class{font-size:32px;font-weight:800}
#aqi-meas{font-size:30px;font-weight:800}
#aqi-extra{margin-top:6px;text-align:center}
#aqi-guidance{font-size:26px;color:#222;font-weight:600}
#aqi-breakdown{font-size:22px;color:#222}
#aqi-source{font-size:18px;color:#444}

/* ===== Footer disclaimer (always visible) ===== */
#footer{
  position:absolute;left:50%;transform:translateX(-50%);
  bottom:6px;width:100%;text-align:center;
  font-size:18px;color:#333;pointer-events:none;
}
</style>
</head>
<body>
  <!-- Header -->
  <div id="header">
    <div id="header-inner">
      <div class="header-left">
        <img src="agency-logo.jpg" alt="Agency Logo" onerror="this.style.display='none'">
      </div>
      <div class="header-title">
        <div class="main" id="site-name">US 64 Haw River Access, 348 River Access Rd</div>
        <div class="coords">(<span id="coord-lat">35.730995</span> / <span id="coord-lon">-79.107109</span>)</div>
      </div>
      <div class="header-right" aria-hidden="true"></div>
    </div>
  </div>

  <div class="container">
    <!-- Access Status -->
    <div class="section" id="access">
      <div class="card-title">Access Status</div>
      <div id="status-bar">OPEN / ABIERTO</div>
      <div id="status-today">Today: —</div>
      <div class="card-timestamp" id="access-ts">Last updated: --</div>
    </div>

    <!-- Alerts -->
    <div class="section" id="alerts">
      <div class="card-title">Alerts</div>
      <div id="alerts-chips"></div>
      <div id="alerts-body">No alerts at this time / Sin alertas en este momento</div>
      <div class="card-timestamp" id="alerts-ts">Last updated: --</div>
    </div>

    <!-- Current Weather -->
    <div class="section" id="weather">
      <div class="card-title">Current Weather Conditions</div>
      <div class="section-content">
        <div id="weather-left">
          <div id="wx-icon" aria-hidden="true"></div>
          <div>
            <div id="tempF">--°F</div>
            <div id="tempC">--°C</div>
          </div>
        </div>
        <div id="weather-right">
          <div class="weather-line" id="sunrise">Sunrise: --</div>
          <div class="weather-line" id="wx-forecast">--</div>

          <div class="weather-line" id="sunset">Sunset: --</div>
          <div class="weather-line" id="uv">UV Index: --</div>

          <div class="weather-line" id="wind">Wind: --</div>
          <div class="weather-line" id="humidity">Humidity: --%</div>

          <div class="weather-line" id="feels">Feels like: --°F</div>
          <div class="weather-line" id="dew">Dew point: --°F</div>
        </div>
      </div>
      <div id="weather-source">Source: —</div>
      <div class="card-timestamp" id="weather-ts">Last updated: --</div>
    </div>

    <!-- River -->
    <div class="section" id="river">
      <div class="river-header">River Water Level & Flow</div>
      <div id="flood-row">
        <span class="river-topline" id="flood-status">RIVER BELOW FLOOD STAGE</span>
        <span class="river-class" id="paddle-class">—</span>
      </div>
      <div id="river-graph"></div>
      <div id="river-stats">
        <span id="stage-line"><strong>Stage:</strong> —</span>
        &nbsp;•&nbsp;
        <span id="flow-line"><strong>Discharge:</strong> —</span>
      </div>
      <div id="usgs-site">USGS Site #02096960</div>
      <div class="card-timestamp" id="river-ts">Last updated: --</div>
    </div>

    <!-- Forecast: POP next 24h -->
    <div class="section" id="forecast">
      <div class="card-title">Forecast</div>
      <div id="pop-title" class="pill-gray">Probability of precipitation — next 24 hours</div>
      <div id="pop-graph"></div>
      <div class="card-timestamp" id="forecast-ts">Last updated: --</div>
    </div>

    <!-- AQI (kept for completeness; remove if you don’t need it) -->
    <div class="section" id="aqi">
      <div class="card-title">Air Quality Index</div>
      <div id="aqi-content">
        <div id="aqi-class">--</div>
        <div id="aqi-gauge"></div>
        <div id="aqi-meas">AQI: --</div>
      </div>
      <div id="aqi-extra">
        <div id="aqi-guidance">—</div>
        <div id="aqi-breakdown">—</div>
        <div id="aqi-source">Source: —</div>
      </div>
      <div class="card-timestamp" id="aqi-ts">Last updated: --</div>
    </div>
  </div>

  <!-- Footer disclaimer (always visible) -->
  <div id="footer">
    “This information is provided for public safety. Chatham County assumes no liability for risks associated with trail and river use.”
  </div>

<script>
/* ===================== CONFIG ===================== */
let LAT = 35.730995, LON = -79.107109;
document.getElementById('coord-lat').textContent = LAT;
document.getElementById('coord-lon').textContent = LON;

const TIME_ZONE = 'America/New_York';
const fmtDT = (d=new Date()) => new Intl.DateTimeFormat('en-US',{dateStyle:'short',timeStyle:'short',timeZone:TIME_ZONE}).format(d);
const fmtHM = d => new Intl.DateTimeFormat('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:TIME_ZONE}).format(d);

const PARK_HOURS = {0:{open:"08:00",close:"19:00"},1:{open:"08:00",close:"19:00"},2:{open:"08:00",close:"19:00"},
  3:{open:"08:00",close:"19:00"},4:{open:"08:00",close:"19:00"},5:{open:"08:00",close:"19:00"},6:{open:"08:00",close:"19:00"}};

const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B'; // used if available
let floodThreshold = 5.0;
let LAST_AQI = null;

/* ===================== UTIL ===================== */
function setTS(id){ const el = document.getElementById(id); if(el) el.textContent = "Last updated: " + fmtDT(); }
function toLocalTime(hm){ const [H,M]=hm.split(':').map(n=>+n); const d=new Date(); d.setHours(H,M,0,0); return d; }
function getIconSVG(summary=''){
  const s = summary.toLowerCase();
  if(s.includes('sun') || s.includes('clear')) return `
    <svg viewBox="0 0 64 64" width="126" height="126">
      <circle cx="32" cy="32" r="12" fill="black" stroke="black" stroke-width="3"/>
      <g stroke="black" stroke-width="3">
        <line x1="32" y1="4" x2="32" y2="14"/>
        <line x1="32" y1="50" x2="32" y2="60"/>
        <line x1="4" y1="32" x2="14" y2="32"/>
        <line x1="50" y1="32" x2="60" y2="32"/>
        <line x1="12" y1="12" x2="18" y2="18"/>
        <line x1="46" y1="46" x2="52" y2="52"/>
        <line x1="12" y1="52" x2="18" y2="46"/>
        <line x1="46" y1="18" x2="52" y2="12"/>
      </g>
    </svg>`;
  if(s.includes('rain')) return `
    <svg viewBox="0 0 64 64" width="126" height="126">
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/>
      <g stroke="black" stroke-width="3">
        <line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/>
      </g>
    </svg>`;
  if(s.includes('cloud')) return `
    <svg viewBox="0 0 64 64" width="126" height="126">
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/>
    </svg>`;
  return `
    <svg viewBox="0 0 64 64" width="126" height="126">
      <circle cx="22" cy="22" r="10" fill="black" stroke="black" stroke-width="3"/>
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/>
    </svg>`;
}

/* ===================== Access Status ===================== */
function updateAccess(){
  const now=new Date(), dow=now.getDay();
  const hrs=PARK_HOURS[dow]||{open:"08:00",close:"19:00"};
  const o=toLocalTime(hrs.open), c=toLocalTime(hrs.close);
  const isOpen = now>=o && now<c;
  document.getElementById('status-bar').textContent = isOpen ? 'OPEN / ABIERTO' : 'CLOSED / CERRADO';
  document.getElementById('status-today').textContent = `Today: ${fmtHM(o)}–${fmtHM(c)}`;
  setTS('access-ts');
}

/* ===================== Alerts (2-min rotation, clock-pinned) ===================== */
async function fetchAlerts(){
  try{
    const pt = await fetch(`https://api.weather.gov/points/${LAT},${LON}`).then(r=>r.json());
    const zone = pt?.properties?.forecastZone?.split('/').pop();
    if(!zone) throw new Error('no zone');
    const data = await fetch(`https://api.weather.gov/alerts/active/zone/${zone}`).then(r=>r.json());

    const list = Array.isArray(data?.features) ? data.features.map(f=>({
      title: f?.properties?.event || '',
      text:  f?.properties?.description || f?.properties?.headline || ''
    })) : [];

    renderAlerts(list);
  }catch{
    renderAlerts([]);
  }
}

function renderAlerts(items){
  const chips = document.getElementById('alerts-chips');
  const body  = document.getElementById('alerts-body');
  chips.innerHTML='';

  if(!items.length){
    body.textContent='No alerts at this time / Sin alertas en este momento';
    setTS('alerts-ts'); return;
  }

  // 2-minute slot index pinned to clock
  const idx = Math.floor(Date.now()/(2*60*1000)) % items.length;
  const cur = items[idx];

  const chipIdx = document.createElement('span'); chipIdx.className='pill-gray';
  chipIdx.textContent = `Alert ${idx+1} of ${items.length}`;
  const chipTitle = document.createElement('span'); chipTitle.className='pill-gray';
  chipTitle.textContent = cur.title || 'Alert';

  chips.appendChild(chipIdx); chips.appendChild(chipTitle);

  body.textContent = (cur.text||'').trim().replace(/\n{2,}/g,'\n\n'); // keep paragraphs
  setTS('alerts-ts');
}

/* ===================== Weather (NWS + Sun/UV) ===================== */
function parseWindMph(s){ const m=String(s||'').match(/[\d.]+/); return m?+m[0]:0; }
function fToC(f){return (f-32)*5/9}
function cToF(c){return c*9/5+32}
function dewF(tF,rh){ const T=fToC(tF), R=Math.max(1e-6,Math.min(100,rh))/100, b=17.62,c=243.12;
  const g=Math.log(R)+(b*T)/(c+T); return cToF((c*g)/(b-g)); }
function windChillF(T,V){return 35.74+0.6215*T-35.75*Math.pow(V,0.16)+0.4275*T*Math.pow(V,0.16)}
function heatIndexF(T,R){const c1=-42.379,c2=2.04901523,c3=10.14333127,c4=-0.22475541,c5=-0.00683783,c6=-0.05481717,c7=0.00122874,c8=0.00085282,c9=-0.00000199;
  let HI=c1+c2*T+c3*R+c4*T*R+c5*T*T+c6*R*R+c7*T*T*R+c8*T*R*R+c9*T*T*R*R;
  if(R<13&&T>=80&&T<=112)HI-=((13-R)/4)*Math.sqrt((17-Math.abs(T-95))/17);
  if(R>85&&T>=80&&T<=87)HI+=((R-85)/10)*((87-T)/5);
  return HI;}
function feelsF(T,R,V){ if(T<=50 && V>=3) return windChillF(T,V); if(T>=80 && R>=40) return heatIndexF(T,R); return T; }

async function fetchWeather(){
  try{
    const pt=await fetch(`https://api.weather.gov/points/${LAT},${LON}`).then(r=>r.json());
    const hourly=pt.properties.forecastHourly, grid=pt.properties.forecast;
    const rel=pt.properties.relativeLocation?.properties;
    document.getElementById('weather-source').textContent = 'Source: ' + ([rel?.city, rel?.state].filter(Boolean).join(', ') || '—');

    // Now conditions
    const obs=await fetch(hourly).then(r=>r.json());
    const now=obs.properties?.periods?.[0];
    if(now){
      const tF=Number(now.temperature), rh=Number(now?.relativeHumidity?.value);
      const windStr=now.windSpeed||'0 mph', wind=parseWindMph(windStr);
      document.getElementById('tempF').textContent = Number.isFinite(tF)? `${tF}°F` : '--°F';
      document.getElementById('tempC').textContent = Number.isFinite(tF)? `${(fToC(tF)).toFixed(1)}°C` : '--°C';
      document.getElementById('wx-forecast').textContent = now.shortForecast || '—';
      document.getElementById('wind').textContent = `Wind: ${windStr}`;
      document.getElementById('humidity').textContent = `Humidity: ${Number.isFinite(rh)?Math.round(rh):'--'}%`;
      document.getElementById('wx-icon').innerHTML = getIconSVG(now.shortForecast);
      if(Number.isFinite(tF) && Number.isFinite(rh)){
        document.getElementById('feels').textContent = `Feels like: ${Math.round(feelsF(tF,rh,wind))}°F`;
        document.getElementById('dew').textContent   = `Dew point: ${Math.round(dewF(tF,rh))}°F`;
      }else{
        document.getElementById('feels').textContent = `Feels like: —`;
        document.getElementById('dew').textContent   = `Dew point: —`;
      }
    }

    // Grid: sunrise/sunset via sunrise-sunset.org for precision
    fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`)
      .then(r=>r.json()).then(d=>{
        if(d.status==='OK'){
          document.getElementById('sunrise').textContent = 'Sunrise: ' + fmtHM(new Date(d.results.sunrise));
          document.getElementById('sunset').textContent  = 'Sunset: '  + fmtHM(new Date(d.results.sunset));
        }
      });

    // UV (Open-Meteo)
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto&_=${Date.now()}`)
      .then(r=>r.json()).then(d=>{
        const t=d?.hourly?.time||[], u=d?.hourly?.uv_index||[];
        if(t.length && u.length){
          const now=new Date(); let idx=t.length-1;
          for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
          const val=Math.round(u[idx]??0);
          document.getElementById('uv').textContent = `UV Index: ${val}`;
        }
      });

    setTS('weather-ts');
  }catch{
    setTS('weather-ts');
  }
}

/* ===================== River (USGS) ===================== */
function computeTrend(arr, key, small=0.02, absSmall=0.2){
  if(!Array.isArray(arr)||arr.length<2) return {arrow:'→',label:'steady'};
  const last=arr[arr.length-1][key], first=arr[Math.max(0,arr.length-6)][key];
  const diff=last-first, pct=Math.abs(diff)/Math.max(absSmall,Math.abs(first));
  if(Math.abs(diff)<absSmall && pct<small) return {arrow:'→',label:'steady'};
  return diff>0?{arrow:'▲',label:'rising'}:{arrow:'▼',label:'falling'};
}
function renderRiverGraph(points, lastStr){
  const el=document.getElementById('river-graph'); el.innerHTML='';
  if(!points.length) return;
  let min=Math.min(...points.map(p=>p.stage)), max=Math.max(...points.map(p=>p.stage));
  max=Math.max(max,6); min=Math.min(min,floodThreshold); max=Math.max(max,floodThreshold);
  const range=(max-min)||1;
  const minT=points[0].dateObj, maxT=points[points.length-1].dateObj;
  const total=maxT-minT;

  const W=1001,H=280, gH=180, offX=60, gW=W-offX-20, svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H);
  const yLab=document.createElementNS(svgNS,'text'); yLab.setAttribute('x',25); yLab.setAttribute('y',H/2+30);
  yLab.setAttribute('font-size','18'); yLab.setAttribute('font-weight','bold');
  yLab.setAttribute('transform',`rotate(-90 25,${H/2+30})`); yLab.textContent='Water Level (ft)'; svg.appendChild(yLab);
  const sx=d=> offX + ((d-minT)/total)*gW - 20;
  const sy=v=> gH - ((v-min)/range)*gH + 20;

  for(let t=Math.floor(min); t<=Math.ceil(max); t+=1){
    const y=20 + (max-t)/range*gH;
    const tick=document.createElementNS(svgNS,'line'); tick.setAttribute('x1',offX-5); tick.setAttribute('x2',offX);
    tick.setAttribute('y1',y); tick.setAttribute('y2',y); tick.setAttribute('stroke','black'); svg.appendChild(tick);
    const lbl=document.createElementNS(svgNS,'text'); lbl.setAttribute('x',offX-10); lbl.setAttribute('y',y+4);
    lbl.setAttribute('font-size','21'); lbl.setAttribute('text-anchor','end'); lbl.textContent=t; svg.appendChild(lbl);
  }

  const d=points.map((p,i)=> (i?'L':'M') + sx(p.dateObj)+','+sy(p.stage)).join(' ');
  const path=document.createElementNS(svgNS,'path'); path.setAttribute('d',d); path.setAttribute('stroke','black');
  path.setAttribute('fill','none'); path.setAttribute('stroke-width','6.6'); svg.appendChild(path);

  const fy=sy(floodThreshold);
  const fl=document.createElementNS(svgNS,'line'); fl.setAttribute('x1',offX); fl.setAttribute('x2',offX+gW);
  fl.setAttribute('y1',fy); fl.setAttribute('y2',fy); fl.setAttribute('stroke','black'); fl.setAttribute('stroke-dasharray','6,3'); fl.setAttribute('stroke-width','4'); svg.appendChild(fl);
  const ftxt=document.createElementNS(svgNS,'text'); ftxt.setAttribute('x',offX+gW-10); ftxt.setAttribute('y',fy-10);
  ftxt.setAttribute('font-size','32'); ftxt.setAttribute('font-weight','bold'); ftxt.setAttribute('text-anchor','end'); ftxt.textContent='Flood Stage'; svg.appendChild(ftxt);

  points.forEach((p,i)=>{
    const x=sx(p.dateObj), y=sy(p.stage);
    const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',3); c.setAttribute('fill','black'); svg.appendChild(c);
    const day=p.dateObj.toLocaleDateString(undefined,{month:'short',day:'numeric'});
    if(i===0 || points[i-1].dateObj.getDate()!==p.dateObj.getDate()){
      const dl=document.createElementNS(svgNS,'text'); dl.setAttribute('x',x); dl.setAttribute('y',240); dl.setAttribute('font-size','30'); dl.setAttribute('text-anchor','middle'); dl.textContent=day; svg.appendChild(dl);
    }
    if(i===points.length-1){
      const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',x-0.1*gW); t.setAttribute('y',y+45); t.setAttribute('font-size','35'); t.setAttribute('font-weight','bold'); t.setAttribute('fill','white'); t.setAttribute('text-anchor','middle'); t.textContent=' '+lastStr+' ';
      const r=document.createElementNS(svgNS,'rect'); setTimeout(()=>{const b=t.getBBox(); r.setAttribute('x',b.x-5); r.setAttribute('y',b.y); r.setAttribute('width',b.width+10); r.setAttribute('height',b.height); r.setAttribute('fill','black'); svg.insertBefore(r,t);},0);
      svg.appendChild(t);
    }
  });
  el.appendChild(svg);
}

function group3h(arr){
  const m={};
  arr.forEach(pt=>{
    const d=new Date(pt.dateTime); const k=new Date(d.getFullYear(),d.getMonth(),d.getDate(),Math.floor(d.getHours()/3)*3,0,0,0).toISOString();
    (m[k]||(m[k]={dateObj:new Date(k), sum:0, n:0})).sum += pt.stage; m[k].n += 1;
  });
  return Object.values(m).map(o=>({dateObj:o.dateObj, stage:o.sum/o.n})).sort((a,b)=>a.dateObj-b.dateObj);
}

async function fetchRiver(){
  try{
    const end=new Date(), start=new Date(end.getTime()-4*24*3600*1000);
    const iso=d=>d.toISOString().split('.')[0];
    const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065,00060&startDT=${iso(start)}&endDT=${iso(end)}&siteStatus=all`;
    const data=await fetch(url).then(r=>r.json());
    const series=data?.value?.timeSeries||[];
    const s=code=>series.find(x=>x?.variable?.variableCode?.[0]?.value===code);
    const stS=s('00065'), flS=s('00060');

    const siteProps=stS?.sourceInfo?.siteProperty||flS?.sourceInfo?.siteProperty||[];
    siteProps.forEach(p=>{ if(p.propertyName==='floodStage'){ const n=parseFloat(p.value); if(Number.isFinite(n)) floodThreshold=n; } });

    const stVals=(stS?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, stage:parseFloat(v.value)})).filter(p=>Number.isFinite(p.stage));
    const flVals=(flS?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, flow:parseFloat(v.value)})).filter(p=>Number.isFinite(p.flow));

    if(!stVals.length){ document.getElementById('stage-line').innerHTML='<strong>Stage:</strong> —'; document.getElementById('flow-line').innerHTML='<strong>Discharge:</strong> —'; document.getElementById('paddle-class').textContent='—'; return; }

    const lastStage=stVals[stVals.length-1].stage; const lastFlow=flVals.length?flVals[flVals.length-1].flow:NaN;
    const stTrend=computeTrend(stVals,'stage',0.02,0.2); const flTrend=computeTrend(flVals,'flow',0.05,30);

    document.getElementById('stage-line').innerHTML=`<strong>Stage:</strong> ${lastStage.toFixed(2)} ft ${stTrend.arrow} ${stTrend.label}`;
    document.getElementById('flow-line').innerHTML =`<strong>Discharge:</strong> ${Number.isFinite(lastFlow)?Math.round(lastFlow):'—'} cfs ${flTrend.arrow} ${flTrend.label}`;
    document.getElementById('flood-status').textContent = (lastStage>=floodThreshold)?'FLOOD LEVELS UNSAFE, ACCESS CLOSED':'RIVER BELOW FLOOD STAGE';

    // simple flow classification
    let label='—';
    if(Number.isFinite(lastFlow)){
      if(lastFlow<200) label='RIVER FLOW TOO LOW TO PADDLE';
      else if(lastFlow<=700) label='LOW-MODERATE RIVER FLOW - BEGINNER TO NOVICE PADDLERS';
      else if(lastFlow<=1600) label='MODERATE-HIGH RIVER FLOW - EXPERT PADDLERS ONLY';
      else if(lastFlow>=2500) label='UNSAFE RIVER FLOW - ACCESS CLOSED, STAY OFF THE RIVER!';
      else label='EXPERT PADDLERS ONLY';
    }
    const classEl=document.getElementById('paddle-class'); classEl.className='river-class'; classEl.textContent=label;

    const grouped=group3h(stVals);
    renderRiverGraph(grouped, `${lastStage.toFixed(2)} ft`);
    setTS('river-ts');
  }catch{
    setTS('river-ts');
  }
}

/* ===================== POP next 24h ===================== */
async function fetchPOP24(){
  try{
    const pt=await fetch(`https://api.weather.gov/points/${LAT},${LON}`).then(r=>r.json());
    const hourly=pt?.properties?.forecastHourly;
    const data=await fetch(hourly).then(r=>r.json());
    const periods=data?.properties?.periods||[];
    const series=buildNext24POP(periods,new Date());
    renderPOPBars(series);
    setTS('forecast-ts');
  }catch{
    renderPOPBars(Array.from({length:24},(_,i)=>({t:new Date(Date.now()+i*3600000),pop:0})));
    setTS('forecast-ts');
  }
}
function buildNext24POP(periods, now){
  const start=new Date(now); start.setMinutes(0,0,0);  // next top-of-hour display
  const slots=[];
  for(let k=0;k<24;k++){
    const t=new Date(start.getTime()+k*3600000);
    let pop=0;
    for(const p of periods){
      const s=new Date(p.startTime), e=new Date(p.endTime||s.getTime()+3600000);
      if(t>=s && t<e){ const v=p?.probabilityOfPrecipitation?.value; if(Number.isFinite(v)) pop=Math.round(Math.max(0,Math.min(100,v))); break; }
    }
    slots.push({t, pop});
  }
  return slots;
}
function renderPOPBars(slots){
  const host=document.getElementById('pop-graph'); host.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg', W=1080, H=260, PAD=40, innerW=W-2*PAD, innerH=H-2*PAD;
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H); svg.style.background='#d9d9d9';

  // Y ticks
  [0,50,100].forEach(p=>{
    const y=H-PAD-innerH*(p/100);
    const tick=document.createElementNS(svgNS,'line'); tick.setAttribute('x1',PAD-6); tick.setAttribute('x2',PAD);
    tick.setAttribute('y1',y); tick.setAttribute('y2',y); tick.setAttribute('stroke','black'); svg.appendChild(tick);
    const lbl=document.createElementNS(svgNS,'text'); lbl.setAttribute('x',PAD-10); lbl.setAttribute('y',y+5);
    lbl.setAttribute('font-size','18'); lbl.setAttribute('text-anchor','end'); lbl.textContent=p+'%'; svg.appendChild(lbl);
  });
  // X axis
  const xAxis=document.createElementNS(svgNS,'line'); xAxis.setAttribute('x1',PAD); xAxis.setAttribute('y1',H-PAD);
  xAxis.setAttribute('x2',W-PAD); xAxis.setAttribute('y2',H-PAD); xAxis.setAttribute('stroke','black'); svg.appendChild(xAxis);

  const step=innerW/24, barW=step-2;
  slots.forEach((pt,i)=>{
    const x=PAD+i*step+1, h=innerH*(pt.pop/100), y=H-PAD-h;

    const bar=document.createElementNS(svgNS,'rect');
    bar.setAttribute('x',x); bar.setAttribute('y',y); bar.setAttribute('width',barW); bar.setAttribute('height',h); bar.setAttribute('fill','black');
    svg.appendChild(bar);

    // value label
    const val=document.createElementNS(svgNS,'text');
    val.setAttribute('x',x+barW/2); val.setAttribute('y',Math.max(y-4,14));
    val.setAttribute('font-size','16'); val.setAttribute('text-anchor','middle');
    val.textContent = pt.pop;  // raw number to keep labels compact
    svg.appendChild(val);

    // hour labels every 3 hours
    if(i%3===0){
      const tx=document.createElementNS(svgNS,'text');
      tx.setAttribute('x',x+barW/2); tx.setAttribute('y',H-12);
      tx.setAttribute('font-size','18'); tx.setAttribute('text-anchor','middle');
      tx.textContent=pt.t.toLocaleTimeString('en-US',{hour:'numeric',timeZone:TIME_ZONE});
      svg.appendChild(tx);
    }
  });

  host.appendChild(svg);
}

/* ===================== AQI (wedge gauge simplified) ===================== */
function aqiCategory(n){ if(n<=50)return'Good'; if(n<=100)return'Moderate'; if(n<=150)return'Unhealthy for Sensitive Groups'; if(n<=200)return'Unhealthy'; if(n<=300)return'Very Unhealthy'; return'Hazardous'; }
function aqiGuidance(c){ c=String(c).toLowerCase();
  if(c==='good')return'Air quality is satisfactory; great for outdoor activities.';
  if(c==='moderate')return'Okay for most; unusually sensitive people may shorten outdoor exertion.';
  if(c.includes('sensitive'))return'Sensitive groups should reduce prolonged or heavy outdoor exertion.';
  if(c==='unhealthy')return'Everyone may feel effects; sensitive groups should avoid prolonged exertion.';
  if(c.includes('very'))return'Health alert: consider limiting outdoor activity; sensitive groups should avoid it.';
  return'Emergency conditions: everyone should avoid all outdoor exertion.'; }

function aqiGauge(aqi){
  const svgNS='http://www.w3.org/2000/svg', W=360,H=180,cx=W/2,cy=H-6,R=Math.min(W/2-10,H-20);
  const clamped=Math.max(0,Math.min(300,Number(aqi)||0)), phi=(clamped/300)*Math.PI;
  const start=Math.PI, end=Math.PI-phi;
  const polar=t=>[cx+R*Math.cos(t), cy-R*Math.sin(t)];
  const [x0,y0]=polar(start), [x1,y1]=polar(end);
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H);
  const arcBG=document.createElementNS(svgNS,'path'); const bg=`M ${cx-R} ${cy} A ${R} ${R} 0 0 1 ${cx+R} ${cy}`;
  arcBG.setAttribute('d',bg); arcBG.setAttribute('fill','none'); arcBG.setAttribute('stroke','black'); arcBG.setAttribute('stroke-width','6'); svg.appendChild(arcBG);
  if(phi>0.0001){ const d=`M ${cx} ${cy} L ${x0} ${y0} A ${R} ${R} 0 0 1 ${x1} ${y1} Z`;
    const w=document.createElementNS(svgNS,'path'); w.setAttribute('d',d); w.setAttribute('fill','#777'); w.setAttribute('stroke','black'); w.setAttribute('stroke-width','2'); svg.appendChild(w); }
  const arcFG=document.createElementNS(svgNS,'path'); arcFG.setAttribute('d',bg); arcFG.setAttribute('fill','none'); arcFG.setAttribute('stroke','black'); arcFG.setAttribute('stroke-width','6'); svg.appendChild(arcFG);
  return svg;
}

async function fetchAQI(){
  // Try AirNow first; fallback to Open-Meteo
  const airnow=`https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}&_=${Date.now()}`;
  try{
    const r=await fetch(airnow,{headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error('AirNow HTTP '+r.status);
    const arr=await r.json();
    const rows=Array.isArray(arr)?arr.filter(x=>Number.isFinite(+x?.AQI)):[];
    if(!rows.length) throw new Error('AirNow empty');
    rows.sort((a,b)=>(+b.AQI)-(+a.AQI));
    const aqi=Math.round(+rows[0].AQI), cat=rows[0]?.Category?.Name||aqiCategory(aqi);
    LAST_AQI={value:aqi, cat, source:'AirNow', breakdown:''};
  }catch{
    const url=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto&_=${Date.now()}`;
    const d=await fetch(url).then(r=>r.json());
    const t=d?.hourly?.time||[], s=d?.hourly?.us_aqi||[];
    if(t.length && s.length){
      let idx=t.length-1, now=new Date(); for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){idx=i;break;} }
      const val=Math.round(Number(s[idx])); LAST_AQI={value:val, cat:aqiCategory(val), source:'Open-Meteo (US AQI)', breakdown:`PM2.5 ${Math.round(d.hourly.pm2_5[idx])} • PM10 ${Math.round(d.hourly.pm10[idx])} • O₃ ${Math.round(d.hourly.ozone[idx])}`};
    }
  }
  renderAQI();
}
function renderAQI(){
  const g=document.getElementById('aqi-gauge'); g.innerHTML='';
  if(!LAST_AQI){ document.getElementById('aqi-class').textContent='DATA UNAVAILABLE'; document.getElementById('aqi-meas').textContent='AQI: —'; return; }
  document.getElementById('aqi-class').textContent=LAST_AQI.cat.toUpperCase();
  g.appendChild(aqiGauge(LAST_AQI.value));
  document.getElementById('aqi-meas').textContent='AQI: '+LAST_AQI.value;
  document.getElementById('aqi-guidance').textContent=aqiGuidance(LAST_AQI.cat);
  document.getElementById('aqi-breakdown').textContent=LAST_AQI.breakdown||'—';
  document.getElementById('aqi-source').textContent='Source: '+LAST_AQI.source+' • As of '+fmtDT();
  setTS('aqi-ts');
}

/* ===================== Master refresh ===================== */
function refreshAll(){
  updateAccess();
  fetchAlerts();
  fetchWeather();
  fetchRiver();
  fetchPOP24();
  fetchAQI();
}

window.onload = refreshAll;
// Refresh every 2 minutes (matches ePaper update cadence)
setInterval(refreshAll, 2 * 60 * 1000);
</script>
</body>
</html>
