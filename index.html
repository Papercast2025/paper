<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chatham ePaper</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;800&display=swap');

/* ===== Canvas ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 1440px;   /* ePaper canvas */
  height: 2560px;  /* ePaper canvas */
  background: #f0f0f0;
  color: #000;
  font-family: 'Roboto', Arial, sans-serif;
  -webkit-text-size-adjust: none;
  overflow: hidden; /* we manage overflow/rotation ourselves */
}
body { position: relative; }

/* ===== Header ===== */
#header {
  background:#000;
  color:#fff;
  padding:10px 16px;
}
#header-inner {
  display:flex; align-items:center; gap:12px;
}
.header-left, .header-right {
  width:120px; min-width:120px;
}
.header-left img { width:120px; height:auto; display:block; }
.header-title { flex:1; text-align:center; line-height:1.2; }
.header-title .main { font-size:43px; font-weight:800; }
.header-title .coords { font-size:20px; font-weight:700; opacity:.95; }

/* ===== Main stack and sticky footer ===== */
#main {
  height: calc(2560px - 70px); /* room for footer */
  padding: 32px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 14px;
  overflow: hidden; /* we’ll drop optional cards if needed */
}
#footer {
  position: absolute; left:0; right:0; bottom:8px;
  text-align:center; font-size:18px; color:#222;
}

/* ===== Card shell ===== */
.section {
  border:4px solid #000; background:#fff; border-radius:8px;
  padding:16px; box-sizing:border-box; position:relative;
  display:flex; flex-direction:column;
}
.card-title {
  font-size:36px; font-weight:800; background:#000; color:#fff;
  padding:4px 8px; margin-bottom:8px; text-align:left;
}
.card-timestamp { font-size:24px; color:#222; margin-top:6px; text-align:right; }

/* small gray chip (black text on river-gray) */
.chip {
  display:inline-block; padding:4px 8px; border-radius:6px;
  background:#cfcfcf; color:#000; font-weight:700; font-size:22px;
}

/* ===== Access Status ===== */
#access-bar {
  width:100%; box-sizing:border-box;
  background:#cfcfcf; color:#000; text-align:center;
  font-size:80px; font-weight:800; padding:10px 12px; border-radius:6px;
}
#access-subrow {
  margin-top:8px; display:flex; justify-content:space-between; align-items:center;
  font-size:24px; font-weight:600;
}
#today-left { text-align:left; }
#access-updated { text-align:right; font-weight:400; color:#222; }

/* ===== Alerts ===== */
#alerts-wrap { align-items:center; }
#alerts-meta { text-align:center; margin-bottom:10px; }
#alert-body {
  white-space:pre-wrap; text-align:center; line-height:1.35; font-size:26px;
  margin:0 auto; max-width:1100px; word-break:normal;
}

/* ===== Weather ===== */
#weather-section .section-content { display:flex; gap:18px; width:100%; }
#weather-left { flex:0 0 33%; display:flex; align-items:center; gap:12px; }
#weather-icon { width:126px; height:126px; }
#tempF { font-size:100px; font-weight:800; line-height:1; }
#tempC { font-size:50px; font-weight:800; line-height:1; }

#weather-right {
  flex:1; display:grid; grid-template-columns:1fr 1fr;
  column-gap:26px; row-gap:4px; align-content:start;
}
.weather-line { font-size:28px; font-weight:400; text-align:left; }
#weather-source { font-size:18px; text-align:right; color:#333; margin-top:6px; padding-right:6px; }

/* ===== River ===== */
.river-header { background:#000; color:#fff; font-size:36px; font-weight:800; padding:10px 8px; margin-bottom:8px; }
#river-top { text-align:center; margin:6px 0 2px 0; }
.river-topline, .river-banner {
  display:inline-block; font-size:32px; font-weight:800; padding:4px 8px; margin:2px 6px; vertical-align:middle;
}
.river-banner { background:#000; color:#fff; border-radius:4px; }
#river-graph { background:#cfcfcf; margin:12px auto 0 auto; position:relative; width:1080px; padding-left: calc(5% - 4px); }
#river-stats { text-align:center; margin-top:12px; font-size:30px; font-weight:700; }
#usgs-site-info { text-align:right; font-size:20px; color:#000; margin-top:2px; }

/* ===== Forecast (PoP) ===== */
#forecast-chipbar { text-align:center; margin-bottom:6px; }
#pop-graph { background:#cfcfcf; width:1100px; margin:0 auto; }

/* ===== AQI ===== */
#aqi-content { display:flex; flex-direction:column; align-items:center; gap:6px; }
#aqi-class { font-size:32px; font-weight:800; }
#aqi-gauge { margin-top:4px; }
#aqi-value { font-size:30px; font-weight:800; }
#aqi-guidance { font-size:26px; font-weight:600; text-align:center; }
#aqi-breakdown { font-size:22px; color:#222; text-align:center; }
#aqi-source { font-size:18px; color:#444; text-align:right; }

/* ===== Helpers ===== */
.hidden { display:none !important; }
</style>
</head>
<body>

<!-- Header -->
<div id="header">
  <div id="header-inner">
    <div class="header-left">
      <img src="agency-logo.jpg" alt="Agency" onerror="this.style.display='none'">
    </div>
    <div class="header-title">
      <div class="main">US 64 Haw River Access, 348 River Access Rd</div>
      <div class="coords">(<span id="hlat">35.730995</span> / <span id="hlon">-79.107109</span>)</div>
    </div>
    <div class="header-right" aria-hidden="true"></div>
  </div>
</div>

<!-- Main stack -->
<div id="main">

  <!-- Access Status -->
  <div class="section" id="access-section" data-priority="must">
    <div class="card-title">Access Status</div>
    <div id="access-bar">OPEN / ABIERTO</div>
    <div id="access-subrow">
      <div id="today-left">Today: —</div>
      <div id="access-updated">Last updated: --</div>
    </div>
  </div>

  <!-- Alerts -->
  <div class="section" id="alerts-section" data-priority="must">
    <div class="card-title">Alerts</div>
    <div id="alerts-meta">
      <span class="chip" id="alert-index-chip">Alert 1 of 1</span>
      <span class="chip" id="alert-title-chip" style="margin-left:8px;">—</span>
    </div>
    <div id="alert-body">No alerts at this time / Sin alertas en este momento</div>
    <div class="card-timestamp" id="alerts-timestamp">Last updated: --</div>
  </div>

  <!-- Weather -->
  <div class="section" id="weather-section" data-priority="must">
    <div class="card-title">Current Weather Conditions</div>
    <div class="section-content">
      <div id="weather-left">
        <div id="weather-icon" aria-hidden="true"></div>
        <div>
          <div id="tempF">--°F</div>
          <div id="tempC">--°C</div>
        </div>
      </div>
      <div id="weather-right">
        <div class="weather-line" id="sunrise-line">Sunrise: --</div>
        <div class="weather-line" id="forecast-line">--</div>

        <div class="weather-line" id="sunset-line">Sunset: --</div>
        <div class="weather-line" id="uv-line">UV Index: --</div>

        <div class="weather-line" id="wind-line">Wind: --</div>
        <div class="weather-line" id="humidity-line">Humidity: --%</div>

        <div class="weather-line" id="feelslike-line">Feels like: --°F</div>
        <div class="weather-line" id="dewpoint-line">Dew point: --°F</div>
      </div>
    </div>
    <div id="weather-source">Source: —</div>
    <div class="card-timestamp" id="weather-timestamp">Last updated: --</div>
  </div>

  <!-- River -->
  <div class="section" id="river-section" data-priority="must">
    <div class="river-header">River Water Level & Flow</div>
    <div id="river-top">
      <span class="river-topline" id="flood-status">RIVER BELOW FLOOD STAGE</span>
      <span class="river-banner" id="paddle-advisory">—</span>
    </div>
    <div id="river-graph"></div>
    <div id="river-stats">
      <span id="river-stage-line"><strong>Stage:</strong> —</span>
      &nbsp;•&nbsp;
      <span id="river-flow-line"><strong>Discharge:</strong> —</span>
    </div>
    <div id="usgs-site-info">USGS Site #02096960</div>
    <div class="card-timestamp" id="river-timestamp">Last updated: --</div>
  </div>

  <!-- Forecast (PoP next 24h) -->
  <div class="section" id="forecast-section" data-priority="optional">
    <div class="card-title">Forecast</div>
    <div id="forecast-chipbar"><span class="chip">Probability of precipitation — next 24 hours</span></div>
    <div id="pop-graph"></div>
    <div class="card-timestamp" id="forecast-timestamp">Last updated: --</div>
  </div>

  <!-- AQI -->
  <div class="section" id="aqi-section" data-priority="optional">
    <div class="card-title">Air Quality Index</div>
    <div id="aqi-content">
      <div id="aqi-class">--</div>
      <div id="aqi-gauge"></div>
      <div id="aqi-value">AQI: --</div>
    </div>
    <div id="aqi-guidance">—</div>
    <div id="aqi-breakdown">—</div>
    <div id="aqi-source">Source: —</div>
    <div class="card-timestamp" id="aqi-timestamp">Last updated: --</div>
  </div>

</div>

<!-- Sticky footer -->
<div id="footer">“This information is provided for public safety. Chatham County assumes no liability for risks associated with trail and river use.”</div>

<script>
/* ===== Globals & utilities ===== */
let LAT = 35.730995, LON = -79.107109;
document.getElementById('hlat').textContent = LAT;
document.getElementById('hlon').textContent = LON;

const TZ = 'America/New_York';
const fmtDateTime = (d=new Date()) => new Intl.DateTimeFormat('en-US',{dateStyle:'short',timeStyle:'short',timeZone:TZ}).format(d);
const fmtTime = d => new Intl.DateTimeFormat('en-US',{hour:'numeric',minute:'numeric',timeZone:TZ}).format(d);
const nowStr = () => "Last updated: " + fmtDateTime();

const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B';

/* ===== Access status ===== */
const PARK_HOURS = { 0:{open:"08:00",close:"19:00"},1:{open:"08:00",close:"19:00"},2:{open:"08:00",close:"19:00"},
  3:{open:"08:00",close:"19:00"},4:{open:"08:00",close:"19:00"},5:{open:"08:00",close:"19:00"},6:{open:"08:00",close:"19:00"} };

function toLocalToday(hhmm){
  const [H,M]=hhmm.split(':').map(n=>parseInt(n,10));
  const d=new Date(); d.setHours(H,M,0,0); return d;
}
function updateAccess(){
  const now=new Date(); const dow=now.getDay(); const hrs=PARK_HOURS[dow];
  const open=toLocalToday(hrs.open), close=toLocalToday(hrs.close);
  const isOpen = now>=open && now<close;

  const bar=document.getElementById('access-bar');
  bar.textContent = (isOpen?'OPEN / ABIERTO':'CLOSED / CERRADO');

  const fmtHM=d=>new Intl.DateTimeFormat('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:TZ}).format(d);
  document.getElementById('today-left').textContent = `Today: ${fmtHM(open)}–${fmtHM(close)}`;
  document.getElementById('access-updated').textContent = nowStr();
}

/* ===== Alerts (NWS) with 2-minute rotation ===== */
function rotationIndex(n, periodMs=120000){
  if (!n) return 0;
  const t = Date.now();
  return Math.floor(t/periodMs) % n;
}
async function fetchAlerts(){
  // Use NWS zone via point lookup
  try{
    const point = await (await fetch(`https://api.weather.gov/points/${LAT},${LON}`)).json();
    const zone = point?.properties?.forecastZone;
    if(!zone) throw new Error('No zone');
    const zoneId = zone.split('/').pop();
    const res = await fetch(`https://api.weather.gov/alerts/active/zone/${zoneId}`, {headers:{'Accept':'application/geo+json'}});
    const data = await res.json();
    const features = Array.isArray(data.features)?data.features:[];
    renderAlerts(features);
  }catch(e){
    renderAlerts([]);
  }
}
function renderAlerts(features){
  const body = document.getElementById('alert-body');
  const idxChip = document.getElementById('alert-index-chip');
  const titleChip = document.getElementById('alert-title-chip');
  if(!features.length){
    idxChip.textContent = 'Alert 0 of 0';
    titleChip.textContent = '—';
    body.textContent = 'No alerts at this time / Sin alertas en este momento';
  }else{
    const i = rotationIndex(features.length, 120000);
    const a = features[i];
    const title = a?.properties?.event || 'Alert';
    const desc = (a?.properties?.description || a?.properties?.headline || '').trim() || '(no description)';
    idxChip.textContent = `Alert ${i+1} of ${features.length}`;
    titleChip.textContent = title;
    body.textContent = desc;
  }
  document.getElementById('alerts-timestamp').textContent = nowStr();
}

/* ===== Weather (NWS + Open-Meteo UV) ===== */
function getIconSVG(text){
  const t=(text||'').toLowerCase();
  if (t.includes('sunny')||t.includes('clear')) {
    return `<svg width="126" height="126" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="12" fill="black" stroke="black" stroke-width="3"/>
      <g stroke="black" stroke-width="3">
        <line x1="32" y1="4" x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="60"/>
        <line x1="4" y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="60" y2="32"/>
        <line x1="12" y1="12" x2="18" y2="18"/><line x1="46" y1="46" x2="52" y2="52"/>
        <line x1="12" y1="52" x2="18" y2="46"/><line x1="46" y1="18" x2="52" y2="12"/>
      </g></svg>`;
  } else if (t.includes('cloud')) {
    return `<svg width="126" height="126" viewBox="0 0 64 64">
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z"
       fill="black" stroke="black" stroke-width="3"/></svg>`;
  } else if (t.includes('rain')) {
    return `<svg width="126" height="126" viewBox="0 0 64 64">
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z"
       fill="black" stroke="black" stroke-width="3"/>
      <g stroke="black" stroke-width="3"><line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/></g>
    </svg>`;
  }
  return `<svg width="126" height="126" viewBox="0 0 64 64">
    <circle cx="22" cy="22" r="10" fill="black" stroke="black" stroke-width="3"/>
    <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z"
     fill="black" stroke="black" stroke-width="3"/></svg>`;
}
function f2c(f){ return (f-32)*5/9; }
function dewPointF(Tf, RH){
  const T=f2c(Tf), R=Math.max(1e-6,Math.min(100,RH))/100, b=17.62, c=243.12;
  const g=Math.log(R)+(b*T)/(c+T); return (c*g)/(b-g)*9/5+32;
}
function windChillF(T,V){ return 35.74 + 0.6215*T - 35.75*Math.pow(V,0.16) + 0.4275*T*Math.pow(V,0.16); }
function heatIndexF(T,R){ const c1=-42.379,c2=2.04901523,c3=10.14333127,c4=-0.22475541,c5=-0.00683783,c6=-0.05481717,c7=0.00122874,c8=0.00085282,c9=-0.00000199; let HI=c1+c2*T+c3*R+c4*T*R+c5*T*T+c6*R*R+c7*T*T*R+c8*T*R*R+c9*T*T*R*R; if(R<13&&T>=80&&T<=112)HI-=((13-R)/4)*Math.sqrt((17-Math.abs(T-95))/17); if(R>85&&T>=80&&T<=87)HI+=((R-85)/10)*((87-T)/5); return HI; }
function feelsLikeF(T,R,V){ if(T<=50 && V>=3) return windChillF(T,V); if(T>=80 && R>=40) return heatIndexF(T,R); return T; }

let hourlyPeriodsCache = null;

async function fetchWeather(){
  try{
    const point = await (await fetch(`https://api.weather.gov/points/${LAT},${LON}`)).json();
    const hourlyURL = point.properties.forecastHourly;
    const gridURL   = point.properties.forecast;
    const loc = point.properties.relativeLocation?.properties;
    const city=loc?.city||'', state=loc?.state||'';
    document.getElementById('weather-source').textContent = (city||state) ? `Source: ${city}${city&&state?', ':''}${state}` : 'Source: —';

    // Hourly now (+ cache for PoP)
    const hourly = await (await fetch(hourlyURL)).json();
    const periods = hourly?.properties?.periods || [];
    hourlyPeriodsCache = periods;

    const now = periods[0];
    if (now){
      const tF = Number(now.temperature);
      const tC = Number.isFinite(tF) ? (f2c(tF)).toFixed(1) : '--';
      const rh = now.relativeHumidity?.value ?? NaN;
      const windStr = now.windSpeed || '0 mph';
      const windMph = Number(windStr.match(/[\d.]+/)?.[0] || 0);

      document.getElementById('tempF').textContent = `${Number.isFinite(tF)?tF:'--'}°F`;
      document.getElementById('tempC').textContent = `${Number.isFinite(tF)?tC:'--'}°C`;
      document.getElementById('forecast-line').textContent = now.shortForecast || '—';
      document.getElementById('wind-line').textContent = `Wind: ${windStr}`;
      document.getElementById('humidity-line').textContent = `Humidity: ${Number.isFinite(rh)?Math.round(rh):'--'}%`;
      document.getElementById('weather-icon').innerHTML = getIconSVG(now.shortForecast);

      if(Number.isFinite(tF) && Number.isFinite(rh)){
        const feels = Math.round(feelsLikeF(tF, rh, windMph));
        const dew = Math.round(dewPointF(tF, rh));
        document.getElementById('feelslike-line').textContent = `Feels like: ${feels}°F`;
        document.getElementById('dewpoint-line').textContent = `Dew point: ${dew}°F`;
      }
    }

    // Sunrise/sunset
    try{
      const sun = await (await fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`)).json();
      if (sun.status === 'OK'){
        document.getElementById('sunrise-line').textContent = `Sunrise: ${fmtTime(new Date(sun.results.sunrise))}`;
        document.getElementById('sunset-line').textContent  = `Sunset: ${fmtTime(new Date(sun.results.sunset))}`;
      }
    }catch{}

    // UV (Open-Meteo)
    try{
      const om = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto&_=${Date.now()}`)).json();
      const t = om?.hourly?.time||[], u = om?.hourly?.uv_index||[];
      if (t.length && u.length){
        const now = new Date();
        let idx=t.length-1; for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){idx=i;break;} }
        document.getElementById('uv-line').textContent = `UV Index: ${Math.round(u[idx]??0)}`;
      }
    }catch{}

    // Two short forecast lines
    try{
      const grid = await (await fetch(gridURL)).json();
      const p = grid.properties?.periods || [];
      // (kept for possible future use)
    }catch{}

    document.getElementById('weather-timestamp').textContent = nowStr();

  }catch(e){
    document.getElementById('weather-timestamp').textContent = nowStr();
  }
}

/* ===== PoP next 24h (bars) ===== */
function drawPoP24(){
  const host = document.getElementById('pop-graph');
  host.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const W=1100, H=260, padL=60, padR=25, padT=35, padB=60;
  const chartW=W-padL-padR, chartH=H-padT-padB;

  const svg=document.createElementNS(svgNS,'svg');
  svg.setAttribute('width',W); svg.setAttribute('height',H); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  // axes
  const axis = document.createElementNS(svgNS,'g');
  [['0%',H-padB],['50%',padT+chartH/2],['100%',padT]].forEach(([lbl,y])=>{
    const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',8); t.setAttribute('y',y+4); t.setAttribute('font-size','18'); t.textContent=lbl; axis.appendChild(t);
    const l=document.createElementNS(svgNS,'line'); l.setAttribute('x1',padL); l.setAttribute('x2',W-padR); l.setAttribute('y1',y); l.setAttribute('y2',y); l.setAttribute('stroke','#000'); l.setAttribute('stroke-dasharray','2,6'); svg.appendChild(l);
  });
  svg.appendChild(axis);

  // Build 24 values from hourlyPeriodsCache (NWS)
  const vals=[];
  const now=new Date();
  if(Array.isArray(hourlyPeriodsCache) && hourlyPeriodsCache.length){
    // sort ascending by startTime
    const sorted=[...hourlyPeriodsCache].sort((a,b)=> new Date(a.startTime)-new Date(b.startTime));
    for (let p of sorted){
      const t=new Date(p.startTime);
      if (t>=now && vals.length<24){
        const v = Number(p.probabilityOfPrecipitation?.value);
        vals.push(Math.max(0, Math.min(100, isFinite(v)?v:0)));
      }
    }
    // If not enough, keep scanning future elements
    for (let p of sorted){
      if (vals.length>=24) break;
      const t=new Date(p.startTime);
      if (t>now){ const v=Number(p.probabilityOfPrecipitation?.value); vals.push(Math.max(0,Math.min(100,isFinite(v)?v:0))); }
    }
  }
  while (vals.length<24) vals.push(0);

  // bars
  const n=24, barGap=6, barW=(chartW-(n-1)*barGap)/n;
  for (let i=0;i<n;i++){
    const v=vals[i];
    const x=padL + i*(barW+barGap);
    const h= chartH * (v/100);
    const y= padT + (chartH - h);

    const r=document.createElementNS(svgNS,'rect');
    r.setAttribute('x',x); r.setAttribute('y',y);
    r.setAttribute('width',barW); r.setAttribute('height',h);
    r.setAttribute('fill','#000'); svg.appendChild(r);

    // value label
    const tt=document.createElementNS(svgNS,'text');
    tt.setAttribute('x', x+barW/2); tt.setAttribute('y', Math.max(padT+14, y-4));
    tt.setAttribute('text-anchor','middle'); tt.setAttribute('font-size','16');
    tt.textContent = v ? `${v}%` : '';
    svg.appendChild(tt);

    // hour tick (every 3h to reduce clutter)
    const tickH=document.createElementNS(svgNS,'text');
    tickH.setAttribute('x', x+barW/2); tickH.setAttribute('y', H-22);
    tickH.setAttribute('text-anchor','middle'); tickH.setAttribute('font-size','18');
    const hr = new Date(now.getTime() + i*3600000).toLocaleTimeString('en-US',{hour:'numeric',hour12:true,timeZone:TZ});
    if (i%3===0) tickH.textContent = hr.replace(':00','');
    svg.appendChild(tickH);
  }

  // bottom timeline baseline
  const base=document.createElementNS(svgNS,'line');
  base.setAttribute('x1',padL); base.setAttribute('x2',W-padR); base.setAttribute('y1',H-padB); base.setAttribute('y2',H-padB);
  base.setAttribute('stroke','#000'); svg.appendChild(base);

  host.appendChild(svg);
  document.getElementById('forecast-timestamp').textContent = nowStr();
}

/* ===== AQI (AirNow → Open-Meteo fallback) ===== */
function aqiCat(n){ if(n<=50)return"Good"; if(n<=100)return"Moderate"; if(n<=150)return"Unhealthy for Sensitive Groups"; if(n<=200)return"Unhealthy"; if(n<=300)return"Very Unhealthy"; return"Hazardous"; }
function aqiGuide(c){ c=String(c||'').toLowerCase();
  if(c==='good')return'Air quality is satisfactory; great for outdoor activities.';
  if(c==='moderate')return'Okay for most; unusually sensitive people may shorten outdoor exertion.';
  if(c.includes('sensitive'))return'Sensitive groups should reduce prolonged or heavy outdoor exertion.';
  if(c==='unhealthy')return'Everyone may feel effects; sensitive groups should avoid prolonged exertion.';
  if(c.includes('very'))return'Consider limiting outdoor activity; sensitive groups should avoid it.';
  return'Emergency conditions: everyone should avoid all outdoor exertion.';
}
function makeAQIGauge(aqi){
  const svgNS='http://www.w3.org/2000/svg';
  const W=460,H=240,cx=W/2,cy=H-6,R=Math.min(W/2-10,H-20);
  const phi=Math.max(0,Math.min(300,Number(aqi)||0))/300*Math.PI; // 0..π
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H);
  const arc=`M ${cx-R} ${cy} A ${R} ${R} 0 0 1 ${cx+R} ${cy}`;
  const bg=document.createElementNS(svgNS,'path'); bg.setAttribute('d',arc); bg.setAttribute('fill','none'); bg.setAttribute('stroke','#000'); bg.setAttribute('stroke-width','6'); svg.appendChild(bg);
  if(phi>1e-4){
    const start=Math.PI, end=Math.PI-phi;
    const x0=cx+R*Math.cos(start), y0=cy-R*Math.sin(start);
    const x1=cx+R*Math.cos(end),   y1=cy-R*Math.sin(end);
    const wedge=document.createElementNS(svgNS,'path');
    wedge.setAttribute('d',`M ${cx} ${cy} L ${x0} ${y0} A ${R} ${R} 0 0 1 ${x1} ${y1} Z`);
    wedge.setAttribute('fill','#777'); wedge.setAttribute('stroke','#000'); wedge.setAttribute('stroke-width','2'); svg.appendChild(wedge);
  }
  const fg=document.createElementNS(svgNS,'path'); fg.setAttribute('d',arc); fg.setAttribute('fill','none'); fg.setAttribute('stroke','#000'); fg.setAttribute('stroke-width','6'); svg.appendChild(fg);
  return svg;
}
async function fetchAQI(){
  const gaugeHost=document.getElementById('aqi-gauge'); gaugeHost.innerHTML='';
  try{
    const url=`https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}&_=${Date.now()}`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const list=await res.json();
    const rows=Array.isArray(list)?list.filter(r=>Number.isFinite(Number(r.AQI))):[];
    if(!rows.length) throw new Error('AirNow empty');
    const best=rows.sort((a,b)=>Number(b.AQI)-Number(a.AQI))[0];
    const aqi=Math.round(Number(best.AQI));
    renderAQI(aqi, `AirNow (${best.ParameterName}${best.ReportingArea?` — ${best.ReportingArea}`:''})`, new Date());
  }catch{
    const om = await (await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto&_=${Date.now()}`)).json();
    const t=om?.hourly?.time||[], a=om?.hourly?.us_aqi||[];
    let idx=t.length-1; const now=new Date(); for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){idx=i;break;} }
    const aqi=Math.round(Number(a[idx]||0));
    const br = `PM2.5 ${Math.round(om.hourly.pm2_5[idx]||0)} µg/m³ • PM10 ${Math.round(om.hourly.pm10[idx]||0)} µg/m³ • O₃ ${Math.round(om.hourly.ozone[idx]||0)} µg/m³`;
    renderAQI(aqi, 'Open-Meteo (US AQI)', new Date(t[idx]), br);
  }
}
function renderAQI(aqi, source, asOf, breakdown){
  const cat=aqiCat(aqi);
  document.getElementById('aqi-class').textContent = cat.toUpperCase();
  const host=document.getElementById('aqi-gauge'); host.innerHTML=''; host.appendChild(makeAQIGauge(aqi));
  document.getElementById('aqi-value').textContent = `AQI: ${aqi}`;
  document.getElementById('aqi-guidance').textContent = aqiGuide(cat);
  if(breakdown) document.getElementById('aqi-breakdown').textContent = breakdown;
  document.getElementById('aqi-source').textContent = `Source: ${source} • As of ${fmtDateTime(asOf||new Date())}`;
  document.getElementById('aqi-timestamp').textContent = nowStr();
}

/* ===== River (USGS) ===== */
let floodThreshold=5.0;
function trend(values, key, flatTol=0.03){
  try{
    if(!Array.isArray(values)||values.length<2) return {arrow:'→',label:'steady'};
    const lastTime=new Date(values[values.length-1].dateTime).getTime();
    const start=lastTime-3*3600*1000;
    let sub=values.filter(v=>new Date(v.dateTime).getTime()>=start);
    if(sub.length<2) sub=values.slice(-6);
    const first=sub[0][key], last=sub[sub.length-1][key], diff=last-first, pct=Math.abs(diff)/Math.max(0.01,first);
    if(Math.abs(diff)<(key==='stage'?0.2:30) && pct<flatTol) return {arrow:'→',label:'steady'};
    return diff>0?{arrow:'▲',label:'rising'}:{arrow:'▼',label:'falling'};
  }catch{return {arrow:'→',label:'steady'};}
}
function classifyFlow(cfs, stage, flood){
  if(Number.isFinite(stage) && Number.isFinite(flood) && stage>=flood) return {label:'ACCESS CLOSED, STAY OFF THE RIVER!', severity:3};
  if(!Number.isFinite(cfs)) return {label:'—', severity:-1};
  if(cfs<200) return {label:'RIVER FLOW TOO LOW TO PADDLE', severity:1};
  if(cfs<=700) return {label:'LOW-MODERATE RIVER FLOW - BEGINNER TO NOVICE PADDLERS', severity:1};
  if(cfs<=1600) return {label:'MODERATE-HIGH RIVER FLOW - EXPERT PADDLERS ONLY', severity:2};
  if(cfs>=2500) return {label:'UNSAFE RIVER FLOW - ACCESS CLOSED, STAY OFF THE RIVER!', severity:3};
  return {label:'EXPERT PADDLERS ONLY', severity:2};
}
function by3h(stageArray){
  const m={}; stageArray.forEach(pt=>{ const d=new Date(pt.dateTime); const k=new Date(d.getFullYear(),d.getMonth(),d.getDate(),Math.floor(d.getHours()/3)*3).toISOString(); (m[k]??={dateObj:new Date(k),sum:0,c:0}).sum+=pt.stage; m[k].c++; });
  return Object.values(m).map(o=>({dateObj:o.dateObj,stage:o.sum/o.c})).sort((a,b)=>a.dateObj-b.dateObj);
}
function renderRiverGraph(data, flood, lastStr){
  const host=document.getElementById('river-graph'); host.innerHTML='';
  if(!data.length) return;
  const svgNS='http://www.w3.org/2000/svg', W=1001, H=280, gH=180, offX=60, gW=W-offX-20;
  let min=Math.min(...data.map(d=>d.stage)), max=Math.max(...data.map(d=>d.stage)); max=Math.max(max,6); min=Math.min(min,flood); max=Math.max(max,flood);
  const range=(max-min)||1, minT=data[0].dateObj, maxT=data[data.length-1].dateObj, span=maxT-minT;
  const sx=d=> offX + ((d-minT)/span)*gW - 20, sy=v=> gH - ((v-min)/range)*gH + 20;

  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  // y ticks + label
  const ylab=document.createElementNS(svgNS,'text'); ylab.setAttribute('x',25); ylab.setAttribute('y',H/2+30); ylab.setAttribute('font-size','18'); ylab.setAttribute('font-weight','bold');
  ylab.setAttribute('transform',`rotate(-90 25,${H/2+30})`); ylab.textContent='Water Level (ft)'; svg.appendChild(ylab);
  for(let v=Math.floor(min); v<=Math.ceil(max); v++){
    const y=sy(v), tl=document.createElementNS(svgNS,'line'); tl.setAttribute('x1',offX-5); tl.setAttribute('x2',offX); tl.setAttribute('y1',y); tl.setAttribute('y2',y); tl.setAttribute('stroke','#000'); svg.appendChild(tl);
    const tt=document.createElementNS(svgNS,'text'); tt.setAttribute('x',offX-10); tt.setAttribute('y',y+4); tt.setAttribute('font-size','21'); tt.setAttribute('text-anchor','end'); tt.textContent=String(v); svg.appendChild(tt);
  }

  // path
  const dStr=data.map((p,i)=> (i?'L':'M')+sx(p.dateObj)+','+sy(p.stage)).join(' ');
  const path=document.createElementNS(svgNS,'path'); path.setAttribute('d',dStr); path.setAttribute('stroke','#000'); path.setAttribute('fill','none'); path.setAttribute('stroke-width','6.6'); svg.appendChild(path);

  // flood line
  const fy=sy(flood), fl=document.createElementNS(svgNS,'line'); fl.setAttribute('x1',offX); fl.setAttribute('x2',offX+gW); fl.setAttribute('y1',fy); fl.setAttribute('y2',fy); fl.setAttribute('stroke','#000'); fl.setAttribute('stroke-dasharray','6,3'); fl.setAttribute('stroke-width','4'); svg.appendChild(fl);
  const flab=document.createElementNS(svgNS,'text'); flab.setAttribute('x',offX+gW-10); flab.setAttribute('y',fy-10); flab.setAttribute('font-size','32'); flab.setAttribute('font-weight','bold'); flab.setAttribute('text-anchor','end'); flab.textContent='Flood Stage'; svg.appendChild(flab);

  // points + day labels + last reading tag
  let lastDay='';
  data.forEach((p,i)=>{
    const x=sx(p.dateObj), y=sy(p.stage);
    const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',3); c.setAttribute('fill','#000'); svg.appendChild(c);
    const day=p.dateObj.toLocaleDateString(undefined,{month:'short',day:'numeric'});
    if(day!==lastDay){ lastDay=day; const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',x); t.setAttribute('y',240); t.setAttribute('font-size','30'); t.setAttribute('text-anchor','middle'); t.textContent=day; svg.appendChild(t); }
    if(i===data.length-1){
      const tag=document.createElementNS(svgNS,'text'); tag.setAttribute('x',x-0.1*gW); tag.setAttribute('y',y+45); tag.setAttribute('font-size','35'); tag.setAttribute('font-weight','bold'); tag.setAttribute('fill','#fff'); tag.setAttribute('text-anchor','middle'); tag.textContent=` ${lastStr} `;
      const rect=document.createElementNS(svgNS,'rect'); setTimeout(()=>{const bb=tag.getBBox(); rect.setAttribute('x',bb.x-5); rect.setAttribute('y',bb.y); rect.setAttribute('width',bb.width+10); rect.setAttribute('height',bb.height); rect.setAttribute('fill','#000'); svg.insertBefore(rect, tag);},0);
      svg.appendChild(tag);
    }
  });

  host.appendChild(svg);
}
async function fetchRiver(){
  try{
    const end=new Date(); const start=new Date(); start.setDate(end.getDate()-4);
    const fmt=d=>d.toISOString().split('.')[0];
    const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065,00060&startDT=${fmt(start)}&endDT=${fmt(end)}&siteStatus=all`;
    const data=await (await fetch(url)).json();
    const series=data?.value?.timeSeries||[];
    const find=c=>series.find(s=>s?.variable?.variableCode?.[0]?.value===c);
    const st=find('00065'), fl=find('00060');
    const props=st?.sourceInfo?.siteProperty || fl?.sourceInfo?.siteProperty || [];
    props.forEach(p=>{ if(p.propertyName==='floodStage'){ const n=parseFloat(p.value); if(isFinite(n)) floodThreshold=n; } });
    const stages=(st?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, stage:parseFloat(v.value)})).filter(v=>isFinite(v.stage));
    const flows=(fl?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, flow:parseFloat(v.value)})).filter(v=>isFinite(v.flow));

    if(!stages.length){
      document.getElementById('flood-status').textContent='No river data available';
      document.getElementById('river-stage-line').innerHTML='<strong>Stage:</strong> —';
      document.getElementById('river-flow-line').innerHTML='<strong>Discharge:</strong> —';
      document.getElementById('paddle-advisory').textContent='—';
      return;
    }

    const lastStage=stages[stages.length-1].stage, lastStageStr=`${lastStage.toFixed(2)} ft`;
    const lastFlow=flows.length?flows[flows.length-1].flow:NaN, lastFlowStr=isFinite(lastFlow)?`${Math.round(lastFlow)} cfs`:'—';

    const stTr=trend(stages,'stage'), flTr=trend(flows,'flow');
    document.getElementById('river-stage-line').innerHTML=`<strong>Stage:</strong> ${lastStageStr} ${stTr.arrow} ${stTr.label}`;
    document.getElementById('river-flow-line').innerHTML=`<strong>Discharge:</strong> ${lastFlowStr} ${flTr.arrow} ${flTr.label}`;

    document.getElementById('flood-status').textContent = lastStage>=floodThreshold ? 'FLOOD LEVELS UNSAFE, ACCESS CLOSED' : 'RIVER BELOW FLOOD STAGE';
    const c=classifyFlow(lastFlow,lastStage,floodThreshold);
    const adv=document.getElementById('paddle-advisory'); adv.textContent=c.label; adv.className='river-banner';

    const grouped=by3h(stages);
    renderRiverGraph(grouped, floodThreshold, lastStageStr);
    document.getElementById('river-timestamp').textContent = nowStr();
  }catch{
    document.getElementById('river-timestamp').textContent = nowStr();
  }
}

/* ===== AQI + Weather + Alerts + Access orchestrator ===== */
function updateAll(){
  updateAccess();
  fetchAlerts();
  fetchWeather().then(drawPoP24);
  fetchRiver();
  fetchAQI();
  // fit after data paints
  setTimeout(enforceFit, 100);
}

/* ===== Fit/Rotation: drop optional cards deterministically ===== */
function enforceFit(){
  const main=document.getElementById('main');
  // First show everything
  for(const id of ['forecast-section','aqi-section']){ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
  // If it still overflows, hide optional starting from a rotation index
  const optionals=['forecast-section','aqi-section'];
  let start = rotationIndex(optionals.length, 120000); // same 2-min cadence
  let i=0;
  while (main.scrollHeight > main.clientHeight && i<optionals.length){
    const idx=(start+i)%optionals.length;
    const el=document.getElementById(optionals[idx]);
    if(el && !el.classList.contains('hidden')) el.classList.add('hidden');
    i++;
  }
}

/* ===== Kickoff & refresh every 10 min (display will poll every 2) ===== */
window.onload = () => updateAll();
setInterval(updateAll, 10*60*1000);
</script>
</body>
</html>
