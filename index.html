<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Chatham River Access Display</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;800&display=swap');

/* ===== Canvas & base ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 1440px;          /* ePaper canvas */
  height: 2560px;         /* ePaper canvas */
  background: #f0f0f0;
  color: #000;
  font-family: 'Roboto', Arial, sans-serif;
  -webkit-text-size-adjust: none;
  overflow: hidden;
}
:root{
  --cardBorder: 4px;
  --graphGray: #d9d9d9;   /* shared gray for graphs & badges */
}
#page {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* ===== Header ===== */
#header {
  background: #000;
  color: #fff;
  padding: 10px 16px;
}
#header-inner{
  display:flex; align-items:center; gap:12px;
}
.header-left, .header-right{
  width:120px; min-width:120px;
}
.header-left img{ width:120px; height:auto; display:block; }
.header-title{ flex:1; text-align:center; line-height:1.2; }
.header-title .main{ font-size:43px; font-weight:800; }
/* Bolder coords per your request */
.header-title .coords{ font-size:20px; font-weight:800; opacity:.95; }

/* ===== Cards area + footer ===== */
#cards-wrap{
  flex:1;
  overflow: hidden; /* no scroll on ePaper; we fit instead */
}
.container{
  padding:32px;
  padding-bottom: 220px; /* reserve space above fixed footer */
  display:flex; flex-direction:column; gap:14px;
  box-sizing:border-box;
}
.section{
  border: var(--cardBorder) solid #000;
  background:#fff;
  border-radius:8px;
  padding:16px;
  position:relative;
  display:flex; flex-direction:column;
}
.card-title{
  font-size:36px; font-weight:800;
  background:#000; color:#fff;
  padding:4px 8px; margin-bottom:8px; text-align:left;
}
.card-timestamp{ font-size:24px; color:#222; margin-top:8px; text-align:right; }

/* ===== Access Status (BAR FIX) ===== */
#access-bar{
  width:100%;
  background: var(--graphGray);
  color:#000;
  text-align:center;
  font-size:80px;           /* lock size */
  font-weight:800;
  line-height:1.1;
  padding:12px 10px;
  border-radius:6px;
  white-space:nowrap;       /* prevent wrapping of OPEN / CLOSED */
}
#access-sub{
  margin-top:8px;
  display:flex; justify-content:flex-start; gap:16px;
  font-size:24px; font-weight:700;
  text-align:left;          /* keep "Today:" left aligned */
}

/* ===== Alerts ===== */
#alerts-badges{
  display:flex; justify-content:center; gap:10px; margin-bottom:12px;
}
.badge-gray{
  background: var(--graphGray);
  color:#000;
  font-weight:700;
  padding:4px 10px;
  border-radius:6px;
  display:inline-block;
  white-space:nowrap;
}
#alert-message{
  text-align:center;
  font-size:26px;
  line-height:1.45;
  padding: 0 22px 4px 22px;  /* breathing room at edges */
  white-space:pre-line;      /* preserve manual wraps */
  word-break: break-word;    /* long lines won't overflow */
}

/* ===== Weather ===== */
#weather-section .section-content{ display:flex; gap:18px; width:100%; }
#weather-left{ flex:0 0 33%; display:flex; align-items:center; gap:12px; }
#weather-icon{ width:126px; height:126px; }
#tempF{ font-size:100px; font-weight:800; line-height:1; }
#tempC{ font-size:50px; font-weight:800; line-height:1; }
#weather-right{
  flex:1; display:grid; grid-template-columns: 1fr 1fr;
  column-gap:26px; row-gap:4px; align-content:start;
}
.weather-line{ font-size:28px; font-weight:400; text-align:left; }
#weather-source{ font-size:18px; text-align:right; color:#333; margin-top:6px; padding-right:6px; }

/* ===== River ===== */
.river-header{ background:#000; color:#fff; font-size:36px; font-weight:800; padding:10px 8px; margin-bottom:8px; }
#river-toprow{ text-align:center; margin:6px 0 2px; }
.river-topline{ display:inline-block; font-size:32px; font-weight:800; padding:4px 8px; margin:2px 6px; vertical-align:middle; }
.river-class{ display:inline-block; background:#000; color:#fff; font-size:32px; font-weight:800; padding:4px 8px; border-radius:4px; vertical-align:middle; }
#river-graph{ background:var(--graphGray); margin:12px auto 0; position:relative; width:1080px; padding-left: calc(5% - 4px); }
#river-stats{ text-align:center; margin-top:12px; font-size:30px; font-weight:700; }
#usgs-site{ width:100%; text-align:right; font-size:20px; color:#000; margin-top:2px; }

/* ===== Forecast (PoP 24h) ===== */
#pop-title-wrap{ display:flex; justify-content:center; margin-bottom:10px; }
#pop-graph{ width:1080px; height:320px; margin:0 auto; background:var(--graphGray); }
.pop-axis-label{ font-size:18px; fill:#000; }
.pop-bar-label{ font-size:18px; fill:#000; text-anchor:middle; }

/* ===== AQI ===== */
#aqi-content{ display:flex; flex-direction:column; align-items:center; gap:6px; }
#aqi-class{ font-size:32px; font-weight:800; }
#aqi-gauge{ margin-top:4px; }
#aqi-value{ font-size:30px; font-weight:800; }
#aqi-extra{ margin-top:6px; text-align:center; }
#aqi-guidance{ font-size:26px; font-weight:600; color:#222; }
#aqi-breakdown{ font-size:22px; color:#222; }
#aqi-source{ font-size:18px; color:#444; text-align:right; }

/* ===== Footer (fixed at bottom) ===== */
#footer{
  position:absolute; left:0; right:0; bottom:8px;
  text-align:center; font-size:18px; color:#111; padding:0 24px;
}
</style>
</head>
<body>
<div id="page">
  <!-- Header -->
  <div id="header">
    <div id="header-inner">
      <div class="header-left">
        <img src="agency-logo.jpg" alt="Agency logo" onerror="this.style.display='none'">
      </div>
      <div class="header-title">
        <div class="main">US 64 Haw River Access, 348 River Access Rd</div>
        <div class="coords">(<span id="lat">35.730995</span> / <span id="lon">-79.107109</span>)</div>
      </div>
      <div class="header-right" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Cards -->
  <div id="cards-wrap">
    <div class="container" id="cards">

      <!-- Access Status -->
      <div class="section" id="access-section" data-required="1">
        <div class="card-title">Access Status</div>
        <div id="access-bar">OPEN / ABIERTO</div>
        <div id="access-sub"><div id="today-hours">Today: —</div></div>
        <div class="card-timestamp" id="access-ts">Last updated: --</div>
      </div>

      <!-- Alerts -->
      <div class="section" id="alerts-section" data-required="1">
        <div class="card-title">Alerts</div>
        <div id="alerts-badges">
          <span class="badge-gray" id="alert-index-pill">Alert 1 of 1</span>
          <span class="badge-gray" id="alert-title-pill">—</span>
        </div>
        <div id="alert-message">No alerts at this time / Sin alertas en este momento</div>
        <div class="card-timestamp" id="alerts-ts">Last updated: --</div>
      </div>

      <!-- Weather -->
      <div class="section" id="weather-section" data-required="1">
        <div class="card-title">Current Weather Conditions</div>
        <div class="section-content">
          <div id="weather-left">
            <div id="weather-icon" aria-hidden="true"></div>
            <div>
              <div id="tempF">--°F</div>
              <div id="tempC">--°C</div>
            </div>
          </div>
          <div id="weather-right">
            <div class="weather-line" id="sunrise-line">Sunrise: --</div>
            <div class="weather-line" id="short-forecast">--</div>

            <div class="weather-line" id="sunset-line">Sunset: --</div>
            <div class="weather-line" id="uv-line">UV Index: --</div>

            <div class="weather-line" id="wind-line">Wind: --</div>
            <div class="weather-line" id="humidity-line">Humidity: --%</div>

            <div class="weather-line" id="feelslike-line">Feels like: --°F</div>
            <div class="weather-line" id="dewpoint-line">Dew point: --°F</div>
          </div>
        </div>
        <div id="weather-source">Source: —</div>
        <div class="card-timestamp" id="weather-ts">Last updated: --</div>
      </div>

      <!-- River -->
      <div class="section" id="river-section" data-required="1">
        <div class="river-header">River Water Level & Flow</div>
        <div id="river-toprow">
          <span class="river-topline" id="flood-status">RIVER BELOW FLOOD STAGE</span>
          <span class="river-class" id="flow-class">—</span>
        </div>
        <div id="river-graph"></div>
        <div id="river-stats">
          <span id="stage-line"><strong>Stage:</strong> —</span>
          &nbsp;•&nbsp;
          <span id="flow-line"><strong>Discharge:</strong> —</span>
        </div>
        <div id="usgs-site">USGS Site #02096960</div>
        <div class="card-timestamp" id="river-ts">Last updated: --</div>
      </div>

      <!-- Forecast (PoP) -->
      <div class="section" id="forecast-section" data-required="0">
        <div class="card-title">Forecast</div>
        <div id="pop-title-wrap">
          <span class="badge-gray">Probability of precipitation — next 24 hours</span>
        </div>
        <div id="pop-graph"></div>
        <div class="card-timestamp" id="forecast-ts">Last updated: --</div>
      </div>

      <!-- AQI -->
      <div class="section" id="aqi-section" data-required="0">
        <div class="card-title">Air Quality Index</div>
        <div id="aqi-content">
          <div id="aqi-class">--</div>
          <div id="aqi-gauge"></div>
          <div id="aqi-value">AQI: --</div>
        </div>
        <div id="aqi-extra">
          <div id="aqi-guidance">—</div>
          <div id="aqi-breakdown">—</div>
          <div id="aqi-source">Source: —</div>
        </div>
        <div class="card-timestamp" id="aqi-ts">Last updated: --</div>
      </div>

    </div>
  </div>

  <!-- Footer (fixed) -->
  <div id="footer">
    “This information is provided for public safety. Chatham County assumes no liability for risks associated with trail and river use.”
  </div>
</div>

<script>
/* ================== Settings & helpers ================== */
const TIME_ZONE = 'America/New_York';
const LAT = 35.730995, LON = -79.107109;
document.getElementById('lat').textContent = LAT;
document.getElementById('lon').textContent = LON;
let floodThreshold = 5.0;

const fmtDT = (d=new Date()) =>
  new Intl.DateTimeFormat('en-US',{dateStyle:'short', timeStyle:'short', timeZone:TIME_ZONE}).format(d);
const fmtHM = d =>
  new Intl.DateTimeFormat('en-US',{hour:'numeric', minute:'2-digit', hour12:true, timeZone:TIME_ZONE}).format(d);

const PARK_HOURS = {0:{open:"08:00",close:"19:00"},1:{open:"08:00",close:"19:00"},2:{open:"08:00",close:"19:00"},
  3:{open:"08:00",close:"19:00"},4:{open:"08:00",close:"19:00"},5:{open:"08:00",close:"19:00"},6:{open:"08:00",close:"19:00"}};

function hhmmToDate(hhmm){
  const [H,M]=hhmm.split(':').map(n=>parseInt(n,10)); const d=new Date();
  d.setHours(H,M,0,0); return d;
}
function minutesUntil(a,b=new Date()){ const ms=a-b; return Math.max(0, Math.round(ms/60000)); }

function updateAccess(){
  const now=new Date(); const dow=now.getDay(); const hrs=PARK_HOURS[dow];
  const open=hhmmToDate(hrs.open), close=hhmmToDate(hrs.close);
  const isOpen = now>=open && now<close;
  const bar=document.getElementById('access-bar');
  bar.textContent = isOpen? 'OPEN / ABIERTO' : 'CLOSED / CERRADO';
  document.getElementById('today-hours').textContent = `Today: ${fmtHM(open)}–${fmtHM(close)}`;
  document.getElementById('access-ts').textContent = 'Last updated: ' + fmtDT();
}

/* ================== Alerts (NWS) ================== */
let latestAlerts = [];
function twoMinuteIndex(max){
  const now=new Date();
  const minutesSinceMidnight = now.getHours()*60 + now.getMinutes();
  return (Math.floor(minutesSinceMidnight/2)) % Math.max(1,max);
}
async function fetchAlerts(){
  try{
    const point = await (await fetch(`https://api.weather.gov/points/${LAT},${LON}`)).json();
    const zoneUrl = point.properties?.forecastZone;
    if(!zoneUrl){ throw new Error('no zone'); }
    const zone = zoneUrl.split('/').pop();
    const data = await (await fetch(`https://api.weather.gov/alerts/active/zone/${zone}`)).json();
    latestAlerts = (data.features||[]).map(f=>{
      const p=f.properties||{};
      return {
        title: (p.event || p.headline || 'Alert').toString(),
        text: (p.description || p.instruction || p.headline || '').toString().trim()
      }
    });
  }catch(e){
    latestAlerts=[];
  }
  renderAlert();
}
function renderAlert(){
  const msgEl = document.getElementById('alert-message');
  const titlePill = document.getElementById('alert-title-pill');
  const idxPill = document.getElementById('alert-index-pill');

  if(!latestAlerts.length){
    titlePill.textContent='—';
    idxPill.textContent='Alert 0 of 0';
    msgEl.textContent='No alerts at this time / Sin alertas en este momento';
  }else{
    const i = twoMinuteIndex(latestAlerts.length);
    const a = latestAlerts[i];
    idxPill.textContent = `Alert ${i+1} of ${latestAlerts.length}`;
    titlePill.textContent = a.title;
    // normalize text for better wrapping
    const clean = a.text.replace(/\r/g,'')
                        .replace(/\n{2,}/g,'\n\n')
                        .replace(/\*\s*/g,'• ')
                        .trim();
    msgEl.textContent = clean || a.title;
  }
  document.getElementById('alerts-ts').textContent='Last updated: '+fmtDT();
}

/* ================== Weather (NWS + Open-Meteo for UV) ================== */
function svgIcon(forecast=''){
  const s = forecast.toLowerCase();
  if(s.includes('sun') || s.includes('clear')){
    return `<svg width="126" height="126" viewBox="0 0 64 64"><circle cx="32" cy="32" r="12" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="32" y1="4" x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="60"/><line x1="4" y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="60" y2="32"/><line x1="12" y1="12" x2="18" y2="18"/><line x1="46" y1="46" x2="52" y2="52"/><line x1="12" y1="52" x2="18" y2="46"/><line x1="46" y1="18" x2="52" y2="12"/></g></svg>`;
  }else if(s.includes('cloud')){
    return `<svg width="126" height="126" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
  }else if(s.includes('rain')||s.includes('shower')){
    return `<svg width="126" height="126" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/></g></svg>`;
  }
  return `<svg width="126" height="126" viewBox="0 0 64 64"><circle cx="22" cy="22" r="10" fill="black" stroke="black" stroke-width="3"/><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
}

function fToC(f){ return (f-32)*5/9; }
function dewPointF(Tf,R){ const T=fToC(Tf), Rf=Math.max(1e-6,Math.min(100,R))/100, b=17.62,c=243.12, g=Math.log(Rf)+(b*T)/(c+T); return (c*g)/(b-g)*9/5+32; }
function windChillF(T,V){ return 35.74+0.6215*T-35.75*Math.pow(V,0.16)+0.4275*T*Math.pow(V,0.16); }
function heatIndexF(T,R){ const c1=-42.379,c2=2.04901523,c3=10.14333127,c4=-0.22475541,c5=-0.00683783,c6=-0.05481717,c7=0.00122874,c8=0.00085282,c9=-0.00000199; let HI=c1+c2*T+c3R+c4*T*R+c5*T*T+c6*R*R+c7*T*T*R+c8*T*R*R+c9*T*T*R*R; if(R<13&&T>=80&&T<=112) HI-=((13-R)/4)*Math.sqrt((17-Math.abs(T-95))/17); if(R>85&&T>=80&&T<=87) HI+=((R-85)/10)*((87-T)/5); return HI; }
function feelsLikeF(T,R,V){ if(T<=50 && V>=3) return windChillF(T,V); if(T>=80 && R>=40) return heatIndexF(T,R); return T; }
function mphFromStr(s){ const m=String(s||'').match(/[\d.]+/); return m?parseFloat(m[0]):0; }

async function fetchWeather(){
  try{
    const point = await (await fetch(`https://api.weather.gov/points/${LAT},${LON}`)).json();
    const hourlyURL = point.properties?.forecastHourly;
    const gridURL   = point.properties?.forecast;
    const rel = point.properties?.relativeLocation?.properties;
    const city=rel?.city||'', state=rel?.state||'';
    document.getElementById('weather-source').textContent = (city||state) ? `Source: ${city}${city&&state?', ':''}${state}` : 'Source: —';

    // Hourly now
    const hourly = await (await fetch(hourlyURL)).json();
    const nowP = hourly.properties?.periods?.[0];
    if(nowP){
      const tempF = Number(nowP.temperature);
      const rhVal = Number(nowP.relativeHumidity?.value);
      const windS = nowP.windSpeed || '0 mph';
      const windV = mphFromStr(windS);
      document.getElementById('tempF').textContent = `${Math.round(tempF)}°F`;
      document.getElementById('tempC').textContent = `${fToC(tempF).toFixed(1)}°C`;
      document.getElementById('short-forecast').textContent = nowP.shortForecast || '—';
      document.getElementById('wind-line').textContent = `Wind: ${windS}`;
      document.getElementById('humidity-line').textContent = `Humidity: ${Number.isFinite(rhVal)?Math.round(rhVal):'—'}%`;
      document.getElementById('weather-icon').innerHTML = svgIcon(nowP.shortForecast || '');

      if(Number.isFinite(tempF) && Number.isFinite(rhVal)){
        const feels = Math.round(feelsLikeF(tempF, rhVal, windV));
        const dew = Math.round(dewPointF(tempF, rhVal));
        document.getElementById('feelslike-line').textContent = `Feels like: ${feels}°F`;
        document.getElementById('dewpoint-line').textContent = `Dew point: ${dew}°F`;
      }
      drawPoP(hourly.properties?.periods || []);
    }

    // Sunrise/sunset
    const rises = await (await fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`)).json();
    if(rises.status==="OK"){
      const sR=new Date(rises.results.sunrise), sS=new Date(rises.results.sunset);
      document.getElementById('sunrise-line').textContent = `Sunrise: ${fmtHM(sR)}`;
      document.getElementById('sunset-line').textContent  = `Sunset: ${fmtHM(sS)}`;
    }

    // UV (Open-Meteo)
    try{
      const uv = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto&_=${Date.now()}`)).json();
      const t=uv?.hourly?.time||[], u=uv?.hourly?.uv_index||[];
      if(t.length && u.length){
        const now=new Date(); let idx=t.length-1; for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
        const val = Math.round(u[idx] ?? 0);
        document.getElementById('uv-line').textContent = `UV Index: ${val}`;
      }
    }catch{}

    document.getElementById('weather-ts').textContent='Last updated: '+fmtDT();

  }catch(e){
    document.getElementById('weather-ts').textContent='Last updated: '+fmtDT();
  }
}

/* ===== PoP bar graph (next 24h from now) ===== */
function drawPoP(periods){
  const container = document.getElementById('pop-graph');
  container.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg';
  const W=1080, H=320, padL=60, padR=30, padT=20, padB=40;
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H);
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  // collect next 24 hourly periods starting now
  const list = [];
  const now = new Date();
  for(const p of (periods||[])){
    const t=new Date(p.startTime||p.startTimeISO||p.validTime?.split('/')[0]||new Date());
    if(t>=now && list.length<24){ 
      const pop = Number(p.probabilityOfPrecipitation?.value ?? p.pop ?? 0) || 0;
      list.push({t, pop: Math.max(0, Math.min(100, Math.round(pop)))});
    }
    if(list.length>=24) break;
  }
  if(!list.length){
    container.textContent='—';
    return;
  }

  const innerW = W-padL-padR, innerH = H-padT-padB;

  // y grid at 0,50,100
  [0,50,100].forEach(v=>{
    const y = padT + innerH - innerH*(v/100);
    const line=document.createElementNS(svgNS,'line');
    line.setAttribute('x1',padL); line.setAttribute('x2',W-padR);
    line.setAttribute('y1',y); line.setAttribute('y2',y);
    line.setAttribute('stroke','#999'); line.setAttribute('stroke-dasharray','4,4');
    svg.appendChild(line);

    const lbl=document.createElementNS(svgNS,'text');
    lbl.setAttribute('x', padL-8); lbl.setAttribute('y', y+4);
    lbl.setAttribute('class','pop-axis-label'); lbl.setAttribute('text-anchor','end');
    lbl.textContent = v+'%';
    svg.appendChild(lbl);
  });

  const barW = innerW / list.length - 4;
  list.forEach((d,i)=>{
    const x = padL + i*(innerW/list.length) + 2;
    const h = innerH*(d.pop/100);
    const y = padT + innerH - h;

    // bar
    const rect = document.createElementNS(svgNS,'rect');
    rect.setAttribute('x',x); rect.setAttribute('y',y);
    rect.setAttribute('width',Math.max(2,barW)); rect.setAttribute('height',Math.max(1,h));
    rect.setAttribute('fill','#000');
    svg.appendChild(rect);

    // value label
    const tl = document.createElementNS(svgNS,'text');
    tl.setAttribute('x', x + Math.max(2,barW)/2);
    tl.setAttribute('y', y - 6);
    tl.setAttribute('class','pop-bar-label');
    tl.textContent = d.pop ? `${d.pop}%` : '0';
    svg.appendChild(tl);

    // hour labels every 3 hours
    if(i%3===0){
      const hr = d.t.toLocaleTimeString('en-US',{hour:'numeric', timeZone:TIME_ZONE});
      const tx = document.createElementNS(svgNS,'text');
      tx.setAttribute('x', x + Math.max(2,barW)/2);
      tx.setAttribute('y', padT + innerH + 22);
      tx.setAttribute('class','pop-axis-label');
      tx.setAttribute('text-anchor','middle');
      tx.textContent = hr;
      svg.appendChild(tx);
    }
  });

  container.appendChild(svg);
  document.getElementById('forecast-ts').textContent='Last updated: '+fmtDT();
}

/* ================== River (USGS) ================== */
function classifyFlow(cfs, stage, flood){ 
  if(Number.isFinite(stage) && Number.isFinite(flood) && stage>=flood)
    return 'UNSAFE RIVER FLOW - ACCESS CLOSED, STAY OFF THE RIVER!';
  if(!Number.isFinite(cfs)) return '—';
  if(cfs<200) return 'RIVER FLOW TOO LOW TO PADDLE';
  if(cfs<=700) return 'LOW-MODERATE RIVER FLOW - BEGINNER TO NOVICE PADDLERS';
  if(cfs<=1600) return 'MODERATE-HIGH RIVER FLOW - EXPERT PADDLERS ONLY';
  if(cfs>=2500) return 'UNSAFE RIVER FLOW - ACCESS CLOSED, STAY OFF THE RIVER!';
  return 'EXPERT PADDLERS ONLY';
}
function trendArrow(vals, field, smallDelta, pctDelta){
  try{
    if(!Array.isArray(vals)||vals.length<2) return {arrow:'→',label:'steady'};
    const last=new Date(vals[vals.length-1].dateTime).getTime();
    const start=last-3*3600*1000;
    let sub=vals.filter(v=>new Date(v.dateTime).getTime()>=start);
    if(sub.length<2) sub=vals.slice(-6);
    const a=sub[0][field], b=sub[sub.length-1][field];
    const diff=b-a, pct=Math.abs(diff)/Math.max(1e-6,Math.abs(a));
    if(Math.abs(diff)<smallDelta && pct<pctDelta) return {arrow:'→',label:'steady'};
    return diff>0 ? {arrow:'▲',label:'rising'} : {arrow:'▼',label:'falling'};
  }catch{return {arrow:'→',label:'steady'};}
}
function group3h(arr, key){
  const map={};
  arr.forEach(pt=>{
    const d=new Date(pt.dateTime); const k=new Date(d.getFullYear(), d.getMonth(), d.getDate(), Math.floor(d.getHours()/3)*3).toISOString();
    (map[k]||(map[k]={dateObj:new Date(k), sum:0, count:0})).sum += pt[key]; map[k].count++;
  });
  return Object.values(map).map(x=>({dateObj:x.dateObj, stage:x.sum/x.count})).sort((a,b)=>a.dateObj-b.dateObj);
}
function drawRiverGraph(points, lastStr){
  const el=document.getElementById('river-graph'); el.innerHTML='';
  if(!points.length) return;
  const svgNS='http://www.w3.org/2000/svg';
  const W=1001, H=280, gH=180, offX=60;
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  let minStage=Math.min(...points.map(p=>p.stage));
  let maxStage=Math.max(...points.map(p=>p.stage));
  maxStage=Math.max(maxStage,6); minStage=Math.min(minStage,floodThreshold); maxStage=Math.max(maxStage,floodThreshold);
  const range=(maxStage-minStage)||1;
  const minDate=points[0].dateObj, maxDate=points[points.length-1].dateObj, total=maxDate-minDate;
  const width=W-offX-20;

  function x(date){ return offX + ((date-minDate)/total)*width - 20; }
  function y(stage){ return gH - ((stage-minStage)/range)*gH + 20; }

  // ticks
  for(let t=Math.floor(minStage); t<=Math.ceil(maxStage); t++){
    const Y=y(t);
    const tick=document.createElementNS(svgNS,'line'); tick.setAttribute('x1',offX-5); tick.setAttribute('x2',offX); tick.setAttribute('y1',Y); tick.setAttribute('y2',Y); tick.setAttribute('stroke','#000'); svg.appendChild(tick);
    const lbl=document.createElementNS(svgNS,'text'); lbl.setAttribute('x',offX-10); lbl.setAttribute('y',Y+4); lbl.setAttribute('font-size','21'); lbl.setAttribute('text-anchor','end'); lbl.textContent=String(t); svg.appendChild(lbl);
  }

  // path
  const d=points.map((p,i)=>(i?'L':'M')+x(p.dateObj)+','+y(p.stage)).join(' ');
  const path=document.createElementNS(svgNS,'path'); path.setAttribute('d',d); path.setAttribute('stroke','#000'); path.setAttribute('stroke-width','6.6'); path.setAttribute('fill','none'); svg.appendChild(path);

  // flood dashed line & label
  const fy=y(floodThreshold);
  const fl=document.createElementNS(svgNS,'line'); fl.setAttribute('x1',offX); fl.setAttribute('x2',offX+width); fl.setAttribute('y1',fy); fl.setAttribute('y2',fy); fl.setAttribute('stroke','#000'); fl.setAttribute('stroke-dasharray','6,3'); fl.setAttribute('stroke-width','4'); svg.appendChild(fl);
  const flbl=document.createElementNS(svgNS,'text'); flbl.setAttribute('x',offX+width-10); flbl.setAttribute('y',fy-10); flbl.setAttribute('font-size','32'); flbl.setAttribute('font-weight','bold'); flbl.setAttribute('text-anchor','end'); flbl.textContent='Flood Stage'; svg.appendChild(flbl);

  // dots + x labels + last value tag
  let lastDay='';
  points.forEach((p,i)=>{
    const cx=x(p.dateObj), cy=y(p.stage);
    const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r','3'); c.setAttribute('fill','#000'); svg.appendChild(c);
    const day=p.dateObj.toLocaleDateString(undefined,{month:'short', day:'numeric'});
    if(day!==lastDay){ lastDay=day; const tx=document.createElementNS(svgNS,'text'); tx.setAttribute('x',cx); tx.setAttribute('y',240); tx.setAttribute('font-size','30'); tx.setAttribute('text-anchor','middle'); tx.textContent=day; svg.appendChild(tx); }
    if(i===points.length-1){
      const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',cx-0.1*width); t.setAttribute('y',cy+45); t.setAttribute('font-size','35'); t.setAttribute('font-weight','bold'); t.setAttribute('fill','#fff'); t.setAttribute('text-anchor','middle'); t.textContent=' '+lastStr+' ';
      const rect=document.createElementNS(svgNS,'rect'); setTimeout(()=>{ const b=t.getBBox(); rect.setAttribute('x',b.x-5); rect.setAttribute('y',b.y); rect.setAttribute('width',b.width+10); rect.setAttribute('height',b.height); rect.setAttribute('fill','#000'); svg.insertBefore(rect,t); },0);
      svg.appendChild(t);
    }
  });

  document.getElementById('river-graph').appendChild(svg);
}

async function fetchRiver(){
  try{
    const end=new Date(), start=new Date(); start.setDate(end.getDate()-4);
    const fmt=d=>d.toISOString().split('.')[0];
    const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065,00060&startDT=${fmt(start)}&endDT=${fmt(end)}&siteStatus=all`;
    const data=await (await fetch(url)).json();
    const ts=data?.value?.timeSeries||[];
    const find=code=>ts.find(s=>(s?.variable?.variableCode?.[0]?.value)===code);
    const stageS=find('00065'), flowS=find('00060');

    // flood stage from site property
    const sp = stageS?.sourceInfo?.siteProperty || flowS?.sourceInfo?.siteProperty || [];
    sp.forEach(p=>{ if(p.propertyName==='floodStage'){ const n=parseFloat(p.value); if(Number.isFinite(n)) floodThreshold=n; } });

    const stageVals=(stageS?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, stage:parseFloat(v.value)})).filter(p=>Number.isFinite(p.stage));
    const flowVals=(flowS?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, flow:parseFloat(v.value)})).filter(p=>Number.isFinite(p.flow));

    if(!stageVals.length){
      document.getElementById('flood-status').textContent='No river data available';
      document.getElementById('stage-line').innerHTML='<strong>Stage:</strong> —';
      document.getElementById('flow-line').innerHTML='<strong>Discharge:</strong> —';
      return;
    }

    const lastStage=stageVals[stageVals.length-1].stage;
    const lastStageStr=`${lastStage.toFixed(2)} ft`;
    const lastFlow=flowVals.length?flowVals[flowVals.length-1].flow:NaN;
    const flowStr = Number.isFinite(lastFlow)? `${Math.round(lastFlow)} cfs` : '—';

    const sTrend=trendArrow(stageVals,'stage',0.20,0.02);
    const fTrend=trendArrow(flowVals,'flow',30,0.05);

    document.getElementById('flood-status').textContent = lastStage>=floodThreshold ? 'FLOOD LEVELS UNSAFE, ACCESS CLOSED' : 'RIVER BELOW FLOOD STAGE';
    document.getElementById('flow-class').textContent = classifyFlow(lastFlow,lastStage,floodThreshold);
    document.getElementById('stage-line').innerHTML=`<strong>Stage:</strong> ${lastStageStr} ${sTrend.arrow} ${sTrend.label}`;
    document.getElementById('flow-line').innerHTML = `<strong>Discharge:</strong> ${flowStr} ${fTrend.arrow} ${fTrend.label}`;

    drawRiverGraph(group3h(stageVals,'stage'), lastStageStr);
    document.getElementById('river-ts').textContent='Last updated: '+fmtDT();
  }catch(e){
    document.getElementById('river-ts').textContent='Last updated: '+fmtDT();
  }
}

/* ================== AQI (Open-Meteo) ================== */
function aqiCategory(n){ if(n<=50) return 'GOOD'; if(n<=100) return 'MODERATE'; if(n<=150) return 'UNHEALTHY FOR SENSITIVE GROUPS'; if(n<=200) return 'UNHEALTHY'; if(n<=300) return 'VERY UNHEALTHY'; return 'HAZARDOUS'; }
function aqiAdvice(cat){
  const c=cat.toLowerCase();
  if(c==='good') return 'Air quality is satisfactory; great for outdoor activities.';
  if(c==='moderate') return 'Okay for most; unusually sensitive people may shorten outdoor exertion.';
  if(c.includes('sensitive')) return 'Sensitive groups should reduce prolonged or heavy outdoor exertion.';
  if(c==='unhealthy') return 'Everyone may feel effects; sensitive groups should avoid prolonged exertion.';
  if(c.includes('very')) return 'Health alert: consider limiting outdoor activity; sensitive groups should avoid it.';
  return 'Emergency conditions: everyone should avoid all outdoor exertion.';
}
function drawAQIGauge(aqi){
  const cont=document.getElementById('aqi-gauge'); cont.innerHTML='';
  const svgNS='http://www.w3.org/2000/svg', W=540,H=220, cx=W/2, cy=H-6, R=Math.min(W/2-10, H-20);
  const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',W); svg.setAttribute('height',H);
  const arcBG=document.createElementNS(svgNS,'path'); const bg=`M ${cx-R} ${cy} A ${R} ${R} 0 0 1 ${cx+R} ${cy}`; arcBG.setAttribute('d',bg); arcBG.setAttribute('fill','none'); arcBG.setAttribute('stroke','#000'); arcBG.setAttribute('stroke-width','6'); svg.appendChild(arcBG);

  const clamped=Math.max(0,Math.min(300,Number(aqi)||0)), phi=(clamped/300)*Math.PI;
  const start=Math.PI, end=Math.PI-phi;
  const x0=cx+R*Math.cos(start), y0=cy-R*Math.sin(start);
  const x1=cx+R*Math.cos(end), y1=cy-R*Math.sin(end);
  if(phi>0.0001){
    const path=document.createElementNS(svgNS,'path');
    path.setAttribute('d',`M ${cx} ${cy} L ${x0} ${y0} A ${R} ${R} 0 0 1 ${x1} ${y1} Z`);
    path.setAttribute('fill','#777'); path.setAttribute('stroke','#000'); path.setAttribute('stroke-width','2');
    svg.appendChild(path);
  }
  const arcFG=document.createElementNS(svgNS,'path'); arcFG.setAttribute('d',bg); arcFG.setAttribute('fill','none'); arcFG.setAttribute('stroke','#000'); arcFG.setAttribute('stroke-width','6'); svg.appendChild(arcFG);
  cont.appendChild(svg);
}
async function fetchAQI(){
  try{
    const url=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto&_=${Date.now()}`;
    const data=await (await fetch(url,{cache:'no-store'})).json();
    const t=data?.hourly?.time||[], a=data?.hourly?.us_aqi||[], p25=data?.hourly?.pm2_5||[], p10=data?.hourly?.pm10||[], o3=data?.hourly?.ozone||[];
    if(!t.length||!a.length) throw new Error('no aqi');
    const now=new Date(); let idx=t.length-1; for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
    const val=Math.round(a[idx]);
    drawAQIGauge(val);
    const cat=aqiCategory(val);
    document.getElementById('aqi-class').textContent=cat;
    document.getElementById('aqi-value').textContent=`AQI: ${val}`;
    document.getElementById('aqi-guidance').textContent=aqiAdvice(cat);
    const fmt=n=>Number.isFinite(n)?Math.round(n):'—';
    document.getElementById('aqi-breakdown').textContent=`PM2.5 ${fmt(p25[idx])} µg/m³ • PM10 ${fmt(p10[idx])} µg/m³ • O₃ ${fmt(o3[idx])} µg/m³`;
    document.getElementById('aqi-source').textContent=`Source: Open-Meteo (US AQI) • As of ${fmtDT(new Date(t[idx]))}`;
    document.getElementById('aqi-ts').textContent='Last updated: '+fmtDT();
  }catch(e){
    document.getElementById('aqi-ts').textContent='Last updated: '+fmtDT();
  }
}

/* ================== Fit / rotation: keep footer visible ================== */
function fitAndRotate(){
  const cont = document.getElementById('cards');
  // show everything first
  Array.from(cont.children).forEach(sec=>sec.style.display='');

  // order optional list based on 2-minute rotation
  const optionals = Array.from(cont.children).filter(s=>s.dataset.required!=='1');
  if(optionals.length){
    const start = twoMinuteIndex(optionals.length);
    const ordered = optionals.slice(start).concat(optionals.slice(0,start));
    ordered.forEach(sec=>cont.appendChild(sec));
  }

  // compute available height (page minus fixed footer)
  const maxH = 2560 - 8 /*footer bottom*/ - 24 /*footer pad*/ - 24 /*buffer*/;
  let used = document.getElementById('header').offsetHeight + 32 /*top pad*/;
  const children = Array.from(cont.children);
  for(const sec of children){
    sec.style.display=''; // ensure measured
    used += sec.offsetHeight + 14; // gap
    if(used > maxH){
      // hide this and everything after (only optional cards)
      let hide=false;
      for(const s of children){
        if(s===sec) hide=true;
        if(hide && s.dataset.required!=='1') s.style.display='none';
      }
      break;
    }
  }
}

/* ================== Master refresh ================== */
function stampAll(){
  document.getElementById('access-ts').textContent='Last updated: '+fmtDT();
  document.getElementById('alerts-ts').textContent='Last updated: '+fmtDT();
  document.getElementById('weather-ts').textContent='Last updated: '+fmtDT();
  document.getElementById('river-ts').textContent='Last updated: '+fmtDT();
  document.getElementById('forecast-ts').textContent='Last updated: '+fmtDT();
  document.getElementById('aqi-ts').textContent='Last updated: '+fmtDT();
}

async function refreshAll(){
  updateAccess();
  await Promise.all([fetchAlerts(), fetchWeather(), fetchRiver(), fetchAQI()]);
  fitAndRotate();
}

window.onload = refreshAll;
// data every 10 min; layout/alert paging & rotation every 60s for consistency if device misses a beat
setInterval(refreshAll, 10*60*1000);
setInterval(()=>{ renderAlert(); fitAndRotate(); }, 60*1000);
</script>
</body>
</html>
