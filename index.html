<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- @import must be at the very top -->
  <style>
@import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

  :root{
    --panel-bg:#f0f0f0;
    --ink:#000;
    --card-border:#000;
    --card-bg:#fff;
    --accent-dark:#000;
    --accent-gray:#cccccc; /* same as river graph background */
  }

  body{
    background-color:var(--panel-bg);
    color:var(--ink);
    font-family:'Roboto',Arial,sans-serif;
    margin:0; padding:0;
    width:1440px; height:2560px; overflow:hidden;
    -webkit-text-size-adjust:none;
  }

  .container{ padding:32px; display:flex; flex-direction:column; gap:14px; }

  .section{
    border:4px solid var(--card-border);
    padding:16px; box-sizing:border-box;
    border-radius:8px; background-color:var(--card-bg);
    display:flex; flex-direction:column; position:relative;
  }

  .card-title{
    font-size:36px; font-weight:bold;
    background-color:var(--accent-dark); color:#fff;
    padding:4px 8px; margin-bottom:8px; text-align:left;
  }

  .section-content{ display:flex; flex-direction:column; align-items:flex-end; text-align:right; }
  .centered .section-content{ align-items:center; text-align:center; }

  .value{ font-size:100px; font-weight:bold; margin:10px 0; }
  .label{ font-size:32px; color:#444; }

  .timestamp,.card-timestamp{ font-size:24px; color:#222; margin-top:8px; text-align:right; }

  /* Header with centered title + bold lat/lon; logo pinned left */
  #header{
    background-color:var(--accent-dark); color:#fff;
    padding:16px 20px; font-size:40px; font-weight:bold;
    display:flex; align-items:center; justify-content:center;
    position:relative; text-align:center;
  }
  #header .logo{
    position:absolute; left:16px; top:50%; transform:translateY(-50%);
    height:64px; width:auto; object-fit:contain;
  }
  #header .title{ line-height:1.15; }
  #header-lat,#header-lon{ font-weight:900; } /* bold lat/lon */

  /* Alerts */
  #alert-message{ font-weight:bold; white-space:pre-wrap; text-align:center; }

  /* Weather layout */
  #weather-section .section-content{
    flex-direction:row; justify-content:space-between; width:100%;
  }
  #weather-left{ display:flex; align-items:center; text-align:left; }
  #weather-icon{ width:126px; height:126px; margin-right:12px; }
  #weather-temp-F{ font-size:100px; font-weight:bold; line-height:0.9; }
  #weather-temp-C{ font-size:50px; font-weight:bold; }
  #weather-right{
    display:flex; flex-direction:row; gap:32px; align-items:flex-start;
    width:66%; justify-content:space-between;
  }
  .wx-col{ display:flex; flex-direction:column; align-items:flex-start; text-align:left; }
  .wx-line{ font-size:30px; font-weight:normal; } /* not bolded per request */
  #wx-source{ font-size:22px; font-weight:normal; align-self:flex-end; margin-top:6px; }

  /* AQI */
  #aqi-content{ white-space:nowrap; display:flex; align-items:center; justify-content:center; gap:16px; }
  #aqi-classification,#aqi-measurement{ font-size:38px; font-weight:bold; color:#000; margin-top:0; }
  #aqi-extra{ margin-top:6px; text-align:center; }
  #aqi-guidance{ font-size:36px; color:#222; line-height:1.2; font-weight:600; }
  #aqi-breakdown{ font-size:28px; color:#222; margin-top:2px; }
  #aqi-source{ font-size:20px; color:#444; }

  /* River */
  .river-header{
    background-color:var(--accent-dark); color:#fff; font-size:36px; font-weight:bold;
    padding:10px 8px; text-align:left; margin-bottom:8px;
  }
  #river-graph{ background-color:var(--accent-gray); display:block; margin:12px auto 0 auto; position:relative; width:1080px; padding-left:calc(5% - 4px); }
  #usgs-site-info{ width:100%; text-align:right; font-size:20px; color:#000; margin-top:2px; }
  #flood-status{ font-weight:bold; font-size:48px; margin-top:8px; display:inline-flex; align-items:center; gap:10px; }
  #paddle-advisory{ text-align:center; font-size:36px; font-weight:bold; margin-top:8px; padding:4px 8px; color:#fff; background:#000; display:inline-block; }
  #river-stats{ text-align:center; margin-top:12px; font-weight:900; } /* bold Stage/Discharge line */

  /* Park Status */
  #park-status-banner{
    width:100%; box-sizing:border-box;
    background:var(--accent-gray); color:#fff; border-radius:6px;
    display:flex; align-items:center; justify-content:center;
    padding:10px 12px;
    /* roughly 2× bigger without overflowing the card */
    font-weight:900; letter-spacing:1px; text-transform:uppercase;
    font-size: clamp(56px, 6.8vw, 100px);
  }
  #park-status-lines{
    display:flex; flex-direction:row; gap:18px; justify-content:center; margin-top:8px;
    flex-wrap:wrap;
  }
  #park-status-lines .line{ font-size:28px; font-weight:600; }

  /* Forecast */
  #rainfall-forecast .label{ font-weight:900; } /* bolded */

  /* Misc */
  #sunrise-sunset{ font-size:30px; font-weight:normal; color:#000; } /* now not bolded */
  #hydration-message{ font-size:32px; text-align:center; margin-top:10px; color:#000; }

  /* Fitting logic constants (viewport) */
  </style>
</head>
<body>
  <!-- Header -->
  <div id="header">
    <img class="logo" src="catham-logo.jpg" alt="Project logo" />
    <div class="title">
      US 64 Haw River Access, 348 River Access Rd (<span id="header-lat">35.730995</span> / <span id="header-lon">-79.107109</span>)
    </div>
  </div>

  <div class="container">

    <!-- PARK STATUS -->
    <div class="section centered" id="park-status-section">
      <div class="card-title">Park Status</div>
      <div class="section-content" style="width:100%; align-items:center;">
        <div id="park-status-banner">OPEN / ABIERTO</div>
        <div id="park-status-lines">
          <div class="line" id="park-today">Today: --</div>
          <div class="line" id="park-next">Next: --</div>
        </div>
      </div>
      <div class="card-timestamp" id="park-status-timestamp">Last updated: --</div>
    </div>

    <!-- Alerts -->
    <div class="section centered" id="alerts-section">
      <div class="card-title">Alerts</div>
      <div class="section-content">
        <div class="label" id="alert-message">No alerts at this time / Sin alertas en este momento</div>
      </div>
      <div class="card-timestamp" id="alerts-timestamp">Last updated: --</div>
    </div>

    <!-- Current Weather Conditions -->
    <div class="section centered" id="weather-section">
      <div class="card-title">Current Weather Conditions</div>

      <div class="section-content">
        <!-- Left third: big icon + temps -->
        <div id="weather-left" style="width:32%;">
          <div id="weather-icon"></div>
          <div>
            <div id="weather-temp-F">--°F</div>
            <div id="weather-temp-C">--°C</div>
          </div>
        </div>

        <!-- Right two-thirds: two neat columns of lines -->
        <div id="weather-right">
          <div class="wx-col">
            <div class="wx-line" id="sunrise-line">Sunrise: --</div>
            <div class="wx-line" id="sunset-line">Sunset: --</div>
            <div class="wx-line" id="uv-line">UV Index: --</div>
          </div>
          <div class="wx-col">
            <div class="wx-line" id="weather-forecast">--</div>
            <div class="wx-line" id="weather-wind">Wind: --</div>
            <div class="wx-line" id="weather-humidity">Humidity: --%</div>
            <div class="wx-line" id="weather-feelslike">Feels like: --°F</div>
            <div class="wx-line" id="weather-dewpoint">Dew point: --°F</div>
          </div>
        </div>
      </div>

      <div id="wx-source">Source: --</div>
      <div class="card-timestamp" id="weather-timestamp">Last updated: --</div>
    </div>

    <!-- River & Water Levels -->
    <div class="section" id="river-section">
      <div class="river-header">River Water Level & Flow</div>

      <!-- flood status + thumbs icon -->
      <div class="section-content" style="margin-top: 12px; padding: 0 16px; text-align:center; align-items:center;">
        <div class="label" id="flood-status"></div>
      </div>

      <!-- flow advisory banner ABOVE the graph -->
      <div style="display:flex; justify-content:center; margin-top:8px;">
        <div id="paddle-advisory" class="label">—</div>
      </div>

      <div id="river-graph"></div>

      <!-- Centered stats BELOW the graph (bold) -->
      <div id="river-stats" class="label">
        <span id="river-stage-line"></span> &nbsp;•&nbsp; <span id="river-flow-line"></span>
      </div>

      <div id="usgs-site-info">USGS Site #02096960</div>
      <div class="card-timestamp" id="river-timestamp">Last updated: --</div>
    </div>

    <!-- Forecast -->
    <div class="section centered" id="rainfall-forecast">
      <div class="card-title">Forecast</div>
      <div class="section-content">
        <div class="label" id="rainfall-forecast-1">--</div>
        <div class="label" id="rainfall-forecast-2">--</div>
      </div>
      <div class="card-timestamp" id="rainfall-timestamp">Last updated: --</div>
    </div>

    <!-- AQI -->
    <div class="section centered" id="aqi-section">
      <div class="card-title">Air Quality Index</div>
      <div class="section-content" id="aqi-content">
        <div id="aqi-classification">--</div>
        <div id="aqi-gauge-container"></div>
        <div id="aqi-measurement">AQI: --</div>
      </div>
      <div id="aqi-extra">
        <div id="aqi-guidance">—</div>
        <div id="aqi-breakdown">—</div>
        <div id="aqi-source">Source: —</div>
      </div>
      <div class="card-timestamp" id="aqi-timestamp">Last updated: --</div>
    </div>

    <!-- Swim Guide -->
    <div class="section centered" id="swim-us64">
      <div class="card-title">Swim Guide: US&nbsp;64 Access</div>
      <div class="section-content">
        <div class="value" id="swim-status">✔ SAFE TO SWIM</div>
        <div class="label" id="swim-sampled">Sampled: June&nbsp;27,&nbsp;2025 at&nbsp;13:45</div>
        <div class="label">Via Swim&nbsp;Guide / Haw&nbsp;River Assembly</div>
      </div>
      <div class="card-timestamp" id="swim-timestamp">Last updated: --</div>
    </div>

  </div>

<script>
/* =================== CONFIG / GLOBALS =================== */
let LAT = 35.730995;   // US 64
let LON = -79.107109;  // US 64
document.getElementById('header-lat').textContent = LAT;
document.getElementById('header-lon').textContent = LON;

const TIME_ZONE = 'America/New_York';
const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B';
let floodThreshold = 5.0;

// Park hours (easy to edit)
// Use 24h "HH:MM" local time. Same hours every day for now.
const PARK_HOURS = { open: "08:00", close: "19:00" }; // 8am–7pm local

// Cache last *good* AQI payload
let LAST_AQI = null;

/* =================== UTILITIES =================== */
const fmtDateTime = (d = new Date()) =>
  new Intl.DateTimeFormat('en-US', { dateStyle: 'short', timeStyle: 'short', timeZone: TIME_ZONE }).format(d);
const fmtTime = (d) =>
  new Intl.DateTimeFormat('en-US', { hour: 'numeric', minute: 'numeric', timeZone: TIME_ZONE }).format(d);

function parseHHMM(s){ const [h,m]=s.split(':').map(n=>parseInt(n,10)); return {h:h||0,m:m||0}; }
function within(now, start, end){ return now >= start && now < end; }
function diffHM(from, to){
  const ms = Math.max(0, to - from);
  const mins = Math.round(ms/60000);
  const h = Math.floor(mins/60);
  const m = mins % 60;
  if (h>0 && m>0) return `${h}h ${m}m`;
  if (h>0) return `${h}h`;
  return `${m} min`;
}

/* =================== ICONS (SVG) =================== */
function getThumbUpSVG(px=48){
  const s = String(px);
  return `
    <svg width="${s}" height="${s}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path d="M22 28V10c0-3 2-6 5-6h2c2 0 3 1 3 3v9c0 3 1 5 3 7l2 2h12c3 0 6 3 6 6l-3 18c0 3-3 5-6 5H26c-3 0-4-2-4-4V28zM6 28h12v30H6z"
            fill="black"/>
    </svg>
  `;
}

function getWeatherIcon(forecast) {
  forecast = (forecast || '').toLowerCase();
  if (forecast.includes("sunny") || forecast.includes("clear")) {
    return `<svg width="126" height="126" viewBox="0 0 64 64"><circle cx="32" cy="32" r="12" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="32" y1="4" x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="60"/><line x1="4" y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="60" y2="32"/><line x1="12" y1="12" x2="18" y2="18"/><line x1="46" y1="46" x2="52" y2="52"/><line x1="12" y1="52" x2="18" y2="46"/><line x1="46" y1="18" x2="52" y2="12"/></g></svg>`;
  } else if (forecast.includes("cloud")) {
    return `<svg width="126" height="126" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
  } else if (forecast.includes("rain")) {
    return `<svg width="126" height="126" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/></g></svg>`;
  } else if (forecast.includes("snow")) {
    return `<svg width="126" height="126" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="32" y1="48" x2="32" y2="60"/><line x1="26" y1="52" x2="38" y2="52"/></g></svg>`;
  }
  return `<svg width="126" height="126" viewBox="0 0 64 64"><circle cx="22" cy="22" r="10" fill="black" stroke="black" stroke-width="3"/><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
}

/* =================== SUN + UV =================== */
function fetchSunriseSunsetAndUV(){
  const url = `https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`;
  fetch(url).then(r=>r.json()).then(data=>{
    if(data.status==="OK"){
      const sr = new Date(data.results.sunrise);
      const ss = new Date(data.results.sunset);
      document.getElementById('sunrise-line').textContent = `Sunrise: ${fmtTime(sr)}`;
      document.getElementById('sunset-line').textContent  = `Sunset: ${fmtTime(ss)}`;
    }
  }).catch(()=>{});

  // Simple UV from Open-Meteo (supports CORS) — index + station distance approximation
  const uvUrl = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto&_=${Date.now()}`;
  fetch(uvUrl).then(r=>r.json()).then(d=>{
    const t = d?.hourly?.time || [];
    const v = d?.hourly?.uv_index || [];
    if(t.length && v.length){
      // choose current or most recent hour
      const now = new Date();
      let idx = t.length-1;
      for(let i=t.length-1;i>=0;i--){ if(new Date(t[i])<=now){ idx=i; break; } }
      const uv = Math.round(Number(v[idx]||0));
      document.getElementById('uv-line').textContent = `UV Index: ${uv}`;
      document.getElementById('wx-source').textContent = `Source: NWS + Open-Meteo (${(d?.latitude||LAT).toFixed(3)}, ${(d?.longitude||LON).toFixed(3)})`;
    } else {
      document.getElementById('wx-source').textContent = `Source: NWS`;
    }
  }).catch(()=>{
    document.getElementById('wx-source').textContent = `Source: NWS`;
  });
}

/* =================== AQI GAUGE =================== */
function generateAirNowArcGauge(aqi, category){
  const svgNS = "http://www.w3.org/2000/svg";
  const width = 280, height = 140;
  const cx = width/2, cy = height, r = width/2;
  const segAngle = 36;
  const segColors = ["#e0e0e0","#cccccc","#b8b8b8","#a4a4a4","#909090"];

  const svg = document.createElementNS(svgNS,"svg");
  svg.setAttribute("width",width); svg.setAttribute("height",height);
  svg.setAttribute("viewBox",`0 0 ${width} ${height}`);

  for(let i=0;i<5;i++){
    const a1=(180 - i*segAngle) * Math.PI/180;
    const a2=(180 - (i+1)*segAngle) * Math.PI/180;
    const x1 = cx + r*Math.cos(a1), y1 = cy - r*Math.sin(a1);
    const x2 = cx + r*Math.cos(a2), y2 = cy - r*Math.sin(a2);
    const p = document.createElementNS(svgNS,"path");
    p.setAttribute("d",`M ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2} L ${cx} ${cy} Z`);
    p.setAttribute("fill",segColors[i]);
    p.setAttribute("stroke","black");
    p.setAttribute("stroke-width","8");
    svg.appendChild(p);
  }

  // needle
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const fillProp = clamp(aqi,0,300)/300;
  const angle = 180 - (fillProp*180);
  const rad = angle*Math.PI/180;
  const px = cx + r*Math.cos(rad), py = cy - r*Math.sin(rad);
  const needle = document.createElementNS(svgNS,"line");
  needle.setAttribute("x1",cx); needle.setAttribute("y1",cy);
  needle.setAttribute("x2",px); needle.setAttribute("y2",py);
  needle.setAttribute("stroke","black"); needle.setAttribute("stroke-width","8"); needle.setAttribute("stroke-linecap","round");
  svg.appendChild(needle);

  return svg;
}

function aqiCategoryFromValue(n){
  if (n <= 50) return "Good";
  if (n <= 100) return "Moderate";
  if (n <= 150) return "Unhealthy for Sensitive Groups";
  if (n <= 200) return "Unhealthy";
  if (n <= 300) return "Very Unhealthy";
  return "Hazardous";
}
function aqiGuidanceForCategory(cat){
  const c = String(cat||"").toLowerCase();
  if (c==="good") return "Air quality is satisfactory; great for outdoor activities.";
  if (c==="moderate") return "Okay for most; unusually sensitive people may shorten outdoor exertion.";
  if (c.includes("sensitive")) return "Sensitive groups should reduce prolonged or heavy outdoor exertion.";
  if (c==="unhealthy") return "Everyone may feel effects; sensitive groups should avoid prolonged exertion.";
  if (c.includes("very")) return "Health alert: consider limiting outdoor activity; sensitive groups should avoid it.";
  return "Emergency conditions: everyone should avoid all outdoor exertion.";
}

function renderAQI(state, cached=false){
  const content = document.getElementById("aqi-content");
  content.innerHTML = "";

  const L = document.createElement("div"); L.id="aqi-classification";
  const C = document.createElement("div"); C.id="aqi-gauge-container";
  const R = document.createElement("div"); R.id="aqi-measurement";

  if(!state){
    L.textContent = "DATA UNAVAILABLE";
    C.appendChild(generateAirNowArcGauge(0,"Unknown"));
    R.textContent = "AQI: —";
    document.getElementById("aqi-guidance").textContent = "—";
    document.getElementById("aqi-breakdown").textContent = "—";
    document.getElementById("aqi-source").textContent = "Source: —";
  }else{
    const { aqiValue, category, source, asOf, breakdown } = state;
    L.textContent = category.toUpperCase() + (cached ? " (CACHED)" : "");
    C.appendChild(generateAirNowArcGauge(aqiValue, category));
    R.textContent = "AQI: " + aqiValue;

    document.getElementById("aqi-guidance").textContent = aqiGuidanceForCategory(category);
    document.getElementById("aqi-breakdown").textContent = breakdown || "—";
    document.getElementById("aqi-source").textContent = `Source: ${source||"—"} • As of ${fmtDateTime(asOf?new Date(asOf):new Date())}`;
  }
  content.appendChild(L); content.appendChild(C); content.appendChild(R);
  document.getElementById("aqi-timestamp").textContent = "Last updated: " + fmtDateTime();
  setTimeout(fitCardsToViewport,0);
}

/* Primary source (AirNow), fallback (Open-Meteo) */
async function fetchAQIFromOpenMeteo(){
  const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto&_=${Date.now()}`;
  const res = await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error(`Open-Meteo HTTP ${res.status}`);
  const data = await res.json();
  const times = data?.hourly?.time||[], a = data?.hourly?.us_aqi||[];
  if(!times.length || !a.length) throw new Error("Open-Meteo missing hourly/us_aqi");
  const now = new Date(); let idx = times.length-1; for(let i=times.length-1;i>=0;i--){ if(new Date(times[i])<=now){ idx=i; break; } }
  const val = Math.round(Number(a[idx])); if(!Number.isFinite(val)) throw new Error("Open-Meteo AQI not finite");
  const fmt=(n)=>Number.isFinite(n)?Math.round(n):"—";
  const p25 = data?.hourly?.pm2_5? Number(data.hourly.pm2_5[idx]):NaN;
  const p10 = data?.hourly?.pm10? Number(data.hourly.pm10[idx]):NaN;
  const o3  = data?.hourly?.ozone? Number(data.hourly.ozone[idx]):NaN;
  const breakdown = `PM2.5 ${fmt(p25)} µg/m³ • PM10 ${fmt(p10)} µg/m³ • O₃ ${fmt(o3)} µg/m³`;
  const category = aqiCategoryFromValue(val);
  LAST_AQI = { aqiValue:val, category, source:"Open-Meteo (US AQI)", asOf:times[idx], breakdown };
  renderAQI(LAST_AQI);
}
async function fetchAQIData(){
  const airnowUrl = `https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}&_=${Date.now()}`;
  try{
    const res = await fetch(airnowUrl,{mode:"cors",cache:"no-store",headers:{Accept:"application/json"}});
    if(!res.ok) throw new Error(`AirNow HTTP ${res.status}`);
    const data = await res.json();
    const rows = Array.isArray(data)? data.filter(r=>Number.isFinite(Number(r?.AQI))):[];
    if(!rows.length) throw new Error("AirNow empty/invalid");
    const PREFER=["PM2.5","O3","PM10"];
    const norm=(s)=>{ const x=(s||"").toUpperCase().replace(/\s+/g,""); return x==="PM2.5"||x==="PM25"?"PM2.5":x; };
    rows.sort((a,b)=>{ const ai=PREFER.indexOf(norm(a.ParameterName)), bi=PREFER.indexOf(norm(b.ParameterName)); const ap=ai===-1?999:ai, bp=bi===-1?999:bi; if(ap!==bp)return ap-bp; return (Number(b.AQI)||0)-(Number(a.AQI)||0); });
    const best = rows[0];
    const val = Math.round(Number(best.AQI));
    const category = best?.Category?.Name || aqiCategoryFromValue(val);
    const param = norm(best.ParameterName) || "AQI";
    const area = best?.ReportingArea ? ` — ${best.ReportingArea}` : "";
    const byP={}; rows.forEach(r=>{ const p=norm(r.ParameterName); if(p) byP[p]=Math.round(Number(r.AQI)); });
    const parts=[];
    if(byP["PM2.5"]!=null) parts.push(`PM2.5 ${byP["PM2.5"]} (${aqiCategoryFromValue(byP["PM2.5"])})`);
    if(byP["PM10"] !=null) parts.push(`PM10 ${byP["PM10"]} (${aqiCategoryFromValue(byP["PM10"])})`);
    if(byP["O3"]   !=null) parts.push(`O₃ ${byP["O3"]} (${aqiCategoryFromValue(byP["O3"])})`);
    LAST_AQI = { aqiValue:val, category, source:`AirNow (${param}${area})`, asOf:new Date(), breakdown: parts.length?parts.join(" • "):"—" };
    renderAQI(LAST_AQI);
  }catch(err){
    try{ await fetchAQIFromOpenMeteo(); }
    catch(e){ if(LAST_AQI) renderAQI(LAST_AQI,true); else renderAQI(null); }
  }
}

/* =================== WEATHER (NWS) =================== */
function parseWindMph(w){ const m=String(w||"").match(/[\d.]+/); return m?parseFloat(m[0]):0; }
function fToC(f){ return (f-32)*5/9; }
function cToF(c){ return (c*9/5)+32; }
// Magnus over water
function dewPointF(Tf,RH){
  const T = fToC(Tf), R = Math.max(1e-6,Math.min(100,RH))/100, b=17.62,c=243.12;
  const g = Math.log(R)+(b*T)/(c+T); const TdC=(c*g)/(b-g); return Math.round(cToF(TdC));
}
function windChillF(T,V){ return 35.74+0.6215*T-35.75*Math.pow(V,0.16)+0.4275*T*Math.pow(V,0.16); }
function heatIndexF(T,R){ const c1=-42.379,c2=2.04901523,c3=10.14333127,c4=-0.22475541,c5=-0.00683783,c6=-0.05481717,c7=0.00122874,c8=0.00085282,c9=-0.00000199; let HI=c1+c2*T+c3*R+c4*T*R+c5*T*T+c6*R*R+c7*T*T*R+c8*T*R*R+c9*T*T*R*R; if(R<13&&T>=80&&T<=112)HI-=((13-R)/4)*Math.sqrt((17-Math.abs(T-95))/17); if(R>85&&T>=80&&T<=87)HI+=((R-85)/10)*((87-T)/5); return HI; }
function feelsLikeF(T,R,V){ if(T<=50&&V>=3) return windChillF(T,V); if(T>=80&&R>=40) return Math.round(heatIndexF(T,R)); return T; }

function fetchNWSData(){
  const pointUrl = `https://api.weather.gov/points/${LAT},${LON}`;
  fetch(pointUrl).then(r=>r.json()).then(point=>{
    const obsUrl = point.properties.forecastHourly;
    const gridUrl = point.properties.forecast;
    const alertZone = point.properties.forecastZone;

    fetch(obsUrl).then(r=>r.json()).then(obs=>{
      const p = obs?.properties?.periods||[];
      if(p.length){
        const now = p[0];
        const tempF = Number(now.temperature);
        const tempC = Number.isFinite(tempF)? ((tempF-32)*5/9).toFixed(1):"--";
        const rhVal = now.relativeHumidity?.value!=null ? Number(now.relativeHumidity.value):NaN;
        const windStr = now.windSpeed||"0 mph";
        const windMph = parseWindMph(windStr);

        document.getElementById('weather-icon').innerHTML = getWeatherIcon(now.shortForecast);
        document.getElementById('weather-temp-F').textContent = Number.isFinite(tempF)? `${tempF}°F`:"--°F";
        document.getElementById('weather-temp-C').textContent = Number.isFinite(tempF)? `${tempC}°C`:"--°C";
        document.getElementById('weather-forecast').textContent = now.shortForecast||"N/A";
        document.getElementById('weather-wind').textContent = `Wind: ${windStr||'--'}`;
        document.getElementById('weather-humidity').textContent = `Humidity: ${Number.isFinite(rhVal)? Math.round(rhVal):'--'}%`;

        if(Number.isFinite(tempF) && Number.isFinite(rhVal)){
          document.getElementById('weather-feelslike').textContent = `Feels like: ${Math.round(feelsLikeF(tempF,rhVal,windMph))}°F`;
          document.getElementById('weather-dewpoint').textContent = `Dew point: ${dewPointF(tempF,rhVal)}°F`;
        }else{
          document.getElementById('weather-feelslike').textContent = `Feels like: —`;
          document.getElementById('weather-dewpoint').textContent = `Dew point: —`;
        }

        fetchSunriseSunsetAndUV();
        document.getElementById('weather-timestamp').textContent = "Last updated: " + fmtDateTime();
        fitCardsToViewport();
      }
    }).catch(()=>{});

    fetch(gridUrl).then(r=>r.json()).then(g=>{
      const per = g?.properties?.periods || [];
      if(per.length){
        const d1 = per[0], d2 = per[1];
        document.getElementById('rainfall-forecast-1').textContent = `${d1?.name||'Day 1'}: ${d1?.shortForecast||'N/A'}`;
        document.getElementById('rainfall-forecast-2').textContent = `${d2?.name||'Day 2'}: ${d2?.shortForecast||'N/A'}`;
        document.getElementById('rainfall-timestamp').textContent = "Last updated: " + fmtDateTime();
      }
    }).catch(()=>{});

    if(alertZone){
      const zoneId = alertZone.split('/').pop();
      const alertUrl = `https://api.weather.gov/alerts/active/zone/${zoneId}`;
      fetch(alertUrl).then(r=>r.json()).then(a=>{
        if(a?.features?.length>0){
          const msg = a.features.map(f=>f.properties.headline).join('\n');
          document.getElementById('alert-message').textContent = msg;
        }else{
          document.getElementById('alert-message').textContent = 'No alerts at this time / Sin alertas en este momento';
        }
        document.getElementById('alerts-timestamp').textContent = "Last updated: " + fmtDateTime();
      }).catch(()=>{});
    }
  }).catch(()=>{});
}

/* =================== RIVER (USGS) =================== */
function computeFlowTrend(flowValues){
  try{
    if(!Array.isArray(flowValues)||flowValues.length<2) return {arrow:'→',label:'steady'};
    const lastTime = new Date(flowValues[flowValues.length-1].dateTime).getTime();
    const start = lastTime - 3*3600*1000;
    let sub = flowValues.filter(p=>new Date(p.dateTime).getTime()>=start);
    if(sub.length<2) sub = flowValues.slice(-6);
    const first = sub[0].flow, last = sub[sub.length-1].flow;
    const diff = last-first, pct = Math.abs(diff)/Math.max(1,first);
    if(Math.abs(diff)<30 && pct<0.05) return {arrow:'→',label:'steady'};
    return diff>0? {arrow:'▲',label:'rising'}:{arrow:'▼',label:'falling'};
  }catch{return {arrow:'→',label:'steady'};}
}
function computeStageTrend(stageValues){
  try{
    if(!Array.isArray(stageValues)||stageValues.length<2) return {arrow:'→',label:'steady'};
    const lastTime = new Date(stageValues[stageValues.length-1].dateTime).getTime();
    const start = lastTime - 3*3600*1000;
    let sub = stageValues.filter(p=>new Date(p.dateTime).getTime()>=start);
    if(sub.length<2) sub = stageValues.slice(-6);
    const first=sub[0].stage, last=sub[sub.length-1].stage;
    const diff=last-first, pct=Math.abs(diff)/Math.max(0.01,first);
    if(Math.abs(diff)<0.20 && pct<0.02) return {arrow:'→',label:'steady'};
    return diff>0? {arrow:'▲',label:'rising'}:{arrow:'▼',label:'falling'};
  }catch{return {arrow:'→',label:'steady'};}
}
const FLOW_CLASS_THRESHOLDS = { too_low_max:200, novice_max:700, expert_max:1600, closed_min:2500 };

function classifyFlow(cfs, stage, floodStage){
  if(Number.isFinite(stage)&&Number.isFinite(floodStage)&&stage>=floodStage)
    return { label:"ACCESS CLOSED, STAY OFF THE RIVER!", severity:3 };
  if(!Number.isFinite(cfs)) return { label:"—", severity:-1 };
  const t=FLOW_CLASS_THRESHOLDS;
  if(cfs<t.too_low_max) return { label:"RIVER FLOW TOO LOW TO PADDLE", severity:0 };
  if(cfs<=t.novice_max) return { label:"LOW-MODERATE RIVER FLOW - BEGINNER TO NOVICE PADDLERS", severity:1 };
  if(cfs<=t.expert_max) return { label:"MODERATE-HIGH RIVER FLOW - EXPERT PADDLERS ONLY", severity:2 };
  if(cfs>=t.closed_min) return { label:"UNSAFE RIVER FLOW - ACCESS CLOSED, STAY OFF THE RIVER!", severity:3 };
  return { label:"EXPERT PADDLERS ONLY", severity:2 };
}

function groupBy3HourBlocks(stageArray){
  const map={};
  stageArray.forEach(pt=>{
    const d=new Date(pt.dateTime);
    const b=new Date(d.getFullYear(), d.getMonth(), d.getDate(), Math.floor(d.getHours()/3)*3, 0,0,0);
    const k=b.toISOString();
    if(!map[k]) map[k]={dateObj:b,sum:0,count:0};
    map[k].sum+=pt.stage; map[k].count+=1;
  });
  return Object.values(map).map(x=>({dateObj:x.dateObj,stage:x.sum/x.count})).sort((a,b)=>a.dateObj-b.dateObj);
}

function renderRiverGraph(points,flood,lastReadingStr){
  const container=document.getElementById("river-graph"); container.innerHTML="";
  if(!points.length) return;
  let minStage=Math.min(...points.map(d=>d.stage));
  let maxStage=Math.max(...points.map(d=>d.stage));
  maxStage=Math.max(maxStage,6); minStage=Math.min(minStage,flood); maxStage=Math.max(maxStage,flood);
  const range=(maxStage-minStage)||1;
  const minDate=points[0].dateObj, maxDate=points[points.length-1].dateObj;
  const total=maxDate-minDate;
  const W=1001, H=280, GH=180, GX=60, GW=W-GX-20;
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,"svg"); svg.setAttribute("width",W); svg.setAttribute("height",H); svg.setAttribute("viewBox",`0 0 ${W} ${H}`);

  const yLab=document.createElementNS(svgNS,"text");
  yLab.setAttribute("x",25); yLab.setAttribute("y",H/2+30);
  yLab.setAttribute("font-size","18"); yLab.setAttribute("font-weight","bold"); yLab.setAttribute("fill","black"); yLab.setAttribute("text-anchor","start");
  yLab.setAttribute("transform",`rotate(-90 25,${H/2+30})`); yLab.textContent="Water Level (ft)"; svg.appendChild(yLab);

  const scaleX=(d)=> GX + ((d-minDate)/total)*GW - 20;
  const scaleY=(s)=> GH - ((s-minStage)/range)*GH + 20;

  const startTick=Math.floor(minStage), endTick=Math.ceil(maxStage);
  for(let t=startTick;t<=endTick;t++){
    const frac=(maxStage-t)/range; const y=20+frac*GH;
    const line=document.createElementNS(svgNS,"line"); line.setAttribute("x1",GX-5); line.setAttribute("x2",GX); line.setAttribute("y1",y); line.setAttribute("y2",y); line.setAttribute("stroke","black"); line.setAttribute("stroke-width","1"); svg.appendChild(line);
    const lab=document.createElementNS(svgNS,"text"); lab.setAttribute("x",GX-10); lab.setAttribute("y",y+4); lab.setAttribute("font-size","21"); lab.setAttribute("fill","black"); lab.setAttribute("text-anchor","end"); lab.textContent=t.toFixed(0); svg.appendChild(lab);
  }

  const pathD = points.map((pt,i)=> (i===0?'M':'L') + scaleX(pt.dateObj) + ',' + scaleY(pt.stage)).join(' ');
  const path = document.createElementNS(svgNS,"path"); path.setAttribute("d",pathD); path.setAttribute("stroke","black"); path.setAttribute("fill","none"); path.setAttribute("stroke-width","6.6"); svg.appendChild(path);

  const fy=scaleY(flood);
  const fLine=document.createElementNS(svgNS,"line"); fLine.setAttribute("x1",GX); fLine.setAttribute("x2",GX+GW); fLine.setAttribute("y1",fy); fLine.setAttribute("y2",fy); fLine.setAttribute("stroke","black"); fLine.setAttribute("stroke-dasharray","6,3"); fLine.setAttribute("stroke-width","4"); svg.appendChild(fLine);

  const fLabel=document.createElementNS(svgNS,"text"); fLabel.setAttribute("x",GX+GW-10); fLabel.setAttribute("y",fy-10); fLabel.setAttribute("font-size","32"); fLabel.setAttribute("font-weight","bold"); fLabel.setAttribute("fill","black"); fLabel.setAttribute("text-anchor","end"); fLabel.textContent="Flood Stage"; svg.appendChild(fLabel);

  const minLab=minDate.toLocaleDateString(undefined,{month:'short',day:'numeric'}); let lastDay="";
  points.forEach((pt,i)=>{
    const x=scaleX(pt.dateObj), y=scaleY(pt.stage);
    const dot=document.createElementNS(svgNS,"circle"); dot.setAttribute("cx",x); dot.setAttribute("cy",y); dot.setAttribute("r",3); dot.setAttribute("fill","black"); svg.appendChild(dot);
    const day=pt.dateObj.toLocaleDateString(undefined,{month:'short',day:'numeric'});
    if(day!==minLab && day!==lastDay){
      lastDay=day; const dl=document.createElementNS(svgNS,"text"); dl.setAttribute("x",x); dl.setAttribute("y",240); dl.setAttribute("font-size","30"); dl.setAttribute("fill","black"); dl.setAttribute("text-anchor","middle"); dl.textContent=day; svg.appendChild(dl);
    }
    if(i===points.length-1){
      const tag=document.createElementNS(svgNS,"text");
      tag.setAttribute("x", x - 0.1*GW); tag.setAttribute("y", y + 45);
      tag.setAttribute("font-size","35"); tag.setAttribute("font-weight","bold"); tag.setAttribute("fill","white"); tag.setAttribute("text-anchor","middle");
      tag.textContent=` ${lastReadingStr} `;
      const rect=document.createElementNS(svgNS,"rect");
      setTimeout(()=>{ const b=tag.getBBox(); rect.setAttribute("x",b.x-5); rect.setAttribute("y",b.y); rect.setAttribute("width",b.width+10); rect.setAttribute("height",b.height); rect.setAttribute("fill","black"); svg.insertBefore(rect,tag); },0);
      svg.appendChild(tag);
    }
  });

  container.appendChild(svg);
  setTimeout(fitCardsToViewport,0);
}

function fetchRiverData(){
  const end=new Date(), start=new Date(); start.setDate(end.getDate()-4);
  const format=d=>d.toISOString().split('.')[0];
  const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065,00060&startDT=${format(start)}&endDT=${format(end)}&siteStatus=all`;

  fetch(url).then(r=>r.json()).then(data=>{
    const series=data?.value?.timeSeries||[];
    const findS=(code)=>series.find(s=>s?.variable?.variableCode?.[0]?.value===code);
    const sStage=findS("00065"), sFlow=findS("00060");

    const siteProps=sStage?.sourceInfo?.siteProperty || sFlow?.sourceInfo?.siteProperty;
    if(siteProps){ siteProps.forEach(p=>{ if(p.propertyName==="floodStage"){ const n=parseFloat(p.value); if(Number.isFinite(n)) floodThreshold=n; } }); }

    const stageRaw=sStage?.values?.[0]?.value||[];
    const stageValues=stageRaw.map(v=>({dateTime:v.dateTime, stage:parseFloat(v.value)})).filter(pt=>Number.isFinite(pt.stage));
    const flowRaw=sFlow?.values?.[0]?.value||[];
    const flowValues=flowRaw.map(v=>({dateTime:v.dateTime, flow:parseFloat(v.value)})).filter(pt=>Number.isFinite(pt.flow));

    const stageEl=document.getElementById('river-stage-line');
    const flowEl=document.getElementById('river-flow-line');
    const padEl=document.getElementById('paddle-advisory');

    if(stageValues.length===0){
      stageEl.textContent='Stage: —'; flowEl.textContent='Discharge: —'; padEl.textContent='—';
      document.getElementById('flood-status').textContent='No river data available';
      return;
    }

    const lastStage = stageValues[stageValues.length-1].stage;
    const lastStageStr = `${lastStage.toFixed(2)} ft`;
    const lastFlow = flowValues.length? flowValues[flowValues.length-1].flow : NaN;
    const lastFlowStr = Number.isFinite(lastFlow)? `${Math.round(lastFlow)} cfs` : '—';

    const stageTrend=computeStageTrend(stageValues);
    const flowTrend=computeFlowTrend(flowValues);

    stageEl.textContent = `Stage: ${lastStageStr} ${stageTrend.arrow} ${stageTrend.label}`;
    flowEl.textContent  = `Discharge: ${lastFlowStr} ${flowTrend.arrow} ${flowTrend.label}`;
    document.getElementById("river-timestamp").textContent = "Last updated: " + fmtDateTime();

    const classif = classifyFlow(lastFlow, lastStage, floodThreshold);
    padEl.textContent = classif.label;
    padEl.style.display = "inline-block";

    const statusEl=document.getElementById("flood-status");
    if(lastStage>=floodThreshold){
      statusEl.textContent="FLOOD LEVELS UNSAFE, ACCESS CLOSED";
      statusEl.style.fontSize="48px";
      statusEl.style.backgroundColor="#000"; statusEl.style.color="#fff";
      statusEl.style.textTransform="uppercase"; statusEl.style.padding="5px";
    }else{
      statusEl.innerHTML=`RIVER BELOW FLOOD STAGE ${getThumbUpSVG(48)}`;
      statusEl.style.fontSize="48px";
      statusEl.style.backgroundColor="white"; statusEl.style.color="black";
      statusEl.style.textTransform="uppercase"; statusEl.style.padding="3px";
    }

    const grouped=groupBy3HourBlocks(stageValues);
    renderRiverGraph(grouped, floodThreshold, lastStageStr);
  }).catch(err=>{
    document.getElementById('flood-status').textContent='Error fetching data';
    document.getElementById('river-stage-line').textContent='Stage: —';
    document.getElementById('river-flow-line').textContent='Discharge: —';
    const padEl=document.getElementById('paddle-advisory'); padEl.textContent='—'; padEl.style.backgroundColor="#000"; padEl.style.color="#fff";
  });
}

/* =================== PARK STATUS (OPEN/CLOSED) =================== */
function updateParkStatus(){
  const now=new Date();
  const {h:oh,m:om} = parseHHMM(PARK_HOURS.open);
  const {h:ch,m:cm} = parseHHMM(PARK_HOURS.close);

  const todayOpen  = new Date(now); todayOpen.setHours(oh,om,0,0);
  const todayClose = new Date(now); todayClose.setHours(ch,cm,0,0);

  let isOpen = within(now,todayOpen,todayClose);
  let nextLabel="—", todayLabel=`${fmtTime(todayOpen)} – ${fmtTime(todayClose)}`;

  if(isOpen){
    nextLabel = `Closes at ${fmtTime(todayClose)} (${diffHM(now,todayClose)} left)`;
  }else{
    if(now < todayOpen){
      nextLabel = `Opens at ${fmtTime(todayOpen)} (in ${diffHM(now,todayOpen)})`;
    }else{
      const tomorrowOpen = new Date(todayOpen); tomorrowOpen.setDate(tomorrowOpen.getDate()+1);
      nextLabel = `Opens tomorrow at ${fmtTime(tomorrowOpen)} (in ${diffHM(now,tomorrowOpen)})`;
    }
  }

  const banner=document.getElementById('park-status-banner');
  banner.textContent = isOpen ? "OPEN / ABIERTO" : "CLOSED / CERRADO";
  banner.style.background = getComputedStyle(document.documentElement).getPropertyValue('--accent-gray'); // ensure gray
  banner.style.color = "#fff";

  document.getElementById('park-today').textContent = `Today: ${todayLabel}`;
  document.getElementById('park-next').textContent  = `Next: ${nextLabel}`;
  document.getElementById('park-status-timestamp').textContent = "Last updated: " + fmtDateTime();
}

/* =================== FITTER =================== */
const VIEWPORT_W = 1440, VIEWPORT_H = 2560;
const CARD_PRIORITY = ['park-status-section','alerts-section','weather-section','rainfall-forecast','river-section','aqi-section','swim-us64'];
const ALWAYS_KEEP_FIRST = 3;

function cardPriority(el){ const id=el.id||''; const idx=CARD_PRIORITY.indexOf(id); return idx===-1?999:idx; }
function outerHeight(el){ const cs=getComputedStyle(el); return el.getBoundingClientRect().height + (parseFloat(cs.marginTop)||0) + (parseFloat(cs.marginBottom)||0); }

function fitCardsToViewport(){
  const header=document.getElementById('header'); const container=document.querySelector('.container');
  if(!header||!container) return;
  const cs=getComputedStyle(container); const padTop=parseFloat(cs.paddingTop)||0; const padBottom=parseFloat(cs.paddingBottom)||0; const gap=parseFloat(cs.rowGap||cs.gap)||0;
  const cards=[...container.querySelectorAll('.section')];
  cards.forEach(c=>c.style.display='flex');

  function total(){
    let used=header.offsetHeight+padTop+padBottom;
    const vis=cards.filter(c=>c.style.display!=='none');
    vis.forEach((c,i)=>{ used+=outerHeight(c); if(i>0) used+=gap; });
    return used;
  }

  while(total()>VIEWPORT_H){
    const cand=cards.filter(c=>c.style.display!=='none').filter(c=>cardPriority(c)>=ALWAYS_KEEP_FIRST).sort((a,b)=>cardPriority(b)-cardPriority(a));
    if(!cand.length) break; cand[0].style.display='none';
  }
}
function fitNowAndLater(){ [0,80,600,1600].forEach(ms=>setTimeout(fitCardsToViewport,ms)); }
if(document.fonts&&document.fonts.ready){ document.fonts.ready.then(()=>fitNowAndLater()); }

/* =================== MASTER REFRESH =================== */
function fetchAllData(){
  updateParkStatus();
  fetchRiverData();
  fetchAQIData();
  fetchNWSData();
  fitNowAndLater();
}
window.onload=()=>{ fetchAllData(); fitNowAndLater(); };
setInterval(fetchAllData, 10*60*1000);
</script>
</body>
</html>
