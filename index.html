<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- @import must be at the very top -->
  <style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

  :root{
    --ink:#000;
    --bg:#f0f0f0;
    --card:#fff;
    --border:#000;
    --muted:#444;
    --gray:#d8d8d8;            /* used for Park banner + river graph bg */
    --stamp:#222;
  }

  html,body{
    margin:0; padding:0;
    width:1440px; height:2560px; overflow:hidden;
    background:var(--bg); color:var(--ink);
    font-family:'Roboto', Arial, sans-serif;
    -webkit-text-size-adjust:none;
  }

  /* ===== Header ===== */
  #header{
    background:#000; color:#fff;
    padding:10px 16px; position:relative;
    display:flex; align-items:center; justify-content:center;
  }
  #header .logo{
    position:absolute; left:10px; top:6px;
    width:60px; height:60px; object-fit:contain;
  }
  #header .titlewrap{
    text-align:center;
  }
  #site-title{
    font-size:40px; font-weight:700; line-height:1.1;
  }
  #site-coords{
    font-size:18px; font-weight:700; opacity:.9;
  }

  .container{ padding:32px; display:flex; flex-direction:column; gap:14px; }

  /* ===== Cards ===== */
  .section{
    border:4px solid var(--border);
    border-radius:8px; background:var(--card);
    display:flex; flex-direction:column; position:relative;
  }
  .card-title{
    font-size:28px; font-weight:700; color:#fff;
    background:#000; padding:6px 8px; text-align:left;
  }
  .section-content{ padding:10px 12px; }

  .card-timestamp{
    color:var(--stamp); font-size:18px;
    text-align:right; padding:6px 12px 10px 12px;
  }
  .source-note{ font-size:14px; color:var(--muted); text-align:right; padding:0 12px; }

  /* ===== Park Status ===== */
  #park-banner{
    margin:10px 12px 8px 12px;
    background:var(--gray);
    color:#000; font-weight:700; font-size:64px;
    border-radius:6px; text-align:center; padding:10px 12px;
  }
  #park-hours-line{
    display:flex; justify-content:space-between; align-items:center;
    font-size:18px; padding:0 12px 6px 12px;
  }
  /* ===== Alerts ===== */
  #alert-message{ text-align:center; font-weight:700; white-space:pre-wrap; }

  /* ===== Weather ===== */
  #weather-section .section-content{
    display:flex; flex-direction:row; align-items:flex-start; gap:20px;
  }
  #weather-left{ width:33%; min-width:360px; display:flex; align-items:center; gap:14px; }
  #weather-icon{ width:126px; height:126px; }
  #weather-temp-F{ font-size:100px; font-weight:700; line-height:1; }
  #weather-temp-C{ font-size:46px; font-weight:700; margin-top:6px; }

  #weather-right{ width:67%; display:grid; grid-template-columns:1fr 1fr; gap:8px 40px; }
  #weather-right div{ font-size:22px; font-weight:400; color:#000; }
  #weather-right .muted{ color:var(--muted); }

  /* ===== River ===== */
  .river-header{ composes: card-title; }
  #river-topline{
    display:flex; justify-content:center; align-items:center; gap:12px;
    font-size:32px; font-weight:700; padding-top:6px;
  }
  #thumb{ font-size:32px; }
  #flow-pill{
    background:#000; color:#fff; font-weight:700; border-radius:6px;
    padding:6px 10px; display:inline-block;
  }
  #river-graph{
    background:var(--gray);
    margin:12px auto 0 auto;
    width:1080px; position:relative;
    padding-left:calc(5% - 4px);
  }
  #river-stats{
    text-align:center; margin:12px 0 0 0; font-size:26px; color:#000;
  }
  #river-stats b{ font-weight:700; }

  #usgs-site-info{ font-size:16px; color:#000; text-align:right; padding:0 12px; }

  /* ===== Forecast ===== */
  #forecast-lines{ text-align:center; }
  #forecast-lines div{ font-size:22px; font-weight:700; }

  /* ===== AQI ===== */
  #aqi-content{ text-align:center; padding-top:6px; }
  #aqi-row{
    display:flex; align-items:center; justify-content:center; gap:30px; flex-wrap:wrap;
  }
  #aqi-gauge-container{ width:420px; height:220px; }
  #aqi-classification{ font-size:22px; font-weight:700; }
  #aqi-measurement{ font-size:22px; font-weight:700; }

  /* Center helpers where needed */
  .center{text-align:center;}
  </style>
</head>
<body>
  <!-- Header -->
  <div id="header">
    <img class="logo" src="catham-logo.jpg" alt="Chatham County" />
    <div class="titlewrap">
      <div id="site-title">US 64 Haw River Access, 348 River Access Rd</div>
      <div id="site-coords"><span id="header-lat">35.730995</span> / <span id="header-lon">-79.107109</span></div>
    </div>
  </div>

  <div class="container">
    <!-- Park Status -->
    <div class="section" id="park-card">
      <div class="card-title">Park Status</div>
      <div id="park-banner">OPEN / ABIERTO</div>
      <div id="park-hours-line">
        <div id="park-today">Today: ‚Äî</div>
        <div id="park-next">Next: ‚Äî</div>
      </div>
      <div class="card-timestamp" id="park-timestamp">Last updated: --</div>
    </div>

    <!-- Alerts -->
    <div class="section" id="alerts-section">
      <div class="card-title">Alerts</div>
      <div class="section-content">
        <div id="alert-message">No alerts at this time / Sin alertas en este momento</div>
      </div>
      <div class="card-timestamp" id="alerts-timestamp">Last updated: --</div>
    </div>

    <!-- Weather -->
    <div class="section" id="weather-section">
      <div class="card-title">Current Weather Conditions</div>
      <div class="section-content">
        <div id="weather-left">
          <div id="weather-icon"></div>
          <div>
            <div id="weather-temp-F">--¬∞F</div>
            <div id="weather-temp-C">--¬∞C</div>
          </div>
        </div>
        <div id="weather-right">
          <div id="sunrise">Sunrise: ‚Äî</div>
          <div id="wx-forecast">‚Äî</div>
          <div id="sunset">Sunset: ‚Äî</div>
          <div id="uv-index">UV Index: ‚Äî</div>
          <div id="wind">Wind: ‚Äî</div>
          <div id="humidity">Humidity: ‚Äî</div>
          <div id="feels">Feels like: ‚Äî</div>
          <div id="dew">Dew point: ‚Äî</div>
        </div>
      </div>
      <div class="source-note" id="weather-source">Source: ‚Äî</div>
      <div class="card-timestamp" id="weather-timestamp">Last updated: --</div>
    </div>

    <!-- River -->
    <div class="section" id="river-section">
      <div class="card-title">River Water Level & Flow</div>
      <div class="section-content">
        <div id="river-topline">
          <div id="flood-status">‚Äî</div>
          <div id="thumb">üëç</div>
          <div id="flow-pill">‚Äî</div>
        </div>
        <div id="river-graph"></div>
        <div id="river-stats"><b>Stage:</b> ‚Äî  ‚Ä¢  <b>Discharge:</b> ‚Äî</div>
      </div>
      <div id="usgs-site-info">USGS Site #02096960</div>
      <div class="card-timestamp" id="river-timestamp">Last updated: --</div>
    </div>

    <!-- Forecast -->
    <div class="section" id="forecast-card">
      <div class="card-title">Forecast</div>
      <div class="section-content center" id="forecast-lines">
        <div id="forecast-1">‚Äî</div>
        <div id="forecast-2">‚Äî</div>
      </div>
      <div class="card-timestamp" id="forecast-timestamp">Last updated: --</div>
    </div>

    <!-- AQI -->
    <div class="section" id="aqi-section">
      <div class="card-title">Air Quality Index</div>
      <div class="section-content" id="aqi-content">
        <div id="aqi-row">
          <div id="aqi-classification">‚Äî</div>
          <div id="aqi-gauge-container"></div>
          <div id="aqi-measurement">AQI: ‚Äî</div>
        </div>
        <div class="center" id="aqi-guidance">‚Äî</div>
        <div class="center" id="aqi-breakdown" style="margin-top:6px;">‚Äî</div>
      </div>
      <div class="source-note" id="aqi-source">Source: ‚Äî</div>
      <div class="card-timestamp" id="aqi-timestamp">Last updated: --</div>
    </div>
  </div>

<script>
/* ======================= CONFIG ======================= */
const LAT = 35.730995, LON = -79.107109;   // US-64 site
document.getElementById('header-lat').textContent = LAT.toFixed(6);
document.getElementById('header-lon').textContent = LON.toFixed(6);

const TIME_ZONE = 'America/New_York';
const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B';
const USGS_SITE = '02096960';

/* Park hours (editable). Day of week: 0=Sun ... 6=Sat */
const PARK_HOURS = {
  0:{open:'08:00', close:'19:00'},
  1:{open:'08:00', close:'19:00'},
  2:{open:'08:00', close:'19:00'},
  3:{open:'08:00', close:'19:00'},
  4:{open:'08:00', close:'19:00'},
  5:{open:'08:00', close:'19:00'},
  6:{open:'08:00', close:'19:00'}
};

/* Refresh cadence (minutes). Set to 0 to disable auto-refresh. */
const REFRESH_MINUTES = 10;

/* ====================== HELPERS ======================= */
const fmtDateTime = (d=new Date()) =>
  new Intl.DateTimeFormat('en-US',{dateStyle:'short', timeStyle:'short', timeZone:TIME_ZONE}).format(d);
const fmtTime = (d) =>
  new Intl.DateTimeFormat('en-US',{hour:'numeric', minute:'numeric', timeZone:TIME_ZONE}).format(d);

function parseHM(str){ const [H,M]=str.split(':').map(Number); return {H,M}; }
function atLocal(date, hm){
  const d = new Date(date);
  d.setHours(hm.H, hm.M, 0, 0);
  return d;
}
function minToCountdown(ms){
  const m = Math.max(0, Math.round(ms/60000));
  const h = Math.floor(m/60), mm = m%60;
  if (h>0) return `${h}h ${mm}m left`;
  return `${mm}m left`;
}
function setStamp(id){ const el=document.getElementById(id); if(el) el.textContent = 'Last updated: '+fmtDateTime(); }

/* Simple weather icon */
function getWeatherIcon(forecast=''){
  forecast = forecast.toLowerCase();
  let svg = '';
  if (forecast.includes('sunny') || forecast.includes('clear')) {
    svg = `<svg width="126" height="126" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="12" fill="black" stroke="black" stroke-width="3"/>
      <g stroke="black" stroke-width="3">
        <line x1="32" y1="4"  x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="60"/>
        <line x1="4"  y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="60" y2="32"/>
      </g></svg>`;
  } else if (forecast.includes('rain') || forecast.includes('showers')) {
    svg = `<svg width="126" height="126" viewBox="0 0 64 64">
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/>
      <g stroke="black" stroke-width="3">
        <line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/>
      </g></svg>`;
  } else if (forecast.includes('cloud')) {
    svg = `<svg width="126" height="126" viewBox="0 0 64 64">
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
  } else {
    svg = `<svg width="126" height="126" viewBox="0 0 64 64">
      <circle cx="22" cy="22" r="10" fill="black" stroke="black" stroke-width="3"/>
      <path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
  }
  return svg;
}

/* ===================== PARK STATUS ==================== */
function updateParkStatus(){
  const now = new Date();
  const dow = new Intl.DateTimeFormat('en-US',{timeZone:TIME_ZONE, weekday:'short'}).format(now); // not used, for editors
  const tzNow = new Date(fmtDateTime(now)); // forces TZ render baseline

  const dowIdx = new Intl.DateTimeFormat('en-US',{timeZone:TIME_ZONE, weekday:'short'}).formatToParts(now);
  const jsDow = new Date(now.toLocaleString('en-US',{timeZone:TIME_ZONE})).getDay(); // 0..6

  const todays = PARK_HOURS[jsDow];
  const openT  = atLocal(new Date(now.toLocaleString('en-US',{timeZone:TIME_ZONE})), parseHM(todays.open));
  const closeT = atLocal(new Date(now.toLocaleString('en-US',{timeZone:TIME_ZONE})), parseHM(todays.close));

  const isOpen = (now >= openT && now < closeT);

  const banner = document.getElementById('park-banner');
  banner.textContent = isOpen ? 'OPEN / ABIERTO' : 'CLOSED / CERRADO';

  document.getElementById('park-today').textContent =
    `Today: ${fmtTime(openT)} ‚Äî ${fmtTime(closeT)}`;

  // Next event
  let nextLabel='', nextTime;
  if (isOpen){
    nextLabel = 'Closes at ';
    nextTime = closeT;
  } else {
    // if before open -> opens today, else opens tomorrow
    const targetDay = (now < openT) ? now : new Date(now.getTime()+86400000);
    const openNext = PARK_HOURS[new Date(targetDay.toLocaleString('en-US',{timeZone:TIME_ZONE})).getDay()].open;
    nextTime = atLocal(targetDay, parseHM(openNext));
    nextLabel = 'Opens at ';
  }
  const eta = minToCountdown(nextTime - now);
  document.getElementById('park-next').textContent = `Next: ${nextLabel}${fmtTime(nextTime)} (${eta})`;
  setStamp('park-timestamp');
}

/* ======================== AQI ======================== */
function aqiCategoryFromValue(n){
  if (n<=50) return 'GOOD';
  if (n<=100) return 'MODERATE';
  if (n<=150) return 'UNHEALTHY FOR SENSITIVE GROUPS';
  if (n<=200) return 'UNHEALTHY';
  if (n<=300) return 'VERY UNHEALTHY';
  return 'HAZARDOUS';
}
function aqiGuidance(cat){
  const c=cat.toLowerCase();
  if (c==='good') return 'Air quality is satisfactory; great for outdoor activities.';
  if (c==='moderate') return 'Okay for most; unusually sensitive people may shorten outdoor exertion.';
  if (c.includes('sensitive')) return 'Sensitive groups should reduce prolonged or heavy outdoor exertion.';
  if (c==='unhealthy') return 'Everyone may feel effects; sensitive groups should avoid prolonged exertion.';
  if (c.includes('very')) return 'Health alert: consider limiting outdoor activity; sensitive groups should avoid it.';
  return 'Emergency conditions: everyone should avoid all outdoor exertion.';
}

/* Gauge: semicircle with shaded wedge + pointer */
function drawAQIGauge(value){
  const min=0,max=300;
  const v = Math.max(min, Math.min(max, value));
  const ratio = v/max;             // 0..1 maps to 0..180 degrees
  const deg = 180*ratio;

  const w=420,h=220,cx=210,cy=210,r=180;
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  svg.setAttribute('width',w); svg.setAttribute('height',h);
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);

  // Arc outline
  const arc = document.createElementNS(svgNS,'path');
  arc.setAttribute('d', describeArc(cx,cy,r,180,0));
  arc.setAttribute('fill','none'); arc.setAttribute('stroke','black'); arc.setAttribute('stroke-width','8');
  svg.appendChild(arc);

  // Shaded wedge (0 -> value)
  const fill = document.createElementNS(svgNS,'path');
  fill.setAttribute('d', describeWedge(cx,cy,r-6,180,180-deg));
  fill.setAttribute('fill','#bdbdbd'); // gray fill
  fill.setAttribute('stroke','black'); fill.setAttribute('stroke-width','2');
  svg.appendChild(fill);

  // Pointer
  const ang = Math.PI*(1 - ratio); // radians where 180deg=left, 0deg=right
  const px = cx + (r-20)*Math.cos(ang);
  const py = cy + (r-20)*Math.sin(ang);
  const pointer = document.createElementNS(svgNS,'line');
  pointer.setAttribute('x1',cx); pointer.setAttribute('y1',cy);
  pointer.setAttribute('x2',px); pointer.setAttribute('y2',py);
  pointer.setAttribute('stroke','black'); pointer.setAttribute('stroke-width','8'); pointer.setAttribute('stroke-linecap','round');
  svg.appendChild(pointer);

  const host=document.getElementById('aqi-gauge-container');
  host.innerHTML=''; host.appendChild(svg);

  // path helpers
  function polarToCartesian(cx, cy, r, angleDeg){
    const rad = (angleDeg-90) * Math.PI/180.0;
    return { x: cx + (r*Math.cos(rad)), y: cy + (r*Math.sin(rad)) };
  }
  function describeArc(cx,cy,r,startAngle,endAngle){
    const start = polarToCartesian(cx,cy,r,endAngle);
    const end   = polarToCartesian(cx,cy,r,startAngle);
    const large = endAngle - startAngle <= 180 ? '0' : '1';
    return `M ${start.x} ${start.y} A ${r} ${r} 0 ${large} 0 ${end.x} ${end.y}`;
  }
  function describeWedge(cx,cy,r,fromDeg,toDeg){
    const start = polarToCartesian(cx,cy,r,toDeg);
    const end   = polarToCartesian(cx,cy,r,fromDeg);
    const large = (fromDeg - toDeg) <= 180 ? '0' : '1';
    return `M ${cx} ${cy} L ${start.x} ${start.y} A ${r} ${r} 0 ${large} 0 ${end.x} ${end.y} Z`;
  }
}

async function fetchAQI(){
  // Try AirNow (often blocked by CORS in browser); fall back to Open-Meteo
  try{
    const url=`https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}&_=${Date.now()}`;
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error('AirNow '+r.status);
    const data=await r.json();
    const rows=Array.isArray(data)?data.filter(x=>Number.isFinite(+x.AQI)):[];
    if(!rows.length) throw new Error('No AirNow rows');

    const best=rows.sort((a,b)=>(+b.AQI)-(+a.AQI))[0];
    const aqi=Math.round(+best.AQI);
    const cat=best.Category?.Name?.toUpperCase() || aqiCategoryFromValue(aqi);
    drawAQIGauge(aqi);
    document.getElementById('aqi-classification').textContent=cat;
    document.getElementById('aqi-measurement').textContent=`AQI: ${aqi}`;
    document.getElementById('aqi-guidance').textContent=aqiGuidance(cat);
    // breakdown
    const by={}; rows.forEach(r=>{ by[r.ParameterName]=Math.round(+r.AQI); });
    const parts=[];
    if(by['PM2.5']!=null) parts.push(`PM2.5 ${by['PM2.5']}`);
    if(by['PM10']!=null)  parts.push(`PM10 ${by['PM10']}`);
    if(by['O3']!=null)    parts.push(`O‚ÇÉ ${by['O3']}`);
    document.getElementById('aqi-breakdown').textContent = parts.length?parts.join(' ‚Ä¢ '):'‚Äî';
    document.getElementById('aqi-source').textContent=`Source: AirNow ‚Ä¢ As of ${fmtDateTime()}`;
  }catch(e){
    // Open-Meteo fallback
    const url=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto&_=${Date.now()}`;
    const r=await fetch(url,{cache:'no-store'}); const d=await r.json();
    const times=d?.hourly?.time||[], vals=d?.hourly?.us_aqi||[];
    let idx=times.length-1, now=new Date();
    for(let i=times.length-1;i>=0;i--){ if(new Date(times[i])<=now){ idx=i; break; } }
    const aqi=Math.round(+vals[idx]||0);
    drawAQIGauge(aqi);
    const cat=aqiCategoryFromValue(aqi);
    document.getElementById('aqi-classification').textContent=cat;
    document.getElementById('aqi-measurement').textContent=`AQI: ${aqi}`;
    document.getElementById('aqi-guidance').textContent=aqiGuidance(cat);
    const fmt = n=>Number.isFinite(+n)?Math.round(+n):'‚Äî';
    const b = `PM2.5 ${fmt(d?.hourly?.pm2_5?.[idx])} ¬µg/m¬≥ ‚Ä¢ PM10 ${fmt(d?.hourly?.pm10?.[idx])} ¬µg/m¬≥ ‚Ä¢ O‚ÇÉ ${fmt(d?.hourly?.ozone?.[idx])} ¬µg/m¬≥`;
    document.getElementById('aqi-breakdown').textContent=b;
    document.getElementById('aqi-source').textContent=`Source: Open-Meteo (US AQI) ‚Ä¢ As of ${fmtDateTime(new Date(times[idx]))}`;
  }
  setStamp('aqi-timestamp');
}

/* ======================== WEATHER ===================== */
function parseWindMph(w){ const m=String(w||'').match(/[\d.]+/); return m?+m[0]:0; }
function fToC(f){ return (f-32)*5/9; }
function cToF(c){ return (c*9/5)+32; }
function dewPointF(Tf,RH){
  const T=fToC(Tf), R=Math.max(1e-6,Math.min(100,RH))/100;
  const b=17.62, c=243.12; const g=Math.log(R)+(b*T)/(c+T);
  return cToF((c*g)/(b-g));
}
function windChillF(T,V){ return 35.74+0.6215*T-35.75*Math.pow(V,0.16)+0.4275*T*Math.pow(V,0.16); }
function heatIndexF(T,R){ const c1=-42.379,c2=2.04901523,c3=10.14333127,c4=-0.22475541,c5=-0.00683783,c6=-0.05481717,c7=0.00122874,c8=0.00085282,c9=-0.00000199;
  let HI=c1+c2*T+c3*R+c4*T*R+c5*T*T+c6*R*R+c7*T*T*R+c8*T*R*R+c9*T*T*R*R;
  if(R<13 && T>=80 && T<=112) HI -= ((13-R)/4)*Math.sqrt((17-Math.abs(T-95))/17);
  if(R>85 && T>=80 && T<=87)  HI += ((R-85)/10)*((87-T)/5);
  return HI;
}
function feelsLikeF(T,R,V){ if(T<=50 && V>=3) return windChillF(T,V); if(T>=80 && R>=40) return heatIndexF(T,R); return T; }

async function fetchUVIndex(){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto&_=${Date.now()}`;
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error();
    const d=await r.json(); const times=d?.hourly?.time||[], vals=d?.hourly?.uv_index||[];
    let idx=times.length-1, now=new Date();
    for(let i=times.length-1;i>=0;i--){ if(new Date(times[i])<=now){ idx=i; break; } }
    return Math.max(0, Math.round(vals[idx]??0));
  }catch{ return null; }
}

async function fetchWeather(){
  const pointURL=`https://api.weather.gov/points/${LAT},${LON}`;
  try{
    const pr = await fetch(pointURL,{cache:'no-store'});
    if(!pr.ok) throw new Error('NWS points '+pr.status);
    const point = await pr.json();
    const hoursURL = point.properties.forecastHourly;
    const gridURL  = point.properties.forecast;

    const [obsR, gridR] = await Promise.all([
      fetch(hoursURL,{cache:'no-store'}),
      fetch(gridURL,{cache:'no-store'})
    ]);

    let iconForecast=''; let tempF=null, rh=null, windStr='', wind=0;

    if (obsR.ok){
      const obs = await obsR.json();
      const now = obs.properties?.periods?.[0];
      if (now){
        tempF = Number(now.temperature);
        rh = now.relativeHumidity?.value!=null ? Number(now.relativeHumidity.value) : null;
        windStr = now.windSpeed || '0 mph';
        wind = parseWindMph(windStr);
        iconForecast = now.shortForecast || '';
        document.getElementById('weather-icon').innerHTML = getWeatherIcon(iconForecast);
        document.getElementById('weather-temp-F').textContent = Number.isFinite(tempF)?`${tempF}¬∞F`:'--¬∞F';
        document.getElementById('weather-temp-C').textContent = Number.isFinite(tempF)?`${( (tempF-32)*5/9 ).toFixed(1)}¬∞C`:'--¬∞C';
        document.getElementById('wind').textContent = `Wind: ${windStr}`;
        document.getElementById('humidity').textContent = `Humidity: ${Number.isFinite(rh)?Math.round(rh):'‚Äî'}%`;
      }
    }

    // grid forecast (two lines)
    if (gridR.ok){
      const grid = await gridR.json();
      const p = grid.properties?.periods||[];
      document.getElementById('forecast-1').textContent = p[0]?.name ? `${p[0].name}: ${p[0].shortForecast}` : '‚Äî';
      document.getElementById('forecast-2').textContent = p[1]?.name ? `${p[1].name}: ${p[1].shortForecast}` : '‚Äî';
      document.getElementById('wx-forecast').textContent = p[0]?.shortForecast || iconForecast || '‚Äî';
    }

    // UV index
    const UVI = await fetchUVIndex();
    document.getElementById('uv-index').textContent = `UV Index: ${UVI==null?'‚Äî':UVI}`;

    // sunrise/sunset
    fetchSunriseSunset();

    // feels like + dew
    if (Number.isFinite(tempF) && Number.isFinite(rh)){
      const feels = Math.round(feelsLikeF(tempF, rh, wind));
      const dew   = Math.round(dewPointF(tempF, rh));
      document.getElementById('feels').textContent = `Feels like: ${feels}¬∞F`;
      document.getElementById('dew').textContent   = `Dew point: ${dew}¬∞F`;
    } else {
      document.getElementById('feels').textContent = 'Feels like: ‚Äî';
      document.getElementById('dew').textContent   = 'Dew point: ‚Äî';
    }

    document.getElementById('weather-source').textContent = `Source: NWS + Open-Meteo (${LAT.toFixed(3)}, ${LON.toFixed(3)})`;
  }catch(e){
    // Fallback minimal (UV + sunrise/sunset still shown)
    document.getElementById('wx-forecast').textContent = '‚Äî';
    document.getElementById('weather-source').textContent = `Source: Open-Meteo (fallback)`;
    fetchSunriseSunset();
  }
  setStamp('weather-timestamp');
}

function fetchSunriseSunset(){
  const url=`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`;
  fetch(url).then(r=>r.json()).then(d=>{
    if(d.status==='OK'){
      const sr=new Date(d.results.sunrise), ss=new Date(d.results.sunset);
      document.getElementById('sunrise').textContent=`Sunrise: ${fmtTime(sr)}`;
      document.getElementById('sunset').textContent =`Sunset: ${fmtTime(ss)}`;
    }
  }).catch(()=>{});
}

/* ========================= RIVER ====================== */
const FLOW_CLASS_THRESHOLDS={ too_low_max:200, novice_max:700, expert_max:1600, closed_min:2500 };
function classifyFlow(cfs, stage, floodStage){
  if(Number.isFinite(stage) && Number.isFinite(floodStage) && stage>=floodStage)
    return { label:'ACCESS CLOSED, STAY OFF THE RIVER!', severity:3 };
  if(!Number.isFinite(cfs)) return { label:'‚Äî', severity:-1 };
  const t=FLOW_CLASS_THRESHOLDS;
  if(cfs<t.too_low_max) return {label:'RIVER FLOW TOO LOW TO PADDLE', severity:0};
  if(cfs<=t.novice_max) return {label:'LOW-MODERATE RIVER FLOW ‚Äì BEGINNER/NOVICE', severity:1};
  if(cfs<=t.expert_max) return {label:'MODERATE-HIGH RIVER FLOW ‚Äì EXPERT ONLY', severity:2};
  if(cfs>=t.closed_min) return {label:'UNSAFE RIVER FLOW ‚Äì ACCESS CLOSED', severity:3};
  return {label:'EXPERT PADDLERS ONLY', severity:2};
}

function groupBy3HourBlocks(arr){
  const map={};
  arr.forEach(pt=>{
    const d=new Date(pt.dateTime);
    const k = new Date(d.getFullYear(), d.getMonth(), d.getDate(), Math.floor(d.getHours()/3)*3).toISOString();
    (map[k]??=( {dateObj:new Date(k), sum:0, count:0} )).sum+=pt.stage, map[k].count++;
  });
  return Object.values(map).map(x=>({dateObj:x.dateObj, stage:x.sum/x.count})).sort((a,b)=>a.dateObj-b.dateObj);
}

function renderRiverGraph(points,flood,lastReadingStr){
  const container=document.getElementById('river-graph'); container.innerHTML='';
  if(!points.length) return;

  let minStage=Math.min(...points.map(p=>p.stage));
  let maxStage=Math.max(...points.map(p=>p.stage));
  maxStage=Math.max(maxStage,6); minStage=Math.min(minStage,flood); maxStage=Math.max(maxStage,flood);
  const range=(maxStage-minStage)||1;
  const minDate=points[0].dateObj, maxDate=points[points.length-1].dateObj;
  const total=maxDate-minDate;
  const svgW=1001, svgH=280, gH=180, offX=60, gW=svgW-offX-20;

  const NS='http://www.w3.org/2000/svg', svg=document.createElementNS(NS,'svg');
  svg.setAttribute('width',svgW); svg.setAttribute('height',svgH); svg.setAttribute('viewBox',`0 0 ${svgW} ${svgH}`);
  const yLabel=document.createElementNS(NS,'text');
  yLabel.setAttribute('x',25); yLabel.setAttribute('y',svgH/2+30);
  yLabel.setAttribute('font-size','18'); yLabel.setAttribute('font-weight','bold'); yLabel.setAttribute('fill','black');
  yLabel.setAttribute('text-anchor','start'); yLabel.setAttribute('transform',`rotate(-90 25,${svgH/2+30})`);
  yLabel.textContent='Water Level (ft)'; svg.appendChild(yLabel);

  const scaleX=(d)=> offX + ((d-minDate)/total)*gW - 20;
  const scaleY=(s)=> gH - ((s-minStage)/range)*gH + 20;

  for(let v=Math.floor(minStage); v<=Math.ceil(maxStage); v++){
    const y=20 + ((maxStage-v)/range)*gH;
    const tick=document.createElementNS(NS,'line');
    tick.setAttribute('x1',offX-5); tick.setAttribute('x2',offX);
    tick.setAttribute('y1',y); tick.setAttribute('y2',y);
    tick.setAttribute('stroke','black'); tick.setAttribute('stroke-width','1'); svg.appendChild(tick);
    const tl=document.createElementNS(NS,'text');
    tl.setAttribute('x',offX-10); tl.setAttribute('y',y+4); tl.setAttribute('font-size','21'); tl.setAttribute('text-anchor','end');
    tl.textContent=v.toFixed(0); svg.appendChild(tl);
  }

  const dPath=points.map((pt,i)=> (i?'L':'M')+scaleX(pt.dateObj)+','+scaleY(pt.stage) ).join(' ');
  const path=document.createElementNS(NS,'path');
  path.setAttribute('d',dPath); path.setAttribute('stroke','black'); path.setAttribute('fill','none'); path.setAttribute('stroke-width','6.6');
  svg.appendChild(path);

  const fy=scaleY(flood); const fline=document.createElementNS(NS,'line');
  fline.setAttribute('x1',offX); fline.setAttribute('x2',offX+gW); fline.setAttribute('y1',fy); fline.setAttribute('y2',fy);
  fline.setAttribute('stroke','black'); fline.setAttribute('stroke-dasharray','6,3'); fline.setAttribute('stroke-width','4'); svg.appendChild(fline);
  const flab=document.createElementNS(NS,'text');
  flab.setAttribute('x',offX+gW-10); flab.setAttribute('y',fy-10); flab.setAttribute('font-size','26'); flab.setAttribute('font-weight','700'); flab.setAttribute('text-anchor','end');
  flab.textContent='Flood Stage'; svg.appendChild(flab);

  // dots + last label
  points.forEach((pt,i)=>{
    const x=scaleX(pt.dateObj), y=scaleY(pt.stage);
    const dot=document.createElementNS(NS,'circle'); dot.setAttribute('cx',x); dot.setAttribute('cy',y); dot.setAttribute('r',3); dot.setAttribute('fill','black'); svg.appendChild(dot);
    if(i===points.length-1){
      const tag=document.createElementNS(NS,'text');
      tag.setAttribute('x', x-120); tag.setAttribute('y', y+45); tag.setAttribute('font-size','32'); tag.setAttribute('font-weight','700'); tag.setAttribute('fill','white');
      tag.setAttribute('text-anchor','middle'); tag.textContent=' '+lastReadingStr+' ';
      const rect=document.createElementNS(NS,'rect'); setTimeout(()=>{ const b=tag.getBBox(); rect.setAttribute('x',b.x-5); rect.setAttribute('y',b.y); rect.setAttribute('width',b.width+10); rect.setAttribute('height',b.height); rect.setAttribute('fill','black'); svg.insertBefore(rect,tag); },0);
      svg.appendChild(tag);
    }
  });

  container.appendChild(svg);
}

function computeTrend(vals, key, absThresh, pctThresh){
  try{
    if(!Array.isArray(vals)||vals.length<2) return {arrow:'‚Üí',label:'steady'};
    const lastT=new Date(vals[vals.length-1].dateTime).getTime();
    const start=lastT - 3*3600*1000;
    let subset = vals.filter(p=> new Date(p.dateTime).getTime()>=start );
    if(subset.length<2) subset = vals.slice(-6);
    const first=subset[0][key], last=subset[subset.length-1][key];
    const diff=last-first, pct=Math.abs(diff)/Math.max( key==='stage'?0.01:1, first );
    if(Math.abs(diff)<absThresh && pct<pctThresh) return {arrow:'‚Üí',label:'steady'};
    if(diff>0) return {arrow:'‚ñ≤',label:'rising'};
    return {arrow:'‚ñº',label:'falling'};
  }catch{ return {arrow:'‚Üí',label:'steady'} }
}

async function fetchRiver(){
  const end=new Date(), start=new Date(end.getTime()-4*24*3600*1000);
  const iso=(d)=> d.toISOString().split('.')[0];
  const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${USGS_SITE}&parameterCd=00065,00060&startDT=${iso(start)}&endDT=${iso(end)}&siteStatus=all`;
  try{
    const r=await fetch(url,{cache:'no-store'}); const data=await r.json();
    const ts=data?.value?.timeSeries||[];
    const sSeries=ts.find(s=>s?.variable?.variableCode?.[0]?.value==='00065');
    const qSeries=ts.find(s=>s?.variable?.variableCode?.[0]?.value==='00060');

    // flood stage (if provided)
    let flood=5.0; const props=sSeries?.sourceInfo?.siteProperty || qSeries?.sourceInfo?.siteProperty || [];
    props.forEach(p=>{ if(p.propertyName==='floodStage'){ const n=parseFloat(p.value); if(Number.isFinite(n)) flood=n; } });

    const stages=(sSeries?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, stage:+v.value})).filter(x=>Number.isFinite(x.stage));
    const flows=(qSeries?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, flow:+v.value})).filter(x=>Number.isFinite(x.flow));

    if(!stages.length){
      document.getElementById('flood-status').textContent='NO RIVER DATA';
      document.getElementById('flow-pill').textContent='‚Äî';
      document.getElementById('river-stats').innerHTML='<b>Stage:</b> ‚Äî  ‚Ä¢  <b>Discharge:</b> ‚Äî';
      setStamp('river-timestamp'); return;
    }

    const lastStage=stages[stages.length-1].stage;
    const lastFlow = flows.length ? flows[flows.length-1].flow : NaN;

    // Topline
    const floodText = (lastStage>=flood)?'FLOOD LEVELS UNSAFE, ACCESS CLOSED':'RIVER BELOW FLOOD STAGE';
    document.getElementById('flood-status').textContent=floodText;

    const cls=classifyFlow(lastFlow,lastStage,flood);
    const pill=document.getElementById('flow-pill'); pill.textContent=cls.label;

    // Stats
    const sTrend=computeTrend(stages,'stage',0.20,0.02);
    const qTrend=computeTrend(flows,'flow',30,0.05);
    const sStr = `${lastStage.toFixed(2)} ft  ${sTrend.arrow} ${sTrend.label}`;
    const qStr = Number.isFinite(lastFlow)?`${Math.round(lastFlow)} cfs  ${qTrend.arrow} ${qTrend.label}`:'‚Äî';
    document.getElementById('river-stats').innerHTML=`<b>Stage:</b> ${sStr}  ‚Ä¢  <b>Discharge:</b> ${qStr}`;

    // Graph
    const grouped = groupBy3HourBlocks(stages);
    renderRiverGraph(grouped, flood, `${lastStage.toFixed(2)} ft`);
  }catch(e){
    document.getElementById('flood-status').textContent='Error fetching data';
    document.getElementById('flow-pill').textContent='‚Äî';
    document.getElementById('river-stats').innerHTML='<b>Stage:</b> ‚Äî  ‚Ä¢  <b>Discharge:</b> ‚Äî';
  }
  setStamp('river-timestamp');
  document.getElementById('usgs-site-info').textContent = `USGS Site #${USGS_SITE}`;
}

/* ===================== Forecast (2 lines) ============== */
async function fetchForecastOnly(){
  try{
    const pointURL=`https://api.weather.gov/points/${LAT},${LON}`;
    const pr=await fetch(pointURL,{cache:'no-store'});
    if(!pr.ok) throw new Error();
    const point=await pr.json();
    const gridR=await fetch(point.properties.forecast,{cache:'no-store'});
    if(gridR.ok){
      const grid=await gridR.json(); const p=grid.properties?.periods||[];
      document.getElementById('forecast-1').textContent = p[0]?.name ? `${p[0].name}: ${p[0].shortForecast}` : '‚Äî';
      document.getElementById('forecast-2').textContent = p[1]?.name ? `${p[1].name}: ${p[1].shortForecast}` : '‚Äî';
    }
  }catch{}
  setStamp('forecast-timestamp');
}

/* ===================== Sunrise/Sunset ================== */
// (already called inside weather flow)

/* ===================== MASTER REFRESH ================== */
async function fetchAll(){
  updateParkStatus();
  await Promise.all([ fetchAQI(), fetchWeather(), fetchRiver(), fetchForecastOnly() ]);
}

window.onload = () => {
  fetchAll();
  if (REFRESH_MINUTES>0) setInterval(fetchAll, REFRESH_MINUTES*60*1000);
};
</script>
</body>
</html>
