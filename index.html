<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Roboto first to stabilize layout metrics -->
  <style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

  :root{
    --ink:#000;
    --bg:#f0f0f0;
    --card:#fff;
    --gray:#d9d9d9;               /* light gray used on Park Status pill + river plot bg */
    --stroke:#000;
    --title:36px;
    --ts:24px;                     /* timestamps */
    --pill:66px;                   /* Park pill text size (big) */
  }

  html,body{
    margin:0; padding:0;
    background:var(--bg); color:var(--ink);
    font-family:'Roboto', Arial, sans-serif;
    width:1440px; height:2560px;   /* fixed ePaper canvas */
    overflow:hidden;
    -webkit-text-size-adjust:none;
  }

  /* HEADER */
  #header{
    display:flex; align-items:center; gap:14px;
    background:#000; color:#fff; padding:10px 16px;
    position:relative;
  }
  #header img#county-logo{
    width:86px; height:auto; object-fit:contain; display:block;
    margin-left:4px;              /* keeps left edge aligned with cards */
  }
  #header-title{
    flex:1; text-align:center; line-height:1.15;
    font-weight:900; font-size:32px;
    letter-spacing:.2px;
  }
  #header-sub{ font-size:18px; font-weight:700; display:block; }

  .container{
    padding:12px 16px 20px 16px;
    display:flex; flex-direction:column; gap:14px;
    box-sizing:border-box;
  }

  /* CARD FRAME */
  .section{
    border:4px solid #000; border-radius:8px;
    background:var(--card); padding:10px; box-sizing:border-box;
    display:flex; flex-direction:column; position:relative;
  }
  .card-title{
    font-size:var(--title); font-weight:900;
    background:#000; color:#fff; padding:6px 10px;
    margin:-10px -10px 8px -10px; border-radius:6px 6px 0 0;
  }
  .card-timestamp{
    position:absolute; right:12px; bottom:6px;
    font-size:var(--ts);
  }
  .source-note{
    position:absolute; right:12px; bottom:34px;
    font-size:18px; color:#222; font-weight:400;
  }

  /* PARK STATUS */
  #park-status .status-row{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  #park-pill{
    background:var(--gray); color:#000;
    font-weight:900; font-size:var(--pill);
    padding:10px 18px; border-radius:8px;
    display:inline-block;
  }
  #park-next{ font-size:22px; font-weight:700; white-space:nowrap; }
  #park-today{
    text-align:center; margin-top:6px; font-size:22px; font-weight:700;
  }

  /* ALERTS */
  #alert-message{
    text-align:center; font-weight:700; white-space:normal; word-break:break-word;
  }

  /* WEATHER layout */
  #weather-card .content{
    display:flex; gap:18px; align-items:flex-start;
  }
  #wx-left{
    width:32%; min-width:300px; display:flex; align-items:center; gap:12px;
  }
  #weather-icon{ width:110px; height:110px; }
  #wx-temps{ display:flex; flex-direction:column; }
  #temp-F{ font-size:110px; font-weight:900; line-height:.9; }
  #temp-C{ font-size:48px; font-weight:900; }
  #wx-right{
    flex:1; display:grid; grid-template-columns:1fr 1fr; gap:8px 28px;
    align-items:start;
  }
  .wx-line{ font-size:20px; font-weight:400; }
  #weather-forecast{ font-weight:700; } /* keep forecast slightly stronger */
  .wx-label{ font-weight:400; }

  /* RIVER card */
  #river-badges{
    display:flex; gap:10px; justify-content:center; align-items:center; margin:8px 0 6px 0;
    flex-wrap:wrap;
  }
  .badge{
    display:inline-block; padding:6px 10px; font-weight:900; font-size:26px; border-radius:4px;
    background:#fff; color:#000; border:2px solid #000;
  }
  .badge.inv{ background:#000; color:#fff; }
  #river-graph{ background:var(--gray); margin:8px auto 2px auto; width:1120px; }
  #usgs-site{ position:absolute; right:12px; bottom:34px; font-size:18px; }

  #river-stats{
    text-align:center; margin:8px 0 2px 0; font-weight:900; font-size:24px;
  }

  /* FORECAST card */
  #forecast-lines{ text-align:center; font-size:22px; }
  #forecast-lines strong{ font-weight:900; }

  /* AQI */
  #aqi-wrap{ display:flex; flex-direction:column; align-items:center; gap:6px; }
  #aqi-class{ font-weight:900; font-size:28px; }
  #aqi-needle{ margin-top:2px; }
  #aqi-value{ font-weight:900; font-size:24px; }
  #aqi-guidance{ font-size:20px; text-align:center; max-width:1100px; }
  #aqi-breakdown{ font-size:18px; text-align:center; }

  /* HEAT RISK */
  #heat-risk-level{ font-size:36px; font-weight:900; text-align:center; }
  #hydration{ font-size:20px; text-align:center; margin-top:6px; }

  /* SWIM / WATER QUALITY */
  #swim-status{ font-size:44px; font-weight:900; text-align:center; }
  #swim-meta{ text-align:center; font-size:20px; }

  /* FITTER */
  .hidden{ display:none !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="header">
    <img id="county-logo" src="catham-logo.jpg" alt="Chatham County" />
    <div id="header-title">
      US 64 Haw River Access, 348 River Access Rd
      <span id="header-sub"><span id="header-lat">35.730995</span> / <span id="header-lon">-79.107109</span></span>
    </div>
  </div>

  <div class="container">
    <!-- Park Status -->
    <div class="section" id="park-status">
      <div class="card-title">Park Status</div>
      <div class="status-row">
        <div id="park-pill">OPEN / ABIERTO</div>
        <div id="park-next">Next: —</div>
      </div>
      <div id="park-today">Today: —</div>
      <div class="card-timestamp" id="park-ts">Last updated: —</div>
    </div>

    <!-- Alerts -->
    <div class="section" id="alerts-card">
      <div class="card-title">Alerts</div>
      <div id="alert-message">No alerts at this time / Sin alertas en este momento</div>
      <div class="card-timestamp" id="alerts-ts">Last updated: —</div>
    </div>

    <!-- Current Weather -->
    <div class="section" id="weather-card">
      <div class="card-title">Current Weather Conditions</div>
      <div class="content">
        <div id="wx-left">
          <div id="weather-icon"></div>
          <div id="wx-temps">
            <div id="temp-F">--°F</div>
            <div id="temp-C">--°C</div>
          </div>
        </div>
        <div id="wx-right">
          <div class="wx-line"><span class="wx-label">Sunrise:</span> <span id="sunrise">—</span></div>
          <div class="wx-line" id="weather-forecast">—</div>
          <div class="wx-line"><span class="wx-label">Sunset:</span> <span id="sunset">—</span></div>
          <div class="wx-line"><span class="wx-label">Wind:</span> <span id="wind">—</span></div>
          <div class="wx-line"><span class="wx-label">UV Index:</span> <span id="uv">—</span></div>
          <div class="wx-line"><span class="wx-label">Humidity:</span> <span id="humidity">—</span></div>
          <div class="wx-line"><span class="wx-label">Feels like:</span> <span id="feelslike">—</span></div>
          <div class="wx-line"><span class="wx-label">Dew point:</span> <span id="dewpoint">—</span></div>
        </div>
      </div>
      <div class="source-note" id="wx-source">Source: —</div>
      <div class="card-timestamp" id="wx-ts">Last updated: —</div>
    </div>

    <!-- River -->
    <div class="section" id="river-card">
      <div class="card-title">River Water Level & Flow</div>
      <div id="river-badges">
        <span class="badge" id="flood-badge">RIVER BELOW FLOOD STAGE</span>
        <span class="badge inv" id="flow-badge">RIVER FLOW TOO LOW TO PADDLE</span>
      </div>
      <div id="river-graph"></div>
      <div id="river-stats">
        <span id="stage-line"><strong>Stage:</strong> —</span>
        &nbsp;•&nbsp;
        <span id="flow-line"><strong>Discharge:</strong> —</span>
      </div>
      <div id="usgs-site">USGS Site #02096960</div>
      <div class="card-timestamp" id="river-ts">Last updated: —</div>
    </div>

    <!-- Forecast -->
    <div class="section" id="forecast-card">
      <div class="card-title">Forecast</div>
      <div id="forecast-lines">
        <div id="fc1"><strong>—</strong></div>
        <div id="fc2"><strong>—</strong></div>
      </div>
      <div class="card-timestamp" id="fc-ts">Last updated: —</div>
    </div>

    <!-- AQI -->
    <div class="section" id="aqi-card">
      <div class="card-title">Air Quality Index</div>
      <div id="aqi-wrap">
        <div id="aqi-top" style="display:flex; justify-content:space-between; width:1100px; max-width:100%;">
          <div id="aqi-class">—</div>
          <div id="aqi-top-spacer"></div>
          <div id="aqi-top-right">AQI: <span id="aqi-num">—</span></div>
        </div>
        <div id="aqi-needle"></div>
        <div id="aqi-guidance">—</div>
        <div id="aqi-breakdown">—</div>
      </div>
      <div class="source-note" id="aqi-source">Source: —</div>
      <div class="card-timestamp" id="aqi-ts">Last updated: —</div>
    </div>

    <!-- Heat Risk -->
    <div class="section" id="heat-card">
      <div class="card-title">Heat Risk</div>
      <div id="heat-risk-level">—</div>
      <div id="hydration">Keep a water bottle handy and sip often.</div>
      <div class="card-timestamp" id="heat-ts">Last updated: —</div>
    </div>

    <!-- Swim / Water Quality -->
    <div class="section" id="swim-card">
      <div class="card-title">Swim Guide: US&nbsp;64 Access</div>
      <div id="swim-status">—</div>
      <div id="swim-meta">Sampled: — • Via Swim&nbsp;Guide / Haw&nbsp;River Assembly</div>
      <div class="card-timestamp" id="swim-ts">Last updated: —</div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
let LAT = 35.730995, LON = -79.107109;    // header coords; will be shown bold
document.getElementById('header-lat').textContent = LAT.toFixed(6);
document.getElementById('header-lon').textContent = LON.toFixed(6);

const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B';
let TIME_ZONE = 'America/New_York';

/* Park hours — easy to edit */
const PARK_HOURS = {
  // 0=Sun .. 6=Sat
  0:{open:'08:00', close:'19:00'},
  1:{open:'08:00', close:'19:00'},
  2:{open:'08:00', close:'19:00'},
  3:{open:'08:00', close:'19:00'},
  4:{open:'08:00', close:'19:00'},
  5:{open:'08:00', close:'19:00'},
  6:{open:'08:00', close:'19:00'}
};

const FLOW_THRESHOLDS = { too_low_max:200, novice_max:700, expert_max:1600, closed_min:2500 };

/* ====== SMALL UTILS ====== */
const fmtDateTime = (d=new Date()) =>
  new Intl.DateTimeFormat('en-US',{dateStyle:'short', timeStyle:'short', timeZone:TIME_ZONE}).format(d);

const fmtTime = (d) =>
  new Intl.DateTimeFormat('en-US',{hour:'numeric', minute:'numeric', timeZone:TIME_ZONE}).format(d);

function parseWindMph(s){ const m=String(s||'').match(/[\d.]+/); return m?+m[0]:0; }
function fToC(f){return (f-32)*5/9;}
function cToF(c){return c*9/5+32;}
function dewPointF(Tf,RH){
  const T = fToC(Tf), R = Math.max(1e-6, Math.min(100, RH))/100;
  const b=17.62,c=243.12, g=Math.log(R)+(b*T)/(c+T); return Math.round(cToF((c*g)/(b-g)));
}

/* ====== HEADER ICONS ====== */
function iconForForecast(txt=''){
  const t = txt.toLowerCase();
  if (t.includes('snow')) return cloudSnow();
  if (t.includes('rain') || t.includes('showers') || t.includes('thunder')) return cloudRain();
  if (t.includes('cloud')) return cloud();
  if (t.includes('sunny') || t.includes('clear')) return sun();
  return sunCloud();
}
function sun(){
  return `<svg width="110" height="110" viewBox="0 0 64 64"><circle cx="32" cy="32" r="12" fill="black"/><g stroke="black" stroke-width="3"><line x1="32" y1="4" x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="60"/><line x1="4" y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="60" y2="32"/><line x1="12" y1="12" x2="18" y2="18"/><line x1="46" y1="46" x2="52" y2="52"/><line x1="12" y1="52" x2="18" y2="46"/><line x1="46" y1="18" x2="52" y2="12"/></g></svg>`;
}
function cloud(){
  return `<svg width="110" height="110" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;
}
function cloudRain(){
  return `<svg width="110" height="110" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="22" y1="48" x2="22" y2="58"/><line x1="32" y1="48" x2="32" y2="58"/><line x1="42" y1="48" x2="42" y2="58"/></g></svg>`;
}
function sunCloud(){ return `<svg width="110" height="110" viewBox="0 0 64 64"><circle cx="22" cy="22" r="10" fill="black"/><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/></svg>`;}
function cloudSnow(){ return `<svg width="110" height="110" viewBox="0 0 64 64"><path d="M20,40a12,12 0 0,1 24,0h8a8,8 0 0,0 0-16 10,10 0 0,0-19-4 12,12 0 0,0-19,4 8,8 0 0,0 0,16z" fill="black" stroke="black" stroke-width="3"/><g stroke="black" stroke-width="3"><line x1="32" y1="48" x2="32" y2="60"/><line x1="26" y1="54" x2="38" y2="54"/></g></svg>`;}

/* ====== PARK STATUS ====== */
function parseHM(s){ const [h,m]=s.split(':').map(Number); return {h,m}; }
function setParkCard(){
  const now = new Date();
  const dow = now.getDay();
  const tz = TIME_ZONE;

  function hmToDate(hm, dayOffset=0){
    const d=new Date(now); d.setDate(d.getDate()+dayOffset);
    d.setHours(hm.h, hm.m, 0, 0);
    return d;
  }

  const today = PARK_HOURS[dow];
  const openT = hmToDate(parseHM(today.open));
  const closeT = hmToDate(parseHM(today.close));

  let isOpen = now>=openT && now<closeT;

  // Build NEXT and TODAY text
  const todayTxt = `${formatHM(today.open)} — ${formatHM(today.close)}`;
  const pill = document.getElementById('park-pill');
  const next = document.getElementById('park-next');
  const todayLine = document.getElementById('park-today');

  pill.textContent = isOpen ? 'OPEN / ABIERTO' : 'CLOSED / CERRADO';
  todayLine.textContent = `Today: ${todayTxt}`;

  let nextWhen, label;
  if (isOpen){
    nextWhen = closeT; label = 'Closes';
  } else {
    // next opening time (could be later today or tomorrow)
    let target = openT;
    if (now >= closeT) { // tomorrow
      const nd = (dow+1)%7, hm = parseHM(PARK_HOURS[nd].open);
      target = hmToDate(hm, 1);
    } else if (now < openT) {
      target = openT;
    }
    nextWhen = target; label = 'Opens';
  }
  const mins = Math.max(0, Math.round((nextWhen - now)/60000));
  const hr = Math.floor(mins/60), rem = mins%60;
  next.textContent = `Next: ${label} at ${fmtTime(nextWhen)} (${hr>0?`${hr}h `:''}${rem}m left)`;

  document.getElementById('park-ts').textContent = 'Last updated: '+fmtDateTime(now);

  function formatHM(s){
    const d=new Date(); const {h,m}=parseHM(s); d.setHours(h,m,0,0); return fmtTime(d);
  }
}

/* ====== WEATHER (NWS + Open-Meteo UV fallback) ====== */
async function fetchWeather(){
  const now=new Date();
  document.getElementById('wx-ts').textContent='Last updated: '+fmtDateTime(now);

  const pt = await fetch(`https://api.weather.gov/points/${LAT},${LON}`).then(r=>r.json());
  const hourly = pt.properties.forecastHourly;
  const grid = pt.properties.forecast;
  const zone = pt.properties.forecastZone;

  // Observations from hourly forecast (NWS style periods)
  const obs = await fetch(hourly).then(r=>r.json()).catch(()=>null);
  if (obs?.properties?.periods?.length){
    const p = obs.properties.periods[0];
    const TF = Number(p.temperature);
    const RH = Number(p.relativeHumidity?.value);
    const W = p.windSpeed || '—';
    document.getElementById('temp-F').textContent = `${Math.round(TF)}°F`;
    document.getElementById('temp-C').textContent = `${Math.round(fToC(TF))}°C`;
    document.getElementById('weather-icon').innerHTML = iconForForecast(p.shortForecast||'');
    document.getElementById('weather-forecast').textContent = p.shortForecast||'—';
    document.getElementById('wind').textContent = W;
    document.getElementById('humidity').textContent = Number.isFinite(RH)? `${Math.round(RH)}%`:'—';
    if (Number.isFinite(TF) && Number.isFinite(RH)){
      document.getElementById('feelslike').textContent = Math.round(TF >= 80 ? (0.5*(TF+61.0+(TF-68.0)*1.2+(parseWindMph(W))*0.094)) : TF);
      document.getElementById('dewpoint').textContent = dewPointF(TF, RH) + '°F';
    } else {
      document.getElementById('feelslike').textContent = '—';
      document.getElementById('dewpoint').textContent = '—';
    }
  }

  // Grid forecast (day/night)
  const fc = await fetch(grid).then(r=>r.json()).catch(()=>null);
  if (fc?.properties?.periods?.length){
    const p0 = fc.properties.periods[0], p1=fc.properties.periods[1];
    document.getElementById('fc1').innerHTML = `<strong>${p0?.name||'—'}: ${p0?.shortForecast||'—'}</strong>`;
    document.getElementById('fc2').innerHTML = `<strong>${p1?.name||'—'}: ${p1?.shortForecast||'—'}</strong>`;
  }

  // Sunrise/Sunset
  const ss = await fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`).then(r=>r.json()).catch(()=>null);
  if (ss?.status==='OK'){
    document.getElementById('sunrise').textContent = fmtTime(new Date(ss.results.sunrise));
    document.getElementById('sunset').textContent  = fmtTime(new Date(ss.results.sunset));
  } else {
    document.getElementById('sunrise').textContent = '—';
    document.getElementById('sunset').textContent = '—';
  }

  // UV index (Open-Meteo fallback)
  try{
    const om = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=uv_index&timezone=auto&_=${Date.now()}`).then(r=>r.json());
    const times = om?.hourly?.time||[], uvs=om?.hourly?.uv_index||[];
    if (times.length && uvs.length){
      const nowMs=Date.now();
      let idx=0; for(let i=0;i<times.length;i++){ if (new Date(times[i]).getTime()<=nowMs) idx=i; }
      document.getElementById('uv').textContent = Math.round(uvs[idx]);
    } else {
      document.getElementById('uv').textContent = '—';
    }
  }catch{ document.getElementById('uv').textContent='—'; }

  // Alerts (centered)
  if (zone){
    const z = zone.split('/').pop();
    try{
      const alerts = await fetch(`https://api.weather.gov/alerts/active/zone/${z}`).then(r=>r.json());
      const txt = (alerts?.features?.length)
        ? alerts.features.map(a=>a.properties.headline).join(' • ')
        : 'No alerts at this time / Sin alertas en este momento';
      document.getElementById('alert-message').textContent = txt;
    }catch{
      document.getElementById('alert-message').textContent = '—';
    }
  }
  document.getElementById('wx-source').textContent = `Source: NWS + Open-Meteo (${LAT.toFixed(3)}, ${LON.toFixed(3)})`;
}

/* ====== RIVER (USGS) ====== */
function groupBy3h(arr){
  const map={};
  arr.forEach(v=>{
    const t=new Date(v.dateTime), b=Math.floor(t.getHours()/3)*3;
    const d=new Date(t.getFullYear(), t.getMonth(), t.getDate(), b, 0, 0, 0);
    const k=d.toISOString();
    map[k]||(map[k]={d,sum:0,c:0}); map[k].sum+=v.stage; map[k].c++;
  });
  return Object.values(map).map(o=>({date:o.d, stage:o.sum/o.c})).sort((a,b)=>a.date-b.date);
}

async function fetchRiver(){
  const end=new Date(); const start=new Date(); start.setDate(end.getDate()-4);
  const fmt = d=>d.toISOString().split('.')[0];
  const url=`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=02096960&parameterCd=00065,00060&startDT=${fmt(start)}&endDT=${fmt(end)}&siteStatus=all`;

  try{
    const data = await fetch(url).then(r=>r.json());
    const ts = data?.value?.timeSeries||[];
    const S = ts.find(s=>s.variable?.variableCode?.[0]?.value==='00065');
    const Q = ts.find(s=>s.variable?.variableCode?.[0]?.value==='00060');

    const floodProp = (S?.sourceInfo?.siteProperty||Q?.sourceInfo?.siteProperty||[]).find(p=>p.propertyName==='floodStage');
    const floodStage = floodProp ? parseFloat(floodProp.value) : 6;

    const stage = (S?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, stage:+v.value})).filter(v=>Number.isFinite(v.stage));
    const flow  = (Q?.values?.[0]?.value||[]).map(v=>({dateTime:v.dateTime, flow:+v.value})).filter(v=>Number.isFinite(v.flow));

    // latest
    const lastStage = stage.length ? stage[stage.length-1].stage : NaN;
    const lastFlow  = flow.length  ? flow[flow.length-1].flow : NaN;

    // badges
    document.getElementById('flood-badge').textContent =
      (Number.isFinite(lastStage) && lastStage >= floodStage) ? 'FLOOD LEVELS UNSAFE' : 'RIVER BELOW FLOOD STAGE';

    const fb = (function(cfs,s,fs){
      if (Number.isFinite(s) && s>=fs) return {label:'ACCESS CLOSED — STAY OFF RIVER', inv:true};
      if (!Number.isFinite(cfs)) return {label:'—', inv:false};
      const t=FLOW_THRESHOLDS;
      if (cfs < t.too_low_max) return {label:'RIVER FLOW TOO LOW TO PADDLE', inv:true};
      if (cfs <= t.novice_max) return {label:'LOW–MODERATE FLOW — NOVICE OK', inv:true};
      if (cfs <= t.expert_max) return {label:'MODERATE–HIGH FLOW — EXPERT ONLY', inv:true};
      return {label:'UNSAFE FLOW — ACCESS CLOSED', inv:true};
    })(lastFlow,lastStage,floodStage);

    const flowBadge=document.getElementById('flow-badge');
    flowBadge.textContent=fb.label;
    flowBadge.className = 'badge'+(fb.inv?' inv':'');

    // stats
    document.getElementById('stage-line').innerHTML = `<strong>Stage:</strong> ${Number.isFinite(lastStage)?lastStage.toFixed(2)+' ft':'—'}`;
    document.getElementById('flow-line').innerHTML  = `<strong>Discharge:</strong> ${Number.isFinite(lastFlow)?Math.round(lastFlow)+' cfs':'—'}`;

    // graph
    renderRiverGraph(groupBy3h(stage), floodStage, Number.isFinite(lastStage)?`${lastStage.toFixed(2)} ft`:'—');
  }catch{
    document.getElementById('river-graph').innerHTML='';
    document.getElementById('stage-line').innerHTML = '<strong>Stage:</strong> —';
    document.getElementById('flow-line').innerHTML  = '<strong>Discharge:</strong> —';
  }
  document.getElementById('river-ts').textContent='Last updated: '+fmtDateTime();
}
function renderRiverGraph(points, floodStage, lastStr){
  const wrap=document.getElementById('river-graph'); wrap.innerHTML='';
  if (!points?.length) return;

  let min=Math.min(...points.map(p=>p.stage), floodStage), max=Math.max(...points.map(p=>p.stage), floodStage);
  const svgW=1120, svgH=260, offX=70, offY=28, gh=180, gw=svgW-offX-20;
  const minD=points[0].date, maxD=points[points.length-1].date, range=maxD-minD;

  const NS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('width',svgW); svg.setAttribute('height',svgH); svg.setAttribute('viewBox',`0 0 ${svgW} ${svgH}`);

  const scaleX = d => offX + ((d-minD)/range)*gw;
  const scaleY = s => offY + gh - ((s-min)/(max-min||1))*gh;

  // flood line
  const fl=document.createElementNS(NS,'line');
  fl.setAttribute('x1', offX); fl.setAttribute('x2', offX+gw);
  fl.setAttribute('y1', scaleY(floodStage)); fl.setAttribute('y2', scaleY(floodStage));
  fl.setAttribute('stroke','#000'); fl.setAttribute('stroke-dasharray','6,3'); fl.setAttribute('stroke-width','3');
  svg.appendChild(fl);

  const lab=document.createElementNS(NS,'text');
  lab.setAttribute('x', offX+gw-4); lab.setAttribute('y', scaleY(floodStage)-6);
  lab.setAttribute('font-size','22'); lab.setAttribute('font-weight','900'); lab.setAttribute('text-anchor','end');
  lab.textContent='Flood Stage'; svg.appendChild(lab);

  // path
  const pathD = points.map((p,i)=> (i?'L':'M')+scaleX(p.date)+','+scaleY(p.stage)).join(' ');
  const path=document.createElementNS(NS,'path'); path.setAttribute('d',pathD);
  path.setAttribute('stroke','#000'); path.setAttribute('stroke-width','5'); path.setAttribute('fill','none');
  svg.appendChild(path);

  // last reading tag
  const last=points[points.length-1]; const lx=scaleX(last.date), ly=scaleY(last.stage);
  const tag=document.createElementNS(NS,'text');
  tag.setAttribute('x', lx+60); tag.setAttribute('y', ly+12);
  tag.setAttribute('font-size','22'); tag.setAttribute('font-weight','900'); tag.setAttribute('fill','#000');
  tag.textContent=lastStr; svg.appendChild(tag);

  wrap.appendChild(svg);
}

/* ====== AQI (AirNow -> Open-Meteo fallback) ====== */
function aqiCat(n){
  if (n<=50) return 'GOOD';
  if (n<=100) return 'MODERATE';
  if (n<=150) return 'UNHEALTHY FOR SENSITIVE GROUPS';
  if (n<=200) return 'UNHEALTHY';
  if (n<=300) return 'VERY UNHEALTHY';
  return 'HAZARDOUS';
}
function aqiGuidance(cat){
  const c=cat.toLowerCase();
  if (c==='good') return 'Air quality is satisfactory; great for outdoor activities.';
  if (c==='moderate') return 'Okay for most; unusually sensitive people may shorten outdoor exertion.';
  if (c.includes('sensitive')) return 'Sensitive groups should reduce prolonged or heavy outdoor exertion.';
  if (c==='unhealthy') return 'Everyone may feel effects; sensitive groups should avoid prolonged exertion.';
  if (c.includes('very')) return 'Health alert: consider limiting outdoor activity; sensitive groups should avoid it.';
  return 'Emergency conditions: everyone should avoid all outdoor exertion.';
}
function renderAQINeedle(aqi){
  // Clean, robust half-arc + needle (no masks/fills)
  const W=520,H=240,CX=W/2,CY=210,R=190;
  const NS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('width',W); svg.setAttribute('height',H); svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

  const arc=document.createElementNS(NS,'path');
  arc.setAttribute('d', describeArc(CX,CY,R,180,0));
  arc.setAttribute('fill','none'); arc.setAttribute('stroke','#000'); arc.setAttribute('stroke-width','8');
  svg.appendChild(arc);

  // needle
  const ang = 180 - Math.max(0, Math.min(300, aqi))/300*180; // deg
  const rad = ang*Math.PI/180;
  const x2 = CX + (R-40)*Math.cos(rad), y2 = CY + -(R-40)*Math.sin(rad);
  const line=document.createElementNS(NS,'line');
  line.setAttribute('x1',CX); line.setAttribute('y1',CY);
  line.setAttribute('x2',x2); line.setAttribute('y2',y2);
  line.setAttribute('stroke','#000'); line.setAttribute('stroke-width','10'); line.setAttribute('stroke-linecap','round');
  svg.appendChild(line);

  return svg;

  // helpers
  function describeArc(x,y,r,start,end){
    const s = polarToCartesian(x,y,r,end), e=polarToCartesian(x,y,r,start);
    const large = end-start<=180?0:1;
    return `M ${s.x} ${s.y} A ${r} ${r} 0 ${large} 0 ${e.x} ${e.y}`;
  }
  function polarToCartesian(x,y,r,deg){
    const rad=(deg-90)*Math.PI/180;
    return {x:x+r*Math.cos(rad), y:y+r*Math.sin(rad)};
  }
}

async function fetchAQI(){
  const topClass = document.getElementById('aqi-class');
  const topRight = document.getElementById('aqi-top-right');
  const wrap = document.getElementById('aqi-needle');
  const guidance = document.getElementById('aqi-guidance');
  const br = document.getElementById('aqi-breakdown');
  const src = document.getElementById('aqi-source');

  function setAll(aqi,cat,breakdown,source,asOf){
    topClass.textContent = cat;
    document.getElementById('aqi-num').textContent = aqi;
    topRight.textContent = `AQI: ${aqi}`;
    wrap.innerHTML=''; wrap.appendChild(renderAQINeedle(aqi));
    guidance.textContent = aqiGuidance(cat);
    br.textContent = breakdown || '—';
    src.textContent = `Source: ${source} • As of ${fmtDateTime(asOf?new Date(asOf):new Date())}`;
    document.getElementById('aqi-ts').textContent='Last updated: '+fmtDateTime();
  }

  // Try AirNow (may 403/empty w/o proper CORS); if fails, fallback to Open-Meteo
  try{
    const url=`https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}&_=${Date.now()}`;
    const r=await fetch(url,{mode:'cors', cache:'no-store', headers:{'Accept':'application/json'}});
    if (!r.ok) throw new Error('AirNow http '+r.status);
    const data=await r.json();
    const rows=Array.isArray(data)?data.filter(x=>Number.isFinite(+x.AQI)):[];
    if (!rows.length) throw new Error('AirNow empty');

    const PREFER=['PM2.5','O3','PM10'];
    rows.sort((a,b)=>{
      const ai=PREFER.indexOf(a.ParameterName), bi=PREFER.indexOf(b.ParameterName);
      const ap=ai===-1?99:ai, bp=bi===-1?99:bi;
      return ap-bp || (+b.AQI)-(+a.AQI);
    });
    const best=rows[0], aqi=Math.round(+best.AQI), cat=best?.Category?.Name||aqiCat(aqi);
    const mix = Object.fromEntries(rows.map(r=>[r.ParameterName, Math.round(+r.AQI)]));
    const breakdown=[
      mix['PM2.5']!=null?`PM2.5 ${mix['PM2.5']}`:null,
      mix['PM10']!=null?`PM10 ${mix['PM10']}`:null,
      mix['O3']!=null?`O₃ ${mix['O3']}`:null
    ].filter(Boolean).join(' • ');

    setAll(aqi,cat,breakdown,`AirNow (${best.ReportingArea||'—'})`, new Date());
  }catch(e){
    console.warn('AirNow failed, falling back →', e);
    try{
      const om = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=us_aqi,pm2_5,pm10,ozone&timezone=auto&_=${Date.now()}`).then(r=>r.json());
      const t=om?.hourly?.time||[], a=om?.hourly?.us_aqi||[];
      if (!t.length||!a.length) throw new Error('Open-Meteo missing');
      let idx=t.length-1, now=Date.now();
      for(let i=t.length-1;i>=0;i--){ if (new Date(t[i]).getTime()<=now){ idx=i; break; } }
      const aqi=Math.round(+a[idx]), cat=aqiCat(aqi);
      const fmt=n=>Number.isFinite(+n)?Math.round(+n):'—';
      const br=`PM2.5 ${fmt(om.hourly.pm2_5?.[idx])} µg/m³ • PM10 ${fmt(om.hourly.pm10?.[idx])} µg/m³ • O₃ ${fmt(om.hourly.ozone?.[idx])} µg/m³`;
      setAll(aqi,cat,br,'Open-Meteo (US AQI)', t[idx]);
    }catch{
      topClass.textContent='—'; document.getElementById('aqi-num').textContent='—';
      wrap.innerHTML=''; guidance.textContent='—'; br.textContent='—';
      src.textContent='Source: —'; document.getElementById('aqi-ts').textContent='Last updated: '+fmtDateTime();
    }
  }
}

/* ====== HEAT RISK (simple messaging from temp) ====== */
function setHeatRisk(){
  const t = document.getElementById('temp-F').textContent;
  const n = parseFloat(t);
  const el=document.getElementById('heat-risk-level');
  if (Number.isFinite(n) && n>=90) el.textContent='High heat risk / Riesgo alto';
  else if (Number.isFinite(n) && n>=80) el.textContent='Moderate heat risk / Riesgo moderado';
  else el.textContent='Minimal heat risk / Riesgo mínimo';
  document.getElementById('heat-ts').textContent='Last updated: '+fmtDateTime();
}

/* ====== SWIM / WATER QUALITY (placeholder; edit easily) ====== */
function setSwim(){
  // You can wire this to your data later. This keeps the card present.
  document.getElementById('swim-status').textContent='✔ SAFE TO SWIM';
  document.getElementById('swim-meta').textContent='Sampled: — • Via Swim Guide / Haw River Assembly';
  document.getElementById('swim-ts').textContent='Last updated: '+fmtDateTime();
}

/* ====== FITTER (hide lowest-priority cards until 1440×2560 fits) ====== */
const VIEW_W=1440, VIEW_H=2560;
const PRIORITY = [
  'park-status',      // 0   (keep)
  'alerts-card',      // 1   (keep)
  'weather-card',     // 2   (keep)
  'river-card',       // 3
  'forecast-card',    // 4
  'aqi-card',         // 5
  'heat-card',        // 6
  'swim-card'         // 7
];
const KEEP_FIRST=3;

function outerHeight(el){
  const cs=getComputedStyle(el);
  return el.getBoundingClientRect().height + (parseFloat(cs.marginTop)||0) + (parseFloat(cs.marginBottom)||0);
}
function fitCards(){
  const header=document.getElementById('header');
  const cont=document.querySelector('.container');
  const cards=[...cont.querySelectorAll('.section')];
  // show all, measure, then hide as needed
  cards.forEach(c=>c.classList.remove('hidden'));
  function usedHeight(){
    const gap=parseFloat(getComputedStyle(cont).rowGap||getComputedStyle(cont).gap)||0;
    let sum=header.getBoundingClientRect().height + gap;
    const vis=cards.filter(c=>!c.classList.contains('hidden'));
    vis.forEach((c,i)=>{ sum+=outerHeight(c); if (i>0) sum+=gap; });
    return sum;
  }
  while (usedHeight()>VIEW_H){
    const candidates = cards.filter(c=>!c.classList.contains('hidden'))
      .filter(c=>PRIORITY.indexOf(c.id)>=KEEP_FIRST)
      .sort((a,b)=>PRIORITY.indexOf(b.id)-PRIORITY.indexOf(a.id));
    if (!candidates.length) break;
    candidates[0].classList.add('hidden');
  }
}

/* ====== MASTER ====== */
async function refreshAll(){
  setParkCard();
  await fetchWeather();
  await fetchRiver();
  await fetchAQI();
  setHeatRisk();
  setSwim();
  // Timestamps on Alerts/Forecast are set when sections load; add/refresh if missing:
  document.getElementById('alerts-ts').textContent='Last updated: '+fmtDateTime();
  document.getElementById('fc-ts').textContent='Last updated: '+fmtDateTime();
  fitCards();
}

window.onload = () => {
  refreshAll();
  // periodic refresh (safe; ePaper may reload the page anyway)
  setInterval(refreshAll, 10*60*1000);
  // refit after fonts settle
  if (document.fonts && document.fonts.ready){ document.fonts.ready.then(()=>setTimeout(fitCards,0)); }
};
</script>
</body>
</html>
