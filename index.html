<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1440, initial-scale=1.0">
  <title>Environmental Snapshot</title>
  <style>
    body {
      background-color: #ffffff;
      color: #000000;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      width: 1440px;
      height: 2560px;
      -webkit-text-size-adjust: none;
    }
    .container {
      padding: 32px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 28px;
    }
    .group-label {
      font-size: 36px;
      font-weight: bold;
      border-bottom: 2px solid black;
      margin-top: 20px;
      padding-bottom: 6px;
    }
    .section {
      border: 2px solid #000;
      padding: 16px;
      border-radius: 8px;
      background-color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section h2 {
      margin-top: 0;
      font-size: 48px;
      background-color: #000;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      flex: 1;
    }
    .section-content {
      flex: 2;
      padding-left: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: right;
    }
    .value {
      font-size: 100px;
      font-weight: bold;
      margin: 10px 0;
    }
    .label {
      font-size: 32px;
      color: #444;
    }
    .timestamp {
      font-size: 28px;
      color: #222;
      margin-top: 40px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div style="background-color: black; color: white; padding: 20px; text-align: center; font-size: 48px; font-weight: bold;">
    Chatham County
  </div>
  <div class="container">
    <div class="section" style="position: relative; flex-direction: column; align-items: stretch;">
      <div style="position: absolute; top: 16px; left: 16px; font-size: 36px; font-weight: bold;">River & Water Levels</div>
      <div style="margin-top: 56px; padding-left: 16px; padding-right: 16px; display: flex; flex-direction: column; align-items: flex-end;">
        <div class="value" style="text-align: right;">4.9 ft</div>
        <div class="label" style="font-size: 20px; color: #666; text-align: right;">USGS Site #02096960 (Live)</div>
        <div class="label" style="text-align: right;">AT OR ABOVE FLOOD STAGE</div>
      </div>
      <div id="river-graph" style="align-self: flex-start; margin-top: 12px; width: 100%; max-width: 100%; display: flex; justify-content: flex-start;"></div>
    </div>

    <div class="section" id="alerts-section">
      <div style="font-size: 36px; font-weight: bold;">Alerts</div>
      <div class="section-content">
        <div class="label" id="alert-message">No alerts at this time.</div>
      </div>
    </div>

    <div class="section" id="weather-section">
      <div style="font-size: 36px; font-weight: bold;">Weather Conditions</div>
      <div class="section-content">
        <div class="value" id="weather-temp">--</div>
        <div class="label" id="weather-forecast">--</div>
        <div class="label" id="weather-wind">--</div>
        <div class="label" id="weather-humidity">--</div>
      </div>
    </div>

    <div class="section" id="rainfall-forecast">
      <div style="font-size: 36px; font-weight: bold;">Rainfall Forecast</div>
      <div class="section-content">
        <div class="label" id="rainfall-forecast-1">--</div>
        <div class="label" id="rainfall-forecast-2">--</div>
        <div class="label" id="rainfall-forecast-3">--</div>
      </div>
    </div>

    <div class="section" id="precipitation-section">
      <div style="font-size: 36px; font-weight: bold;">Precipitation (24h)</div>
      <div class="section-content">
        <div class="value" id="precip-value">--</div>
        <div class="label">Last 24 Hours</div>
      </div>
    </div>

    <div class="section" id="aqi-section">
      <div style="font-size: 36px; font-weight: bold;">Air Quality Index</div>
      <div class="section-content">
        <div class="value" id="aqi-value">--</div>
        <div class="label" id="aqi-category">Loading...</div>
        <div class="label" id="aqi-pollutant">Primary Pollutant: --</div>
      </div>
    </div>

    <div class="timestamp" style="font-size: 24px; text-align: center; margin-top: 20px;">
      Last updated:<br>
      AQI: <span id="last-aqi-update">Loading...</span> |
      Weather & Forecast: <span id="last-nws-update">Loading...</span> |
      River: <span id="last-river-update">Loading...</span>
    </div>
    <div class="timestamp" style="font-size: 24px; text-align: center; margin-top: 10px;">
      For more information, visit <a href="https://www.chathamcountync.gov/" target="_blank">chathamcountync.gov</a>
    </div>
  </div>

  <script>
    const AIRNOW_API_KEY = '26158E56-5836-46D3-B819-92969016332B';
    const LAT = 35.77659;
    const LON = -79.14597;

    function setAQIContent(aqi, category, pollutant) {
      document.getElementById('last-aqi-update').textContent = new Date().toLocaleString(undefined, {dateStyle: 'medium', timeStyle: 'short'});
      document.getElementById('aqi-value').textContent = (aqi != null && !isNaN(aqi)) ? aqi : '--';
      document.getElementById('aqi-category').textContent = category || 'N/A';
      document.getElementById('aqi-pollutant').textContent = `Primary Pollutant: ${pollutant || 'N/A'}`;
    }

    function fetchAQIData() {
      const url = `https://www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=${LAT}&longitude=${LON}&distance=50&API_KEY=${AIRNOW_API_KEY}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data && data.length > 0) {
            const main = data[0];
            setAQIContent(main.AQI, main.Category.Name, main.ParameterName);
          } else {
            setAQIContent(42, 'Good', 'PM2.5');
          }
        })
        .catch(() => setAQIContent(42, 'Good', 'PM2.5'));
    }

    function fetchNWSData() {
      document.getElementById('last-nws-update').textContent = new Date().toLocaleString(undefined, {dateStyle: 'medium', timeStyle: 'short'});
      const pointUrl = `https://api.weather.gov/points/${LAT},${LON}`;

      fetch(pointUrl)
        .then(res => res.json())
        .then(pointData => {
          const gridUrl = pointData.properties.forecast;
          const obsUrl = pointData.properties.forecastHourly;
          const alertUrl = pointData.properties.forecastZone;

          // Weather Summary
          fetch(obsUrl)
            .then(res => res.json())
            .then(obs => {
              const now = obs.properties.periods[0];
              document.getElementById('weather-temp').textContent = `${now.temperature ?? '--'}Â°F`;
              document.getElementById('weather-forecast').textContent = now.shortForecast ?? 'N/A';
              document.getElementById('weather-wind').textContent = `Wind: ${now.windSpeed ?? '--'}`;
              document.getElementById('weather-humidity').textContent = `Humidity: ${now.relativeHumidity?.value ?? '--'}%`;

              const precipVal = now.quantitativePrecipitation?.value;
              if (precipVal != null && !isNaN(precipVal)) {
                document.getElementById('precip-value').textContent = `${precipVal.toFixed(2)} in`;
              }
            });

          // Rainfall Forecast
          fetch(gridUrl)
            .then(res => res.json())
            .then(grid => {
              const days = grid.properties.periods.slice(0, 3);
              document.getElementById('rainfall-forecast-1').textContent = `${days[0]?.name}: ${days[0]?.shortForecast ?? 'N/A'}`;
              document.getElementById('rainfall-forecast-2').textContent = `${days[1]?.name}: ${days[1]?.shortForecast ?? 'N/A'}`;
              document.getElementById('rainfall-forecast-3').textContent = `${days[2]?.name}: ${days[2]?.shortForecast ?? 'N/A'}`;
            });

          // Alerts
          fetch(`https://api.weather.gov/alerts/active/zone/${alertUrl.split('/').pop()}`)
            .then(res => res.json())
            .then(data => {
              const alertBox = document.getElementById('alert-message');
              if (data.features.length === 0) {
                alertBox.textContent = 'No alerts at this time.';
              } else {
                alertBox.textContent = data.features.map(a => a.properties.headline).join(' | ');
              }
            });
        })
        .catch(err => console.error('Error fetching NWS data:', err));
    }

    fetchAQIData();
    fetchNWSData();

    setInterval(() => {
      fetchAQIData();
      fetchNWSData();
    }, 10 * 60 * 1000); // Refresh every 10 minutes
  </script>
</body>
</html>
